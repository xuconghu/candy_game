<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≥ñÊûúÊ∏∏Êàè</title>
    <!-- APIÂÆ¢Êà∑Á´Ø -->
    <script src="js/api-client.js"></script>
    <style>
        @font-face {
            font-family: 'SentyWatermelon';
            src: url('SentyWatermelon.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            padding: 0;
            background: url('image/background.png') center center / cover no-repeat;
            font-family: 'SentyWatermelon', 'Comic Sans MS', cursive, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .game-container {
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            margin: 10px;
            align-items: center;
            justify-content: flex-start;
            padding-top: 100px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            background: transparent;
            padding: 20px;
            max-width: 1000px;
            width: 100%;
            aspect-ratio: 8/5;
            max-height: 560px;
        }

        .candy {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .candy:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .candy.selected {
            border: 3px solid #FFD700;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .candy.red { background-image: url('image/red.png'); }
        .candy.blue { background-image: url('image/blue.png'); }
        .candy.yellow { background-image: url('image/yellow.png'); }
        .candy.pink { background-image: url('image/pink.png'); }
        .candy.light_green { background-image: url('image/light_green.png'); }
        .candy.deep_green { background-image: url('image/deep_green.png'); }

        .score-board {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .score, .moves, .timer {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .game-over h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .game-over p {
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .login-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .login-panel input {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 150px;
        }

        .login-panel button {
            background: #4ECDC4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
        }

        .user-info {
            color: #333;
            font-weight: bold;
        }

        .leaderboard {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            max-width: 250px;
        }

        .leaderboard h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
            font-size: 14px;
        }

        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #FF6B6B;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
                padding-top: 50px;
            }
            
            .game-grid {
                padding: 10px;
                gap: 4px;
            }
            
            .score-board {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .login-panel, .leaderboard {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                margin: 10px;
                width: calc(100% - 40px);
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- ÁôªÂΩïÈù¢Êùø -->
    <div class="login-panel" id="loginPanel">
        <div id="loginForm">
            <input type="text" id="usernameInput" placeholder="Áî®Êà∑Âêç" maxlength="20">
            <br>
            <button onclick="login()">ÁôªÂΩï</button>
            <button onclick="register()">Ê≥®ÂÜå</button>
        </div>
        <div id="userInfo" style="display: none;">
            <div class="user-info">
                <span id="currentUser"></span>
                <button onclick="logout()">ÈÄÄÂá∫</button>
            </div>
        </div>
    </div>

    <!-- ÊéíË°åÊ¶ú -->
    <div class="leaderboard">
        <h3>üèÜ ÊéíË°åÊ¶ú</h3>
        <div id="leaderboardList">
            <div class="leaderboard-item">
                <span>Âä†ËΩΩ‰∏≠...</span>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèÂÆπÂô® -->
    <div class="game-container">
        <!-- ËÆ°ÂàÜÊùø -->
        <div class="score-board">
            <div class="score">ÂæóÂàÜ: <span id="score">0</span></div>
            <div class="moves">Ââ©‰ΩôÊ≠•Êï∞: <span id="moves">30</span></div>
            <div class="timer">Êó∂Èó¥: <span id="timer">00:00</span></div>
        </div>

        <!-- Ê∏∏ÊàèÁΩëÊ†º -->
        <div class="game-grid" id="gameGrid"></div>
    </div>

    <!-- Ê∏∏ÊàèÁªìÊùüÂºπÁ™ó -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 id="gameOverTitle">Ê∏∏ÊàèÁªìÊùü</h2>
            <p id="gameOverMessage">‰Ω†ÁöÑÂæóÂàÜ: <span id="finalScore">0</span></p>
            <button class="btn" onclick="restartGame()">ÈáçÊñ∞ÂºÄÂßã</button>
            <button class="btn" onclick="closeGameOver()">ÁªßÁª≠Ê∏∏Êàè</button>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÂêéÂè∞ÈìæÊé• -->
    <a href="admin-dashboard.html" class="admin-link">ÁÆ°ÁêÜÂêéÂè∞</a>

    <script>
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            grid: [],
            score: 0,
            moves: 30,
            selectedCandy: null,
            gameStartTime: null,
            gameTimer: null,
            currentUser: null
        };

        // Á≥ñÊûúÁ±ªÂûã
        const candyTypes = ['red', 'blue', 'yellow', 'pink', 'light_green', 'deep_green'];

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            createGrid();
            updateDisplay();
            startTimer();
            loadLeaderboard();
        }

        // ÂàõÂª∫Ê∏∏ÊàèÁΩëÊ†º
        function createGrid() {
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = '';
            gameState.grid = [];

            for (let row = 0; row < 5; row++) {
                gameState.grid[row] = [];
                for (let col = 0; col < 8; col++) {
                    const candy = document.createElement('div');
                    candy.className = 'candy';
                    candy.dataset.row = row;
                    candy.dataset.col = col;
                    candy.addEventListener('click', () => selectCandy(row, col));
                    
                    const candyType = getRandomCandyType();
                    candy.classList.add(candyType);
                    gameState.grid[row][col] = {
                        type: candyType,
                        element: candy
                    };
                    
                    grid.appendChild(candy);
                }
            }
        }

        // Ëé∑ÂèñÈöèÊú∫Á≥ñÊûúÁ±ªÂûã
        function getRandomCandyType() {
            return candyTypes[Math.floor(Math.random() * candyTypes.length)];
        }

        // ÈÄâÊã©Á≥ñÊûú
        function selectCandy(row, col) {
            if (gameState.moves <= 0) return;

            const candy = gameState.grid[row][col];
            
            if (gameState.selectedCandy) {
                // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫Ü‰∏Ä‰∏™Á≥ñÊûúÔºåÂ∞ùËØï‰∫§Êç¢
                const selected = gameState.selectedCandy;
                
                if (isAdjacent(selected.row, selected.col, row, col)) {
                    swapCandies(selected.row, selected.col, row, col);
                    clearSelection();
                    gameState.moves--;
                    updateDisplay();
                    
                    setTimeout(() => {
                        checkMatches();
                    }, 300);
                } else {
                    // ÈÄâÊã©Êñ∞ÁöÑÁ≥ñÊûú
                    clearSelection();
                    selectNewCandy(row, col);
                }
            } else {
                // ÈÄâÊã©Á¨¨‰∏Ä‰∏™Á≥ñÊûú
                selectNewCandy(row, col);
            }
        }

        // ÈÄâÊã©Êñ∞Á≥ñÊûú
        function selectNewCandy(row, col) {
            gameState.selectedCandy = { row, col };
            gameState.grid[row][col].element.classList.add('selected');
        }

        // Ê∏ÖÈô§ÈÄâÊã©
        function clearSelection() {
            if (gameState.selectedCandy) {
                const { row, col } = gameState.selectedCandy;
                gameState.grid[row][col].element.classList.remove('selected');
                gameState.selectedCandy = null;
            }
        }

        // Ê£ÄÊü•ÊòØÂê¶Áõ∏ÈÇª
        function isAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }

        // ‰∫§Êç¢Á≥ñÊûú
        function swapCandies(row1, col1, row2, col2) {
            const candy1 = gameState.grid[row1][col1];
            const candy2 = gameState.grid[row2][col2];
            
            // ‰∫§Êç¢Á±ªÂûã
            const tempType = candy1.type;
            candy1.type = candy2.type;
            candy2.type = tempType;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            candy1.element.className = `candy ${candy1.type}`;
            candy2.element.className = `candy ${candy2.type}`;
        }

        // Ê£ÄÊü•ÂåπÈÖç
        function checkMatches() {
            const matches = findMatches();
            if (matches.length > 0) {
                removeMatches(matches);
                gameState.score += matches.length * 10;
                updateDisplay();
                
                setTimeout(() => {
                    dropCandies();
                    setTimeout(() => {
                        fillEmptySpaces();
                        setTimeout(() => {
                            checkMatches(); // ÈÄíÂΩíÊ£ÄÊü•Êñ∞ÁöÑÂåπÈÖç
                        }, 300);
                    }, 300);
                }, 300);
            }
        }

        // Êü•ÊâæÂåπÈÖç
        function findMatches() {
            const matches = [];
            
            // Ê£ÄÊü•Ê∞¥Âπ≥ÂåπÈÖç
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 6; col++) {
                    const type = gameState.grid[row][col].type;
                    if (type && 
                        gameState.grid[row][col + 1].type === type && 
                        gameState.grid[row][col + 2].type === type) {
                        
                        let matchLength = 3;
                        while (col + matchLength < 8 && gameState.grid[row][col + matchLength].type === type) {
                            matchLength++;
                        }
                        
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row, col: col + i });
                        }
                        col += matchLength - 1;
                    }
                }
            }
            
            // Ê£ÄÊü•ÂûÇÁõ¥ÂåπÈÖç
            for (let col = 0; col < 8; col++) {
                for (let row = 0; row < 3; row++) {
                    const type = gameState.grid[row][col].type;
                    if (type && 
                        gameState.grid[row + 1][col].type === type && 
                        gameState.grid[row + 2][col].type === type) {
                        
                        let matchLength = 3;
                        while (row + matchLength < 5 && gameState.grid[row + matchLength][col].type === type) {
                            matchLength++;
                        }
                        
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row: row + i, col });
                        }
                        row += matchLength - 1;
                    }
                }
            }
            
            return matches;
        }

        // ÁßªÈô§ÂåπÈÖçÁöÑÁ≥ñÊûú
        function removeMatches(matches) {
            matches.forEach(match => {
                const { row, col } = match;
                gameState.grid[row][col].type = null;
                gameState.grid[row][col].element.style.opacity = '0';
            });
        }

        // Á≥ñÊûú‰∏ãËêΩ
        function dropCandies() {
            for (let col = 0; col < 8; col++) {
                for (let row = 4; row >= 0; row--) {
                    if (!gameState.grid[row][col].type) {
                        // ÊâæÂà∞‰∏äÈù¢Á¨¨‰∏Ä‰∏™ÈùûÁ©∫ÁöÑÁ≥ñÊûú
                        for (let upperRow = row - 1; upperRow >= 0; upperRow--) {
                            if (gameState.grid[upperRow][col].type) {
                                // ÁßªÂä®Á≥ñÊûú
                                gameState.grid[row][col].type = gameState.grid[upperRow][col].type;
                                gameState.grid[row][col].element.className = `candy ${gameState.grid[row][col].type}`;
                                gameState.grid[row][col].element.style.opacity = '1';
                                
                                gameState.grid[upperRow][col].type = null;
                                gameState.grid[upperRow][col].element.style.opacity = '0';
                                break;
                            }
                        }
                    }
                }
            }
        }

        // Â°´ÂÖÖÁ©∫ÁôΩ‰ΩçÁΩÆ
        function fillEmptySpaces() {
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 8; col++) {
                    if (!gameState.grid[row][col].type) {
                        const newType = getRandomCandyType();
                        gameState.grid[row][col].type = newType;
                        gameState.grid[row][col].element.className = `candy ${newType}`;
                        gameState.grid[row][col].element.style.opacity = '1';
                    }
                }
            }
        }

        // Êõ¥Êñ∞ÊòæÁ§∫
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('moves').textContent = gameState.moves;
            
            if (gameState.moves <= 0) {
                endGame();
            }
        }

        // ÂºÄÂßãËÆ°Êó∂Âô®
        function startTimer() {
            gameState.gameStartTime = Date.now();
            gameState.gameTimer = setInterval(updateTimer, 1000);
        }

        // Êõ¥Êñ∞ËÆ°Êó∂Âô®
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ÁªìÊùüÊ∏∏Êàè
        function endGame() {
            clearInterval(gameState.gameTimer);
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('gameOver').style.display = 'flex';
            
            // ‰øùÂ≠òÊ∏∏ÊàèËÆ∞ÂΩï
            if (gameState.currentUser) {
                saveGameRecord();
            }
        }

        // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
        function restartGame() {
            gameState.score = 0;
            gameState.moves = 30;
            gameState.selectedCandy = null;
            clearInterval(gameState.gameTimer);
            
            document.getElementById('gameOver').style.display = 'none';
            initGame();
        }

        // ÂÖ≥Èó≠Ê∏∏ÊàèÁªìÊùüÂºπÁ™ó
        function closeGameOver() {
            document.getElementById('gameOver').style.display = 'none';
        }

        // ÁôªÂΩï
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                return;
            }

            try {
                const response = await apiClient.login(username);
                if (response.success) {
                    gameState.currentUser = username;
                    document.getElementById('currentUser').textContent = username;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('userInfo').style.display = 'block';
                    loadLeaderboard();
                } else {
                    alert(response.message || 'ÁôªÂΩïÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÁôªÂΩïÈîôËØØ:', error);
                alert('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }

        // Ê≥®ÂÜå
        async function register() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                return;
            }

            try {
                const response = await apiClient.register(username);
                if (response.success) {
                    alert('Ê≥®ÂÜåÊàêÂäüÔºÅ');
                    login(); // Ëá™Âä®ÁôªÂΩï
                } else {
                    alert(response.message || 'Ê≥®ÂÜåÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ê≥®ÂÜåÈîôËØØ:', error);
                alert('Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            gameState.currentUser = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('usernameInput').value = '';
        }

        // ‰øùÂ≠òÊ∏∏ÊàèËÆ∞ÂΩï
        async function saveGameRecord() {
            if (!gameState.currentUser) return;

            const gameData = {
                username: gameState.currentUser,
                score: gameState.score,
                moves_used: 30 - gameState.moves,
                duration: Math.floor((Date.now() - gameState.gameStartTime) / 1000)
            };

            try {
                const response = await apiClient.saveGameRecord(gameData);
                if (response.success) {
                    console.log('Ê∏∏ÊàèËÆ∞ÂΩï‰øùÂ≠òÊàêÂäü');
                    loadLeaderboard(); // Âà∑Êñ∞ÊéíË°åÊ¶ú
                }
            } catch (error) {
                console.error('‰øùÂ≠òÊ∏∏ÊàèËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÊéíË°åÊ¶ú
        async function loadLeaderboard() {
            try {
                const response = await apiClient.getLeaderboard();
                if (response.success) {
                    displayLeaderboard(response.data);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊéíË°åÊ¶úÂ§±Ë¥•:', error);
                document.getElementById('leaderboardList').innerHTML = 
                    '<div class="leaderboard-item"><span>Âä†ËΩΩÂ§±Ë¥•</span></div>';
            }
        }

        // ÊòæÁ§∫ÊéíË°åÊ¶ú
        function displayLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboardList');
            
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<div class="leaderboard-item"><span>ÊöÇÊó†ËÆ∞ÂΩï</span></div>';
                return;
            }

            container.innerHTML = leaderboard.slice(0, 5).map((record, index) => `
                <div class="leaderboard-item">
                    <span>${index + 1}. ${record.username}</span>
                    <span>${record.best_score}</span>
                </div>
            `).join('');
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
        });
    </script>
</body>
</html>
