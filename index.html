<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≥ñÊûúÊ∏∏Êàè</title>
    <!-- APIÂÆ¢Êà∑Á´Ø -->
    <script src="js/api-client.js"></script>
    <!-- Êú¨Âú∞ÊµãËØïÊ®°Âºè -->
    <script>
        // Ê£ÄÊµãÊòØÂê¶‰∏∫Êú¨Âú∞ÁéØÂ¢ÉÔºåÂ¶ÇÊûúÊòØÂàôÂêØÁî®ÊµãËØïÊ®°Âºè
        if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.LOCAL_TEST_MODE = true;
            console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÂ∑≤ÂêØÁî®');
        }
    </script>
    <style>
        @font-face {
            font-family: 'SentyWatermelon';
            src: url('SentyWatermelon.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            margin: 0;
            padding: 0;
            background: url('image/background.png') center center / cover no-repeat;
            font-family: 'SentyWatermelon', 'Comic Sans MS', cursive, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Âä†ËΩΩÁïåÈù¢Ê†∑Âºè */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('image/background.png') center center / cover no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }

        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-title {
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            margin-bottom: 50px;
        }

        .loading-container {
            width: 400px;
            height: 60px;
            position: relative;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 30px;
            padding: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 182, 193, 0.8);
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg,
                #FFB6C1 0%,
                #FFC0CB 50%,
                #FFB6C1 100%);
            border-radius: 22px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .loading-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.6),
                transparent);
            animation: loadingShine 2s ease-in-out infinite;
        }

        .candy-pusher {
            position: absolute;
            top: 50%;
            left: 0px;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-image: url('image/pink.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: left 0.5s ease;
            animation: candyBounce 1s ease-in-out infinite alternate;
            z-index: 10;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .loading-percentage {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes loadingShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes candyGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes candyBounce {
            0% {
                transform: translateY(-50%) scale(1) rotate(0deg);
            }
            100% {
                transform: translateY(-50%) scale(1.1) rotate(5deg);
            }
        }

        @keyframes candyRotate {
            0% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-10deg) scale(1.1);
            }
            50% {
                transform: rotate(0deg) scale(1.2);
            }
            75% {
                transform: rotate(10deg) scale(1.1);
            }
            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        .game-container {
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            margin: 10px;
            align-items: center;
            justify-content: flex-start;
            padding-top: 100px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            background: transparent;
            padding: 20px;
            max-width: 1000px;
            width: 100%;
            aspect-ratio: 8/5;
            max-height: 560px;
            margin: 0 auto;
        }

        .grid-cell {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            min-height: 0;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .grid-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .grid-cell:hover::before {
            opacity: 1;
        }

        .candy {
            width: 110%;
            height: 110%;
            position: relative;
            max-width: 200px;
            max-height: 200px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .red { background-image: url('image/red.png'); }
        .green { background-image: url('image/light_green.png'); }
        .pink { background-image: url('image/pink.png'); }
        .blue { background-image: url('image/blue.png'); }
        .yellow { background-image: url('image/yellow.png'); }
        .darkgreen { background-image: url('image/deep_green.png'); }

        .timer-container {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            z-index: 10;
        }

        .timer-bar-container {
            width: 100%;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: visible;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 20px;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .timer-bar.warning {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .timer-bar.critical {
            background: linear-gradient(90deg, #F44336, #FF5722);
            animation: pulse-bar 1s infinite;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }



        .score {
            text-align: center;
            margin-bottom: 10px;
            font-size: 22px;
            font-weight: bold;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(205, 221, 236, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 24px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #333;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 16px rgba(205, 221, 236, 0.3);
        }

        @keyframes pulse-bar {
            0%, 100% {
                box-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(244, 67, 54, 0.8);
            }
        }

        .controls {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 25px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                inset 0 -1px 0 rgba(0, 0, 0, 0.02);
            margin: 0px auto 50px auto;
            width: fit-content;
            max-width: 90%;
        }

        .control-layout {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0px;
        }

        .manual-controls, .auto-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }



        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .candy-icon {
            width: 70px;
            height: 70px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Âº∫Âà∂WÈîÆÊòæÁ§∫Ê≠£Á°ÆÁöÑÊµÖÁªøËâ≤Á≥ñÊûúÂõæÁâá */
        .manual-controls .control-group:nth-child(2) .candy-icon,
        .manual-controls .control-group:nth-child(2) .candy-icon.green,
        div.candy-icon.green {
            background-image: url('image/light_green.png') !important;
            background-size: contain !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
        }

        /* Á°Æ‰øùÊ≤°ÊúâÂÖ∂‰ªñÊ†∑ÂºèË¶ÜÁõñWÈîÆÁ≥ñÊûú */
        .candy-icon.green[style*="light_green"] {
            background-image: url('image/light_green.png') !important;
        }

        /* Èò≤Ê≠¢È´ò‰∫ÆÊïàÊûúÂΩ±ÂìçWÈîÆÁ≥ñÊûúÈ¢úËâ≤ - Âè™ÈíàÂØπWÈîÆÔºàÁ¨¨‰∫å‰∏™Á≥ñÊûúÔºâ */
        .manual-highlight .manual-controls .control-group:nth-child(2) .candy-icon,
        .manual-highlight .manual-controls .control-group:nth-child(2) .candy-icon.green {
            background-image: url('image/light_green.png') !important;
            filter: none !important;
        }

        /* ÁâπÂà´ÈíàÂØπWÈîÆÁ≥ñÊûúÁöÑ‰øùÊä§ */
        .manual-controls .control-group:nth-child(2) .candy-icon {
            background-image: url('image/light_green.png') !important;
            filter: none !important;
        }

        .key-display {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 22px;
            transition: all 0.3s ease;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            color: #333;
        }

        .key-display.pressed {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.8), 0 0 30px rgba(255, 0, 0, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3);
            border: 3px solid #cc0000 !important;
            font-weight: bold;
            animation: pulse 0.3s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.2); }
        }

        .key-display.correct {
            transform: scale(1.2) !important;
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.8), 0 0 30px rgba(0, 255, 0, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3) !important;
            border: 3px solid #00cc00 !important;
            font-weight: bold;
            animation: pulse 0.3s ease-in-out;
            background: linear-gradient(145deg, #00ff00, #00cc00) !important;
        }

        .key-display.wrong {
            transform: scale(1.2) !important;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.8), 0 0 30px rgba(255, 0, 0, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.3) !important;
            border: 3px solid #cc0000 !important;
            font-weight: bold;
            animation: pulse 0.3s ease-in-out;
            background: linear-gradient(145deg, #ff0000, #cc0000) !important;
        }

        .character {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .character:nth-child(2) {
            position: absolute;
            left: 320px;
            top: 15px;
            z-index: 50;
        }

        .character img {
            width: 80px;
            height: 80px;
        }

        #robotImg {
            width: auto;
            height: 100px;
            object-fit: contain;
        }

        #humanCanvas {
            width: auto;
            height: 80px;
            object-fit: contain;
        }

        #humanImg {
            width: auto;
            height: 120px;
            object-fit: contain;
        }

        #humanImg.fast {
            animation: speed-up 0.33s infinite linear;
        }

        @keyframes speed-up {
            0% { transform: scale(1); }
            100% { transform: scale(1); }
        }



        #robotCharacter {
            position: relative !important;
            margin-left: -160px !important;
            margin-top: 40px !important;
            z-index: 50 !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
        }

        .character-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: -20px;
            text-align: center;
            z-index: 100;
            position: relative;
        }

        .keyboard-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-top: -50px;
        }

        .keyboard {
            width: 350px;
            height: 90px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 3px;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .keyboard-row {
            display: flex;
            gap: 0.5px;
            margin-bottom: 0.5px;
        }

        .keyboard-key {
            width: 12px;
            height: 8px;
            background: linear-gradient(145deg, #f8f8f8, #e0e0e0);
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            font-size: 6px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .keyboard-key.highlight {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
            transform: scale(1.1);
        }

        .keyboard-spacebar {
            width: 60px !important;
            flex-grow: 1;
            max-width: 80px;
        }

        .keyboard-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: normal;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }



        .countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 900;
            color: #333;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8), 0 0 10px rgba(255, 255, 255, 0.6);
            z-index: 1000;
            background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.95),
                rgba(255, 218, 185, 0.95),
                rgba(255, 240, 245, 0.95));
            border-radius: 30px;
            padding: 40px 60px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
            backdrop-filter: blur(10px);
            animation: countdownPulse 1s ease-in-out infinite;
        }

        @keyframes countdownPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                           0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                           0 0 0 0 rgba(255, 182, 193, 0.7);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4),
                           0 0 0 1px rgba(255, 255, 255, 0.3) inset,
                           0 0 0 20px rgba(255, 182, 193, 0.3);
            }
        }

        .countdown.number-animation {
            animation: countdownNumber 1s ease-in-out;
        }

        @keyframes countdownNumber {
            0% {
                transform: translate(-50%, -50%) scale(0.5) rotateY(90deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotateY(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        .countdown.start-animation {
            animation: countdownStart 1s ease-in-out;
            background: linear-gradient(135deg,
                rgba(144, 238, 144, 0.95),
                rgba(152, 251, 152, 0.95),
                rgba(240, 255, 240, 0.95));
        }

        @keyframes countdownStart {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Èü≥ÈáèÊéßÂà∂ÊåâÈíÆ */
        .volume-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .volume-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.9), rgba(255, 218, 185, 0.9));
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .volume-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .volume-btn:active {
            transform: scale(0.95);
        }

        /* Ë∑≥ËøáÊåâÈíÆÂÆπÂô® */
        #skipButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .skip-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(255, 99, 99, 0.9), rgba(255, 150, 150, 0.9));
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .skip-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* ÂÖ®Â±èÊèêÁ§∫ÂºπÁ™ó */
        .fullscreen-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .fullscreen-dialog {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-dialog h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .fullscreen-dialog p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }

        .fullscreen-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .fullscreen-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fullscreen-btn.primary {
            background: #4CAF50;
            color: white;
        }

        .fullscreen-btn.primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .fullscreen-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .fullscreen-btn.secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .skip-btn:active {
            transform: translateY(0);
        }

        .score-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
            transition: all 0.8s ease-out;
            opacity: 1;
        }

        .score-value {
            font-size: 36px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            text-align: center;
        }

        .score-value.positive {
            color: #00aa00;
        }

        .score-value.negative {
            color: #ff0000;
            font-size: 40px;
        }

        .reaction-time {
            font-size: 18px;
            color: #666;
            text-align: center;
            margin-top: 4px;
            font-weight: bold;
        }

        .penalty-text {
            font-size: 14px;
            color: #ff0000;
            text-align: center;
            margin-top: 2px;
            font-weight: bold;
        }

        .score-popup.penalty {
            animation: shake 0.5s ease-in-out;
        }

        .score-popup.general {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #ff0000;
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            25% { transform: translate(-50%, -50%) translateX(-5px); }
            75% { transform: translate(-50%, -50%) translateX(5px); }
        }

        @keyframes candyPop {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.3) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }



        .candy.popping {
            animation: candyPop 0.4s ease-out forwards;
        }



        .key {
            font-weight: bold;
            color: #666;
        }

        /* ÂºÄÂßãËèúÂçïÊ†∑Âºè */
        .start-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('image/background.png') center center / cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow: hidden;
        }

        /* ËÉåÊôØÂõæÁâáÂÆö‰Ωç */
        .bg-center {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 900px;
            max-height: 900px;
            z-index: 1001;
            animation: floatCenter 3s ease-in-out infinite;
        }

        .bg-bottom-right {
            position: absolute;
            bottom: 40px;
            right: 80px;
            max-width: 320px;
            max-height: 320px;
            z-index: 1001;
            animation: floatBottomRight 4s ease-in-out infinite;
        }

        .bg-right {
            position: absolute;
            right: 60px;
            top: 30%;
            transform: translateY(-50%);
            max-width: 280px;
            max-height: 280px;
            z-index: 1001;
            animation: floatRight 3.5s ease-in-out infinite;
        }

        .bg-left {
            position: absolute;
            left: 60px;
            top: 90%;
            transform: translateY(-50%);
            max-width: 280px;
            max-height: 280px;
            z-index: 1001;
            animation: floatLeft 3.5s ease-in-out infinite;
        }

        .bg-top-left {
            position: absolute;
            top: 60px;
            left: 60px;
            max-width: 250px;
            max-height: 250px;
            z-index: 1001;
            animation: floatTopLeft 4.5s ease-in-out infinite;
        }

        /* ÊµÆÂä®Âä®Áîª */
        @keyframes floatCenter {
            0%, 100% { transform: translate(-50%, -50%) translateY(0px) rotate(0deg); }
            50% { transform: translate(-50%, -50%) translateY(-15px) rotate(2deg); }
        }

        @keyframes floatBottomRight {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(-1deg); }
        }

        @keyframes floatLeft {
            0%, 100% { transform: translateY(-50%) translateX(0px) rotate(0deg); }
            50% { transform: translateY(-50%) translateX(5px) rotate(1deg); }
        }

        @keyframes floatTopLeft {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(-2deg); }
        }

        @keyframes floatRight {
            0%, 100% { transform: translateY(-50%) translateX(0px) rotate(0deg); }
            50% { transform: translateY(-50%) translateX(-5px) rotate(-1deg); }
        }

        .start-menu-content {
            text-align: center;
            color: white;
            max-width: 1200px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            z-index: 1002;
            position: relative;
        }

        .start-instruction-container {
            position: relative;
            margin-top: 420px; /* Â∞ÜÊñáÂ≠óÊîæÂú®bg2‰∏ãÈù¢ÔºåÂæÄ‰∏ãÁßªÂä®Êõ¥Â§ö */
        }

        /* ÁôªÂΩïÁïåÈù¢ÂíåÊú∫Âô®‰∫∫ÈÄâÊã©ÁïåÈù¢‰øùÊåÅÂ±Ö‰∏≠ */
        .login-container,
        .robot-selection {
            margin-top: 0 !important;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .game-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            background: linear-gradient(45deg,
                #ff6b9d, #ffa726, #66bb6a, #42a5f5, #ab47bc, #ef5350);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: candyGradient 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
        }

        @keyframes candyGradient {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .start-instruction {
            font-size: 28px;
            margin-bottom: 40px;
            cursor: pointer;
            background: linear-gradient(45deg, #ff6b9d, #ffa726, #66bb6a, #42a5f5);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite, textPulse 2s ease-in-out infinite;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 1003;
        }

        .start-instruction-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            animation: glowPulse 2s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes textPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes glowPulse {
            0%, 100% {
                opacity: 0.3;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.6;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        .start-instruction:hover {
            animation: gradientShift 1s ease-in-out infinite, textPulse 1s ease-in-out infinite;
        }

        .robot-selection h2 {
            font-size: 32px;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .robot-selection {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 30px;
            padding: 40px 50px 50px 50px;
            backdrop-filter: blur(15px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            max-width: 1100px;
            min-width: 1000px;
            margin: -50px auto 20px auto;
            width: fit-content;
            align-self: center;
        }

        .robot-options {
            display: flex;
            gap: 60px;
            justify-content: center;
            align-items: stretch;
            width: 100%;
            padding: 0 20px;
        }

        .robot-option {
            background: rgba(255, 255, 255, 0.25);
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 25px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(12px);
            text-align: center;
            min-width: 300px;
            max-width: 340px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        /* Ê≥¢Ê≥¢ÁöÑÂúÜÊ∂¶È£éÊ†º */
        .robot-option[data-robot="robot1"] {
            border-radius: 35px;
            background: linear-gradient(145deg, rgba(255, 182, 193, 0.3), rgba(255, 255, 255, 0.2));
            border-color: rgba(255, 192, 203, 0.6);
            position: relative;
            overflow: visible;
        }



        /* ‰∏âËßíÂêõÁöÑÂá†‰ΩïÈ£éÊ†º */
        .robot-option[data-robot="robot2"] {
            border-radius: 15px;
            background: linear-gradient(145deg, rgba(135, 206, 235, 0.3), rgba(255, 255, 255, 0.2));
            border-color: rgba(100, 149, 237, 0.6);
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }

        .robot-option:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
        }

        .robot-option[data-robot="robot1"]:hover {
            background: linear-gradient(145deg, rgba(255, 182, 193, 0.4), rgba(255, 255, 255, 0.3));
            border-color: rgba(255, 192, 203, 0.8);
        }

        .robot-option[data-robot="robot2"]:hover {
            background: linear-gradient(145deg, rgba(135, 206, 235, 0.4), rgba(255, 255, 255, 0.3));
            border-color: rgba(100, 149, 237, 0.8);
        }

        .robot-option img,
        .robot-option video {
            width: 240px;
            height: 240px;
            border-radius: 20px;
            margin: 0 auto 10px auto;
            transition: transform 0.3s ease;
            display: block;
        }

        .robot-option:hover img,
        .robot-option:hover video {
            transform: scale(1.05);
        }

        .robot-option .robot-name {
            font-size: 18px;
            font-weight: 800;
            margin: 0 0 15px 0;
            color: #fff;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.8);
            line-height: 1.3;
            letter-spacing: 0.5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .robot-option .robot-description {
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            color: rgba(255, 255, 255, 0.98);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
            line-height: 1.6;
            text-align: left;
            padding: 15px;
            letter-spacing: 0.3px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 0 10px;
        }

        /* Ê≥¢Ê≥¢ÁöÑÊñáÂ≠óÊ°ÜÊ†∑Âºè - ÂêàÂπ∂‰∏∫‰∏Ä‰∏™Ê°Ü */
        .robot-option[data-robot="robot1"] .robot-text-container {
            background: rgba(255, 182, 193, 0.6);
            border: 1px solid rgba(255, 192, 203, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: 10px;
        }

        .robot-option[data-robot="robot1"] .robot-name {
            background: none;
            border: none;
            margin-bottom: 15px;
            padding: 0;
        }

        .robot-option[data-robot="robot1"] .robot-description {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
        }

        /* ÂèØ‰πêÊñπÁöÑËßÜÈ¢ëÁâπÊÆäÊ†∑Âºè - Â§ßÂπÖÂæÄ‰∏ãÁßª */
        .robot-option[data-robot="robot2"] video {
            margin: 20px auto 30px auto;
        }

        /* ‰∏âËßíÂêõÁöÑÊñáÂ≠óÊ°ÜÊ†∑Âºè - ÈÄÇÂ∫¶ÂæÄ‰∏äÁßª */
        .robot-option[data-robot="robot2"] .robot-text-container {
            background: rgba(135, 206, 235, 0.6);
            border: 1px solid rgba(100, 149, 237, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: -25px !important;
            transform: translateY(-10px) !important;
        }

        .robot-option[data-robot="robot2"] .robot-name {
            background: none;
            border: none;
            margin-bottom: 15px;
            padding: 0;
        }

        .robot-option[data-robot="robot2"] .robot-description {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
        }

        /* Ê†áÈ¢òÊ†∑Âºè‰πüÊõ¥ÂèØÁà± */
        .robot-selection h2 {
            font-size: 28px;
            font-weight: 800;
            color: #333;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .selection-notice {
            font-size: 14px;
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 0 auto 25px auto;
            max-width: 400px;
            text-align: center;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
            animation: noticeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes noticeGlow {
            0% {
                box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
            }
            100% {
                box-shadow: 0 2px 12px rgba(255, 107, 107, 0.4);
            }
        }

        /* Á≥ñÊûúË£ÖÈ•∞Ê†∑Âºè */
        .candy-decoration {
            position: absolute;
            font-size: 24px;
            opacity: 0.7;
            animation: candyFloat 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes candyFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg) scale(1);
                opacity: 0.7;
            }
            25% {
                transform: translateY(-8px) rotate(3deg) scale(1.1);
                opacity: 0.9;
            }
            50% {
                transform: translateY(-15px) rotate(5deg) scale(1.05);
                opacity: 0.8;
            }
            75% {
                transform: translateY(-8px) rotate(-2deg) scale(1.1);
                opacity: 0.9;
            }
        }

        /* ÂèØÁà±ÁöÑÂØπËØùÊ°ÜÊ†∑Âºè */
        .speech-bubble {
            display: inline-block;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #ff69b4;
            border-radius: 20px;
            padding: 8px 15px;
            margin-top: 8px;
            position: relative;
            font-weight: 600;
            color: #ff1493;
            text-shadow: none;
            box-shadow: 0 3px 10px rgba(255, 105, 180, 0.3);
            animation: bubblePulse 2s ease-in-out infinite;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #ff69b4;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 21px;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 7px solid rgba(255, 255, 255, 0.95);
        }

        @keyframes bubblePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ËìùËâ≤Êú∫Âô®‰∫∫ÁöÑÁôΩÂ∫ïËìùËæπÂØπËØùÊ°Ü */
        .robot-option[data-robot="robot2"] .speech-bubble {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #4169e1;
            color: #4169e1;
            box-shadow: 0 3px 10px rgba(65, 105, 225, 0.3);
        }

        .robot-option[data-robot="robot2"] .speech-bubble::before {
            border-top: 8px solid #4169e1;
        }

        .robot-option[data-robot="robot2"] .speech-bubble::after {
            border-top: 7px solid rgba(255, 255, 255, 0.95);
        }

        /* Êú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢Ê†∑Âºè */
        .robot-introduction {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('image/background.png') center center / cover no-repeat;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .conversation-container {
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            width: 100%;
            padding: 40px;
            min-height: calc(100vh - 80px);
            position: relative;
        }

        .main-conversation {
            display: flex;
            align-items: center;
            gap: 50px;
            flex: 1;
            margin-bottom: 120px; /* ‰∏∫Â∫ïÈÉ®ËæìÂÖ•Ê°ÜÁïôÁ©∫Èó¥ */
        }

        .robot-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        .robot-name-label {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            padding: 12px 25px;
            border-radius: 20px;
            animation: nameFloat 3s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        /* Ê≥¢Ê≥¢ÁöÑÁ≤âËâ≤ÂêçÁß∞Ê†áÁ≠æ */
        .robot-name-label.robot1 {
            background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.9) 0%,
                rgba(255, 192, 203, 0.8) 50%,
                rgba(255, 182, 193, 0.9) 100%);
            border: 2px solid rgba(255, 192, 203, 0.6);
            color: #2d1b2e;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.4);
        }

        /* ÂèØ‰πêÊñπÁöÑËìùËâ≤ÂêçÁß∞Ê†áÁ≠æ */
        .robot-name-label.robot2 {
            background: linear-gradient(135deg,
                rgba(135, 206, 235, 0.9) 0%,
                rgba(100, 149, 237, 0.8) 50%,
                rgba(135, 206, 235, 0.9) 100%);
            border: 2px solid rgba(100, 149, 237, 0.6);
            color: #1a2332;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 25px rgba(135, 206, 235, 0.4);
        }

        @keyframes nameFloat {
            0%, 100% {
                transform: translateY(0px) scale(1);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
            }
        }

        .robot-character {
            position: relative;
        }

        /* Ê≥¢Ê≥¢ËßÜÈ¢ëÁâπÊÆäÂ§ÑÁêÜ - Ë£ÅÂâ™Âè≥‰∏ãËßíÊ∞¥Âç∞ */
        #selectedRobotVideo.robot1-video,
        .robot-option[data-robot="robot1"] video {
            clip-path: polygon(0% 0%, 100% 0%, 100% 78%, 78% 100%, 0% 100%);
        }

        /* ÂèØ‰πêÊñπËßÜÈ¢ëÁâπÊÆäÂ§ÑÁêÜ - Ë£ÅÂâ™Âè≥‰∏ãËßíÊ∞¥Âç∞ */
        #selectedRobotVideo.robot2-video,
        .robot-option[data-robot="robot2"] video,
        #endRobotVideo.robot2-video,
        #rulesRobotVideo.robot2-video {
            clip-path: polygon(0% 0%, 100% 0%, 100% 78%, 78% 100%, 0% 100%);
        }

        /* ÂØπËØùÁ≥ªÁªü‰∏≠ÁöÑÊ≥¢Ê≥¢ËßÜÈ¢ë‰∏çË£ÅÂâ™Ôºå‰øùÊåÅÂÆåÊï¥ÊòæÁ§∫ */
        #dialogVideo.robot1-video {
            clip-path: none !important;
        }

        .dialogue-section {
            flex: 1;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .dialogue-bubble {
            padding: 25px 30px;
            border-radius: 25px;
            position: relative;
            min-height: 120px;
            max-width: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            backdrop-filter: blur(10px);
            transform: scale(0);
            animation: bubblePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            transition: all 0.3s ease;
            overflow: visible;
            margin-left: 40px; /* ‰∏∫Ê∞îÊ≥°Â∞æÂ∑¥ÁïôÁ©∫Èó¥ */
        }

        /* ÁªìÂ∞æÂØπËØùÊ°ÜÁâπÊÆäÊ†∑Âºè - ‰∏çÈáçÂ§çÂä®Áîª */
        .dialogue-bubble.end-dialog {
            transform: scale(1);
            animation: none;
        }

        /* Á°Æ‰øùÂØπËØùÊñáÊú¨Â≠ó‰ΩìÂ§ßÂ∞è‰∏ÄËá¥ */
        .dialogue-text {
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            width: 100%;
            text-align: center;
        }

        /* Ê∞îÊ≥°ÂºπÂá∫Âä®Áîª */
        @keyframes bubblePop {
            0% {
                transform: scale(0) rotate(-5deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(2deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Ê∞îÊ≥°ÊÇ¨ÊµÆÂä®Áîª */
        @keyframes bubbleFloat {
            0%, 100% {
                transform: translateY(0px) scale(1);
            }
            50% {
                transform: translateY(-5px) scale(1.02);
            }
        }

        .dialogue-bubble:hover {
            animation: bubbleFloat 2s ease-in-out infinite;
        }

        /* Ê≥¢Ê≥¢ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò - Êõ¥Á≤æÁæéÁöÑËÆæËÆ° */
        .dialogue-bubble.robot1 {
            background: linear-gradient(135deg,
                rgba(255, 182, 193, 0.9) 0%,
                rgba(255, 192, 203, 0.8) 50%,
                rgba(255, 182, 193, 0.9) 100%);
            border: 3px solid rgba(255, 192, 203, 0.6);
            box-shadow:
                0 15px 35px rgba(255, 182, 193, 0.3),
                0 5px 15px rgba(255, 192, 203, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            color: #2d1b2e;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .dialogue-bubble.robot1::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 18px solid transparent;
            border-bottom: 18px solid transparent;
            border-right: 25px solid rgba(255, 182, 193, 0.9);
            filter: drop-shadow(-2px 0 3px rgba(255, 182, 193, 0.3));
        }

        .dialogue-bubble.robot1::after {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 20px solid rgba(255, 182, 193, 0.9);
        }

        /* ÂèØ‰πêÊñπÁöÑËìùËâ≤‰∏ªÈ¢ò - Êõ¥Á≤æÁæéÁöÑËÆæËÆ° */
        .dialogue-bubble.robot2 {
            background: linear-gradient(135deg,
                rgba(135, 206, 235, 0.9) 0%,
                rgba(100, 149, 237, 0.8) 50%,
                rgba(135, 206, 235, 0.9) 100%);
            border: 3px solid rgba(100, 149, 237, 0.6);
            box-shadow:
                0 15px 35px rgba(135, 206, 235, 0.3),
                0 5px 15px rgba(100, 149, 237, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            color: #1a2332;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .dialogue-bubble.robot2::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 18px solid transparent;
            border-bottom: 18px solid transparent;
            border-right: 25px solid rgba(135, 206, 235, 0.9);
            filter: drop-shadow(-2px 0 3px rgba(135, 206, 235, 0.3));
        }

        .dialogue-bubble.robot2::after {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-right: 20px solid rgba(135, 206, 235, 0.9);
        }

        /* ÁßªÈô§‰∫ÜÊ∞îÊ≥°Ë£ÖÈ•∞ÂÖÉÁ¥†Ôºå‰øùÊåÅÁÆÄÊ¥ÅÁöÑËÆæËÆ° */

        /* Ë¢´ËØïÁôªÂΩïÁïåÈù¢Ê†∑Âºè */
        .login-container {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 30px;
            padding: 40px 50px;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
            color: white;
            /* ÁßªÈô§Âä®ÁîªÔºåÁõ¥Êé•ÊòæÁ§∫Âú®‰∏≠Â§Æ */
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
        }

        .login-container h2 {
            font-size: 28px;
            font-weight: 800;
            color: #333;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Ê≥®ÂÜåË°®ÂçïÂ¢ûÂä†Ë°®ÂçïÈ°π‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        #registerForm .form-group {
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
            margin-bottom: 5px;
        }

        .form-group label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .form-input {
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(255, 255, 255, 0.8);
            background: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .form-select {
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-select:focus {
            border-color: rgba(255, 255, 255, 0.8);
            background: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .login-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .login-btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .login-btn.primary {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            color: #333;
            border: 2px solid rgba(255, 182, 193, 0.6);
        }

        .login-btn.secondary {
            background: linear-gradient(135deg, #ADD8E6 0%, #87CEEB 100%);
            color: #333;
            border: 2px solid rgba(135, 206, 235, 0.6);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .login-btn.primary:hover {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFD0DC 100%);
            border-color: rgba(255, 192, 203, 0.8);
        }

        .login-btn.secondary:hover {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            border-color: rgba(135, 206, 235, 0.8);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #FFE4E1 0%, #FFF0F5 50%, #E6E6FA 100%);
            border-radius: 20px;
            padding: 0;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .close {
            color: #333;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .user-list-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        .user-list-table th,
        .user-list-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .user-list-table th {
            background: linear-gradient(135deg, #ADD8E6 0%, #87CEEB 100%);
            color: #333;
            font-weight: bold;
        }

        .user-list-table tr:hover {
            background-color: rgba(255, 182, 193, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .privacy-notice {
            font-size: 14px;
            color: #333;
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .privacy-notice .highlight {
            color: #FF6B6B;
            font-weight: 600;
        }

        .toggle-form {
            margin-top: 20px;
            color: #333;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .toggle-link {
            color: #4A90E2;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

        .toggle-link:hover {
            color: #357ABD;
        }

        /* ÊèêÁ§∫ÊñáÂ≠óÊ†∑Âºè */
        .form-hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .form-hint .warning {
            color: #FF6B6B;
            font-weight: 600;
        }

        /* Êü•ËØ¢Ê∂àÊÅØÊ†∑Âºè */
        .query-message {
            margin-top: 15px;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            text-align: left;
            animation: fadeIn 0.3s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .query-message.success {
            background: linear-gradient(135deg, #E8F5E8, #F0F8F0);
            border: 2px solid #4CAF50;
            color: #2E7D32;
        }

        .query-message.error {
            background: linear-gradient(135deg, #FFF3F3, #FFEBEE);
            border: 2px solid #F44336;
            color: #C62828;
            text-align: center;
        }

        .query-message.info {
            background: linear-gradient(135deg, #E3F2FD, #F0F8FF);
            border: 2px solid #2196F3;
            color: #1565C0;
            text-align: center;
        }

        .query-message .user-info {
            margin-bottom: 12px;
        }

        .query-message .user-info-item {
            margin: 6px 0;
            font-weight: 500;
        }

        .query-message .confirm-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .query-message .confirm-btn:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ë∑≥ËøáÊåâÈíÆÊ†∑Âºè */
        .skip-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: #333;
            border: 2px solid rgba(255, 165, 0, 0.6);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }

        .skip-button:hover {
            background: linear-gradient(135deg, #FF8C00 0%, #FF7F00 100%);
            border-color: rgba(255, 140, 0, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.4);
        }

        .skip-button::before {
            content: "üöÄ";
            margin-right: 5px;
        }

        /* ÂÜÖÊµãÊèêÁ§∫ */
        .beta-notice {
            position: absolute;
            top: 70px;
            right: 20px;
            font-size: 12px;
            color: #FF8C00;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 140, 0, 0.3);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        /* Ê∏∏ÊàèËßÑÂàôËíôÁâà */
        .game-rules-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            pointer-events: none;
        }

        /* È´ò‰∫ÆÂÖÉÁ¥†‰∏çË¢´ËíôÁâàË¶ÜÁõñ */
        .user-highlight,
        .robot-highlight,
        .manual-highlight,
        .auto-highlight {
            position: relative;
            z-index: 1600;
        }

        /* Êú∫Âô®‰∫∫ËßÑÂàôËØ¥ÊòéÂå∫Âüü */
        .rules-robot-guide {
            position: fixed;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1600;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .rules-robot-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .rules-robot-video {
            width: 150px;
            height: 150px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .robot-video {
            width: 300px;
            height: 300px;
            border-radius: 20px;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.1);
        }

        .rules-robot-name {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            text-align: center;
        }

        /* ËßÑÂàôÊ∞îÊ≥°Ê°Ü */
        .rules-speech-bubble {
            max-width: 400px;
            padding: 25px 30px;
            border-radius: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            color: #333;
            animation: bubblePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        .rules-speech-bubble.robot1 {
            background: rgba(255, 182, 193, 0.9);
            border: 2px solid rgba(255, 192, 203, 0.9);
            box-shadow: 0 15px 35px rgba(255, 182, 193, 0.4);
        }

        .rules-speech-bubble.robot2 {
            background: rgba(135, 206, 235, 0.9);
            border: 2px solid rgba(100, 149, 237, 0.9);
            box-shadow: 0 15px 35px rgba(135, 206, 235, 0.4);
        }

        .rules-speech-bubble::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
        }

        .rules-speech-bubble.robot1::before {
            border-right: 20px solid rgba(255, 182, 193, 0.9);
        }

        .rules-speech-bubble.robot2::before {
            border-right: 20px solid rgba(135, 206, 235, 0.9);
        }

        /* ËßÑÂàôÊéßÂà∂ÊåâÈíÆ */
        .rules-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .rules-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .rules-btn.primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .rules-btn.secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .rules-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* QWEÊåâÈîÆ‰∏çÈúÄË¶ÅÈ´ò‰∫ÆÊïàÊûúÔºåÂ∑≤ÁßªÈô§highlightedÊ†∑Âºè */

        @keyframes keyGlow {
            from {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.6);
            }
        }

        /* ÊºîÁ§∫Èó™ÁÉÅÊïàÊûú */
        .key-display.demo-flashing {
            background: linear-gradient(145deg, #FF6B6B, #FF4757) !important;
            box-shadow:
                0 0 20px rgba(255, 107, 107, 0.8),
                0 0 40px rgba(255, 107, 107, 0.6),
                inset 0 0 10px rgba(255, 255, 255, 0.3) !important;
            animation: demo-flash 1s ease-in-out infinite !important;
            border: 2px solid #FF6B6B !important;
        }

        @keyframes demoFlash {
            from {
                box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
                transform: scale(1.2);
            }
            to {
                box-shadow: 0 0 40px rgba(255, 107, 107, 1), 0 0 60px rgba(255, 107, 107, 0.6);
                transform: scale(1.3);
            }
        }

        /* ÊºîÁ§∫Á≥ñÊûúÈ´ò‰∫ÆÊïàÊûú */
        .demo-highlight {
            animation: demoGlow 1s ease-in-out infinite alternate !important;
            transform: scale(1.1) !important;
            z-index: 1600 !important;
        }

        @keyframes demoGlow {
            from {
                box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
                filter: brightness(1.2);
            }
            to {
                box-shadow: 0 0 40px rgba(255, 107, 107, 1), 0 0 60px rgba(255, 107, 107, 0.6);
                filter: brightness(1.5);
            }
        }

        /* ÂàÜÊï∞È£òÊµÆÂä®Áîª */
        @keyframes scoreFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* ‰ªãÁªçÊ≠•È™§È´ò‰∫ÆÊïàÊûú */
        .user-highlight {
            animation: userGlow 1.5s ease-in-out infinite alternate !important;
            transform: scale(1.1) !important;
            z-index: 1600 !important;
        }

        .robot-highlight {
            animation: robotGlow 1.5s ease-in-out infinite alternate !important;
            transform: scale(1.1) !important;
            z-index: 1600 !important;
        }

        .manual-highlight {
            /* ÁßªÈô§‰ºöÂΩ±ÂìçÁ≥ñÊûúÈ¢úËâ≤ÁöÑÈ´ò‰∫ÆÊïàÊûú */
            z-index: 1600 !important;
            /* Ê∑ªÂä†Á∫¢Ëâ≤ÂÖâÊôïÈ´ò‰∫ÆÊïàÊûú */
            border-radius: 15px !important;
            box-shadow:
                0 0 20px rgba(255, 107, 107, 0.8),
                0 0 40px rgba(255, 107, 107, 0.6),
                0 0 60px rgba(255, 107, 107, 0.4),
                inset 0 0 20px rgba(255, 107, 107, 0.2) !important;
            animation: red-glow-pulse 2s ease-in-out infinite !important;
            background: rgba(255, 107, 107, 0.1) !important;
        }

        @keyframes red-glow-pulse {
            0% {
                box-shadow:
                    0 0 20px rgba(255, 107, 107, 0.8),
                    0 0 40px rgba(255, 107, 107, 0.6),
                    0 0 60px rgba(255, 107, 107, 0.4),
                    inset 0 0 20px rgba(255, 107, 107, 0.2);
            }
            50% {
                box-shadow:
                    0 0 30px rgba(255, 107, 107, 1),
                    0 0 60px rgba(255, 107, 107, 0.8),
                    0 0 90px rgba(255, 107, 107, 0.6),
                    inset 0 0 30px rgba(255, 107, 107, 0.3);
            }
            100% {
                box-shadow:
                    0 0 20px rgba(255, 107, 107, 0.8),
                    0 0 40px rgba(255, 107, 107, 0.6),
                    0 0 60px rgba(255, 107, 107, 0.4),
                    inset 0 0 20px rgba(255, 107, 107, 0.2);
            }
        }

        @keyframes golden-glow-pulse {
            0%, 100% {
                box-shadow:
                    0 0 20px rgba(255, 215, 0, 0.8),
                    0 0 40px rgba(255, 215, 0, 0.6),
                    inset 0 0 10px rgba(255, 255, 255, 0.3);
                transform: scale(1.05);
            }
            50% {
                box-shadow:
                    0 0 30px rgba(255, 215, 0, 1),
                    0 0 60px rgba(255, 215, 0, 0.8),
                    inset 0 0 15px rgba(255, 255, 255, 0.5);
                transform: scale(1.08);
            }
        }

        @keyframes demo-flash {
            0%, 100% {
                box-shadow:
                    0 0 20px rgba(255, 107, 107, 0.8),
                    0 0 40px rgba(255, 107, 107, 0.6),
                    inset 0 0 10px rgba(255, 255, 255, 0.3);
                opacity: 1;
            }
            50% {
                box-shadow:
                    0 0 30px rgba(255, 107, 107, 1),
                    0 0 60px rgba(255, 107, 107, 0.8),
                    inset 0 0 15px rgba(255, 255, 255, 0.5);
                opacity: 0.7;
            }
        }

        .auto-highlight {
            animation: autoGlow 1.5s ease-in-out infinite alternate !important;
            transform: scale(1.05) !important;
            z-index: 1600 !important;
        }

        @keyframes userGlow {
            from {
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
                filter: brightness(1.2);
            }
            to {
                box-shadow: 0 0 40px rgba(76, 175, 80, 1), 0 0 60px rgba(76, 175, 80, 0.6);
                filter: brightness(1.5);
            }
        }

        @keyframes robotGlow {
            from {
                box-shadow: 0 0 20px rgba(33, 150, 243, 0.8);
                filter: brightness(1.2);
            }
            to {
                box-shadow: 0 0 40px rgba(33, 150, 243, 1), 0 0 60px rgba(33, 150, 243, 0.6);
                filter: brightness(1.5);
            }
        }

        @keyframes manualGlow {
            /* ÁßªÈô§‰ºöÂΩ±ÂìçÁ≥ñÊûúÈ¢úËâ≤ÁöÑÂä®ÁîªÊïàÊûú */
            from {
                /* ‰∏çÊ∑ªÂä†‰ªª‰ΩïÊïàÊûú */
            }
            to {
                /* ‰∏çÊ∑ªÂä†‰ªª‰ΩïÊïàÊûú */
            }
        }

        @keyframes autoGlow {
            from {
                box-shadow: 0 0 20px rgba(156, 39, 176, 0.8);
                filter: brightness(1.2);
            }
            to {
                box-shadow: 0 0 40px rgba(156, 39, 176, 1), 0 0 60px rgba(156, 39, 176, 0.6);
                filter: brightness(1.5);
            }
        }

        /* ÂàÜÊï∞ÂíåËÆ°Êó∂Âô®È´ò‰∫Æ - Âè™ÊîπÂèòz-indexÔºå‰øùÊåÅÂéüÊúâÂ∏ÉÂ±Ä */
        .score-highlight {
            z-index: 1600 !important;
            /* Á¶ÅÁî®Áº©ÊîæÂíåÂä®ÁîªÔºå‰ΩÜ‰øùÊåÅÂéüÊúâÁöÑtransform */
            animation: none !important;
            scale: none !important;
        }

        .timer-highlight {
            z-index: 1600 !important;
            /* Á¶ÅÁî®Áº©ÊîæÂíåÂä®ÁîªÔºå‰ΩÜ‰øùÊåÅÂéüÊúâÁöÑtransform */
            animation: none !important;
            scale: none !important;
        }

        /* ÈîôËØØÊëáÊëÜÂä®Áîª */
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Á°Æ‰øùÊéßÂà∂Âå∫ÂüüÂú®ËíôÁâà‰πã‰∏ä */
        .controls {
            position: relative;
            z-index: 1600;
        }

        /* Êú∫Âô®‰∫∫ÂØπËØùÁïåÈù¢Ë∑≥ËøáÊåâÈíÆ */
        .skip-conversation-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            border: 2px solid rgba(255, 107, 107, 0.6);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            z-index: 1000;
        }

        .skip-conversation-btn:hover {
            background: linear-gradient(135deg, #FF5252 0%, #F44336 100%);
            border-color: rgba(255, 82, 82, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .skip-conversation-btn::before {
            content: "‚è≠Ô∏è";
            margin-right: 5px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #dialogueText {
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            font-weight: 500;
        }

        .typing-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .typing-indicator.show {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-section {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 1000;
            /* ÁßªÈô§Âä®ÁîªÔºåÈÅøÂÖçË∑≥Âä® */
        }

        .input-bubble {
            padding: 20px;
            border-radius: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Ê≥¢Ê≥¢ÁöÑÁ≤âËâ≤ËæìÂÖ•Ê°Ü */
        .input-bubble.robot1 {
            border-color: rgba(255, 182, 193, 0.6);
            box-shadow: 0 10px 30px rgba(255, 182, 193, 0.3);
        }

        .input-bubble.robot1 #sendBtn {
            background: rgba(255, 182, 193, 0.9);
            color: #2d1b2e;
        }

        .input-bubble.robot1 #sendBtn:hover:not(:disabled) {
            background: rgba(255, 192, 203, 1);
        }

        /* ÂèØ‰πêÊñπÁöÑËìùËâ≤ËæìÂÖ•Ê°Ü */
        .input-bubble.robot2 {
            border-color: rgba(135, 206, 235, 0.6);
            box-shadow: 0 10px 30px rgba(135, 206, 235, 0.3);
        }

        .input-bubble.robot2 #sendBtn {
            background: rgba(135, 206, 235, 0.9);
            color: #1a2332;
        }

        .input-bubble.robot2 #sendBtn:hover:not(:disabled) {
            background: rgba(100, 149, 237, 1);
        }

        #playerNameInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 16px;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            transition: all 0.3s ease;
        }

        #playerNameInput:focus {
            border-color: rgba(255, 255, 255, 0.8);
            background: white;
        }

        #playerNameInput:disabled {
            background: rgba(255, 255, 255, 0.5);
            color: #999;
            cursor: not-allowed;
        }

        #playerNameInput::placeholder {
            color: #999;
        }

        #playerNameInput:disabled::placeholder {
            color: #ccc;
        }

        #sendBtn {
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        #sendBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ËØÑÂàÜËæìÂÖ•Ê°ÜÁâπÊÆäÊ†∑Âºè */

        #endInputBubble {
            /* ËØÑÂàÜËæìÂÖ•Ê°ÜÁöÑÁâπÊÆäÊ†∑ÂºèÔºåÂèÇËÄÉÂºÄÂßãÁïåÈù¢ */
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 30px;
            padding: 40px 50px;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
        }

        #endRatingInput {
            flex: 1;
            padding: 15px 25px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
        }

        #endRatingInput:focus {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(74, 144, 226, 0.6);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        #endRatingInput:disabled {
            background: rgba(255, 255, 255, 0.5);
            color: #999;
            cursor: not-allowed;
        }

        #endRatingInput::-webkit-outer-spin-button,
        #endRatingInput::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #endRatingInput[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        #endSubmitBtn {
            padding: 15px 30px;
            background: rgba(74, 144, 226, 0.9);
            color: white;
            border: 2px solid rgba(74, 144, 226, 0.7);
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        #endSubmitBtn:hover:not(:disabled) {
            background: rgba(74, 144, 226, 1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        #endSubmitBtn:disabled {
            background: rgba(200, 200, 200, 0.7);
            border-color: rgba(200, 200, 200, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ‰∏∫‰∏çÂêåÊú∫Âô®‰∫∫ÁöÑËØÑÂàÜËæìÂÖ•Ê°ÜËÆæÁΩÆ‰∏ªÈ¢òËâ≤ */
        #endInputBubble.robot1 {
            border-color: rgba(255, 182, 193, 0.6);
            box-shadow: 0 20px 60px rgba(255, 182, 193, 0.3);
        }

        #endInputBubble.robot1 #endSubmitBtn {
            background: rgba(255, 182, 193, 0.9);
            border-color: rgba(255, 182, 193, 0.7);
            color: #2d1b2e;
        }

        #endInputBubble.robot1 #endSubmitBtn:hover:not(:disabled) {
            background: rgba(255, 192, 203, 1);
            box-shadow: 0 5px 15px rgba(255, 182, 193, 0.4);
        }

        #endInputBubble.robot2 {
            border-color: rgba(135, 206, 235, 0.6);
            box-shadow: 0 20px 60px rgba(135, 206, 235, 0.3);
        }

        #endInputBubble.robot2 #endSubmitBtn {
            background: rgba(135, 206, 235, 0.9);
            border-color: rgba(135, 206, 235, 0.7);
            color: #1a2332;
        }

        #endInputBubble.robot2 #endSubmitBtn:hover:not(:disabled) {
            background: rgba(100, 149, 237, 1);
            box-shadow: 0 5px 15px rgba(135, 206, 235, 0.4);
        }
    </style>
</head>
<body>
    <!-- Âä†ËΩΩÁïåÈù¢ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-title">Á≥ñÊûúÊ∏∏Êàè</div>
        <div class="loading-container">
            <div id="loadingBar" class="loading-bar"></div>
            <div id="candyPusher" class="candy-pusher"></div>
        </div>
        <div id="loadingText" class="loading-text">Ê≠£Âú®Âä†ËΩΩÊ∏∏ÊàèËµÑÊ∫ê...</div>
        <div id="loadingPercentage" class="loading-percentage">0%</div>
    </div>

    <!-- ÂºÄÂßãËèúÂçï -->
    <div id="startMenu" class="start-menu">
        <!-- Ë£ÖÈ•∞ÂõæÁâá -->
        <img src="image/bg2.png" class="bg-center" alt="‰∏≠ÂøÉË£ÖÈ•∞">
        <img src="image/bg1.png" class="bg-bottom-right" alt="Âè≥‰∏ãË£ÖÈ•∞">
        <img src="image/bg3.png" class="bg-right" alt="Âè≥‰æßË£ÖÈ•∞">
        <img src="image/bg4.png" class="bg-left" alt="Â∑¶‰æßË£ÖÈ•∞">
        <img src="image/bg5.png" class="bg-top-left" alt="Â∑¶‰∏äË£ÖÈ•∞">

        <!-- ÊµÆÂä®Á≥ñÊûúË£ÖÈ•∞ -->
        <div class="candy-decoration" style="left: 15%; top: 20%; animation-delay: 0s;">üç≠</div>
        <div class="candy-decoration" style="right: 20%; top: 15%; animation-delay: 0.5s;">üç¨</div>
        <div class="candy-decoration" style="left: 10%; bottom: 25%; animation-delay: 1s;">üßÅ</div>
        <div class="candy-decoration" style="right: 15%; bottom: 30%; animation-delay: 1.5s;">üç™</div>
        <div class="candy-decoration" style="left: 25%; top: 60%; animation-delay: 2s;">üç∞</div>
        <div class="candy-decoration" style="right: 25%; top: 70%; animation-delay: 2.5s;">üç©</div>
        <div class="candy-decoration" style="left: 80%; top: 35%; animation-delay: 0.8s;">üç´</div>
        <div class="candy-decoration" style="left: 5%; top: 50%; animation-delay: 1.8s;">üçØ</div>

        <div class="start-menu-content">
            <div class="start-instruction-container">
                <p class="start-instruction">ÁÇπÂáª‰ªªÊÑèÂú∞ÊñπÂºÄÂßã</p>
                <div class="start-instruction-glow"></div>
            </div>

            <!-- Ë¢´ËØïÁôªÂΩïÁïåÈù¢ -->
            <div class="login-container" id="loginContainer" style="display: none;">
                <button class="skip-button" id="skipLoginBtn">Ë∑≥ËøáÊ≥®ÂÜåÔºàÂÜÖÊµãÔºâ</button>
                <div class="beta-notice">ÂÜÖÊµãÈò∂ÊÆµÂèØÁõ¥Êé•Ë∑≥Ëøá</div>
                <h2>Ë¢´ËØïÁôªÂΩïÁ≥ªÁªü</h2>

                <!-- Êü•ËØ¢ÁïåÈù¢ -->
                <div id="queryForm" class="login-form">
                    <div class="form-group">
                        <label for="queryName">ËØ∑ËæìÂÖ•ÂßìÂêçÊü•ËØ¢Êä•ÂêçÁä∂ÊÄÅÔºö</label>
                        <input type="text" id="queryName" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁúüÂÆûÂßìÂêç" maxlength="20">
                        <div class="form-hint">
                            <span class="warning">‚ö†Ô∏è</span> ËØ∑Âä°ÂøÖÊØèÊ¨°ËæìÂÖ•ÂêåÊ†∑ÁöÑÁúüÂÆûÂßìÂêçÔºå‰æø‰∫éÊü•ÊâæÂà∞Êä•Âêç‰ø°ÊÅØ
                        </div>
                    </div>
                    <div class="login-buttons">
                        <button id="queryBtn" class="login-btn primary">Êü•ËØ¢</button>
                        <button id="showRegisterBtn" class="login-btn secondary">Ê≥®ÂÜåÊñ∞Ë¥¶Âè∑</button>
                    </div>

                    <!-- Êü•ËØ¢ÁªìÊûúÊ∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
                    <div id="queryMessage" class="query-message" style="display: none;"></div>
                </div>

                <!-- Ê≥®ÂÜåÁïåÈù¢ -->
                <div id="registerForm" class="login-form" style="display: none;">
                    <div class="form-group">
                        <label for="registerName">ÁúüÂÆûÂßìÂêçÔºö</label>
                        <input type="text" id="registerName" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="registerGender">ÊÄßÂà´Ôºö</label>
                        <select id="registerGender" class="form-select">
                            <option value="">ËØ∑ÈÄâÊã©ÊÄßÂà´</option>
                            <option value="male">Áî∑</option>
                            <option value="female">Â•≥</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="registerId">Ë∫´‰ªΩËØÅÂè∑Ôºö</label>
                        <input type="text" id="registerId" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑" maxlength="18">
                    </div>
                    <div class="form-group">
                        <label for="registerAlipay">ÊîØ‰ªòÂÆùË¥¶Âè∑ÔºàÂ°´ÊâãÊú∫Âè∑ÔºâÔºö</label>
                        <input type="text" id="registerAlipay" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùÁªëÂÆöÁöÑÊâãÊú∫Âè∑" maxlength="11">
                    </div>

                    <div class="privacy-notice">
                        <span class="highlight">ÈöêÁßÅ‰øùÊä§ÊâøËØ∫Ôºö</span>Êàë‰ª¨ÊâøËØ∫‰∏ç‰ºöÊ≥ÑÈú≤ÊÇ®ÁöÑ‰∏™‰∫∫‰ø°ÊÅØÔºåÊâÄÊúâÊï∞ÊçÆ‰ªÖÁî®‰∫éÂÆûÈ™åÁ†îÁ©∂ÂíåÂ•ñÂä±ÂèëÊîæ„ÄÇËØ∑Â°´ÂÜôÁúüÂÆûÂßìÂêçÂíåÊîØ‰ªòÂÆùÁªëÂÆöÁöÑÊâãÊú∫Âè∑Ôºå‰ª•‰æøÂÆûÈ™åÁªìÊùüÂêéËΩ¨Ë¥¶Â•ñÂä±„ÄÇ
                    </div>

                    <div class="login-buttons">
                        <button id="registerBtn" class="login-btn primary">Ê≥®ÂÜå</button>
                        <button id="backToQueryBtn" class="login-btn secondary">ËøîÂõûÊü•ËØ¢</button>
                        <button id="viewUsersBtn" class="login-btn secondary">Êü•ÁúãÁî®Êà∑ÂàóË°®</button>
                    </div>

                    <!-- Ê≥®ÂÜåÁªìÊûúÊ∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
                    <div id="registerMessage" class="query-message" style="display: none;"></div>
                </div>
            </div>

            <!-- Áî®Êà∑ÂàóË°®Ê®°ÊÄÅÊ°Ü -->
            <div id="userListModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Áî®Êà∑ÂàóË°®</h3>
                        <span class="close" id="closeUserListModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="userListContent">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩÁî®Êà∑ÂàóË°®...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="robot-selection" id="robotSelection" style="display: none;">
                <h2>ÈÄâÊã©‰Ω†ÁöÑÂêà‰Ωú‰ºô‰º¥</h2>
                <p class="selection-notice">‚ö†Ô∏è Ê≥®ÊÑèÔºöËØ∑ËÆ§ÁúüÈÄâÊã©ÔºåÈô§ÈùûÊÑèÂ§ñÊÉÖÂÜµ‰∏çËÉΩÊõ¥Êç¢Êú∫Âô®‰∫∫‰ºô‰º¥Âì¶</p>
                <div class="robot-options">
                    <div class="robot-option" data-robot="robot1">
                        <video src="image/robot_1.webm" alt="Ê≥¢Ê≥¢" muted style="width: 240px; height: 240px; border-radius: 15px;"></video>
                        <div class="robot-text-container">
                            <div class="robot-name">ÂúÜÊªöÊªöÊé¢Èô©ÂÆ∂‚Äî‚Äî"Ê≥¢Ê≥¢"</div>
                            <div class="robot-description">Ê≥¢Ê≥¢ÊòØÈì∂Ê≤≥Á≥ñÊûúÂçè‰ºöÁöÑ"Á§æ‰∫§ÊãÖÂΩì"ÔºåÊÄªÊòØÁî®Ê∏©ÊöñÁöÑÁ¨ëÂÆπÂíåÂè§ÁÅµÁ≤æÊÄ™ÁöÑËØùËØ≠‰∏∫Èòü‰ºçÂ∏¶Êù•ËΩªÊùæÊ∞õÂõ¥„ÄÇÂÆÉÂúÜÊªöÊªöÁöÑË∫´‰ΩìËÆ©ÂÆÉÊó†ËÆ∫Ëµ∞Âà∞Âì™ÈÉΩÂÉè‰∏ÄÈ¢óÂπ∏Á¶èÁ≥ñÔºåÂºπË∑≥Èó¥ÂÖÖÊª°ËÉΩÈáè‰∏éÂ•ΩÂ•áÂøÉ„ÄÇÊó†ËÆ∫ÊòØÂú®ÈôåÁîüÊòüÁêÉËøòÊòØÁîúËúúÁ≥ñÂéüÔºåÊ≥¢Ê≥¢ÊÄªËÉΩÂèëÁé∞Êñ∞È≤úÊúâË∂£ÁöÑ‰∫ãÁâ©„ÄÇ<br><div class="speech-bubble">"Âø´ÁÇπÂø´ÁÇπÔºåËøôÈ¢óÁ≥ñÁúãËµ∑Êù•Â•ΩÂ•ΩÁé©ÔºÅ"</div></div>
                        </div>
                    </div>
                    <div class="robot-option" data-robot="robot2">
                        <video src="image/robot_2.webm" alt="‰∏âËßíÂêõ" muted style="width: 200px; height: auto; border-radius: 15px;"></video>
                        <div class="robot-text-container">
                            <div class="robot-name">ÊñπËÑëË¢ãÂèëÊòéÂÆ∂‚Äî‚Äî"ÂèØ‰πêÊñπ"</div>
                            <div class="robot-description">ÂèØ‰πêÊñπÊòØÁ≥ñÊûúÁéãÂõΩÈáåÁöÑË∂ÖÁ∫ßÂèëÊòéÂÆ∂ÔºåÁÉ≠Ë°∑Áî®Á®ÄÂ•áÂè§ÊÄ™ÁöÑÈõ∂‰ª∂ÈÄ†Âá∫Êõ¥Á®ÄÂ•áÁöÑÂ∞èÂ∑•ÂÖ∑„ÄÇÊúâ‰∫∫ËØ¥ÂÆÉÂ§¥‰∏äÁöÑ‰∏âËßíÂ∏ΩÂÖ∂ÂÆûÊòØÁÅµÊÑüÊé•Êî∂Âô®ÔºåËÉΩÊçïÊçâÊù•Ëá™Âπ≥Ë°åÂÆáÂÆôÁöÑÂàõÊÑèÊ≥¢ÊÆµ„ÄÇËôΩÁÑ∂Â§ñË°®ÂÉè‰∏ÄÂè∞Â§çÂè§ÁîµËßÜÊú∫Ôºå‰ΩÜÂÜÖËäØËøêË°åÁöÑÈÉΩÊòØÈ¢ÜÂÖà300Âπ¥ÁöÑÁÇπÂ≠ê„ÄÇ<br><div class="speech-bubble">"Êô∫ÊÖßÈó™ÂÖâÔºåÁ≥ñÊûúË°åÂä®ÔºÅ"</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢ -->
    <div id="robotIntroduction" class="robot-introduction" style="display: none;">
        <button class="skip-conversation-btn" id="skipConversationBtn">Ë∑≥ËøáÂØπËØù</button>
        <div class="conversation-container">
            <div class="main-conversation">
                <div class="robot-section">
                    <div class="robot-name-label" id="robotNameLabel">Ê≥¢Ê≥¢</div>
                    <div class="robot-character">
                        <video id="selectedRobotVideo" muted autoplay style="width: 300px; height: 300px; border-radius: 20px; object-fit: cover; background: rgba(255, 255, 255, 0.1);"></video>
                    </div>
                </div>

                <div class="dialogue-section">
                    <div class="dialogue-bubble" id="speechBubble">
                        <div id="dialogueText">Ê≥¢Ê≥¢Ë¶ÅËØ¥ÁöÑËØù....</div>
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®Âõ∫ÂÆöËæìÂÖ•Ê°Ü -->
        <div class="input-section" id="inputSection">
            <div class="input-bubble">
                <input type="text" id="playerNameInput" placeholder="Êú∫Âô®‰∫∫Ê≠£Âú®‰ªãÁªç‰∏≠ÔºåËØ∑Á®çÁ≠â..." maxlength="20" disabled>
                <button id="sendBtn" disabled>ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Ê∏∏ÊàèËßÑÂàôËíôÁâà -->
        <div class="game-rules-mask" id="gameRulesMask" style="display: none;"></div>

        <!-- Êú∫Âô®‰∫∫ËßÑÂàôËØ¥Êòé -->
        <div class="rules-robot-guide" id="rulesRobotGuide" style="display: none;">
            <div class="rules-robot-container">
                <video class="rules-robot-video" id="rulesRobotVideo" muted autoplay></video>
                <div class="rules-robot-name" id="rulesRobotName">Ê≥¢Ê≥¢</div>
            </div>

            <div class="rules-speech-bubble" id="rulesSpeechBubble">
                <div id="rulesText">
                    <span id="demoStep">ËÆ©ÊàëÊù•‰ªãÁªçÊ∏∏ÊàèËßÑÂàô...</span>
                </div>

                <div class="rules-controls" id="rulesControls">
                    <button class="rules-btn secondary" id="skipRulesBtn">Ë∑≥ËøáËØ¥Êòé</button>
                    <button class="rules-btn secondary" id="prevStepBtn" style="display: none;">‰∏ä‰∏ÄÊ≠•</button>
                    <button class="rules-btn primary" id="nextStepBtn">‰∏ã‰∏ÄÊ≠•</button>
                    <button class="rules-btn primary" id="startGameBtn" style="display: none;">ÂºÄÂßãÊ∏∏Êàè</button>
                </div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer-bar-container">
                <div class="timer-bar" id="timerBar"></div>
                <div class="timer-text" id="timeLeft">5:00</div>
            </div>
        </div>

        <div class="score">
            ÂæóÂàÜ: <span id="score">0</span>
        </div>

        <div class="game-grid" id="gameGrid">
            <!-- 8x5 = 40 cells will be generated by JavaScript -->
        </div>

        <div class="controls">
        <div class="control-layout">
            <!-- ÊâãÂä®ÊéßÂà∂Âå∫Âüü -->
            <div class="manual-controls">
                <div class="control-group">
                    <div class="candy-icon" style="background-image: url('image/red.png');"></div>
                    <div class="key-display" data-key="q">Q</div>
                </div>
                <div class="control-group">
                    <div class="candy-icon green" style="background-image: url('image/light_green.png') !important; background-size: contain !important; background-repeat: no-repeat !important; background-position: center !important;"></div>
                    <div class="key-display" data-key="w">W</div>
                </div>
                <div class="control-group">
                    <div class="candy-icon" style="background-image: url('image/pink.png');"></div>
                    <div class="key-display" data-key="e">E</div>
                </div>
                <div style="width: 30px;"></div> <!-- Á©∫ÁôΩÈó¥Ë∑ù -->
            </div>

            <!-- ‰∫∫Áâ©ËßíËâ≤ -->
            <div class="character">
                <img id="humanImg" src="image/human.png" alt="‰Ω†">
            </div>

            <!-- ÈîÆÁõòÂõæÊ†á -->
            <div class="keyboard-icon">
                <div class="keyboard">
                    <!-- FÂäüËÉΩÈîÆË°å -->
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-esc"></div>
                        <div class="keyboard-key" id="kb-key-f1"></div>
                        <div class="keyboard-key" id="kb-key-f2"></div>
                        <div class="keyboard-key" id="kb-key-f3"></div>
                        <div class="keyboard-key" id="kb-key-f4"></div>
                        <div class="keyboard-key" id="kb-key-f5"></div>
                        <div class="keyboard-key" id="kb-key-f6"></div>
                        <div class="keyboard-key" id="kb-key-f7"></div>
                        <div class="keyboard-key" id="kb-key-f8"></div>
                        <div class="keyboard-key" id="kb-key-f9"></div>
                        <div class="keyboard-key" id="kb-key-f10"></div>
                        <div class="keyboard-key" id="kb-key-f11"></div>
                        <div class="keyboard-key" id="kb-key-f12"></div>
                        <div class="keyboard-key" id="kb-key-prtsc"></div>
                        <div class="keyboard-key" id="kb-key-scroll"></div>
                        <div class="keyboard-key" id="kb-key-pause"></div>
                    </div>
                    <!-- Êï∞Â≠óË°å -->
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-grave"></div>
                        <div class="keyboard-key" id="kb-key-1"></div>
                        <div class="keyboard-key" id="kb-key-2"></div>
                        <div class="keyboard-key" id="kb-key-3"></div>
                        <div class="keyboard-key" id="kb-key-4"></div>
                        <div class="keyboard-key" id="kb-key-5"></div>
                        <div class="keyboard-key" id="kb-key-6"></div>
                        <div class="keyboard-key" id="kb-key-main7"></div>
                        <div class="keyboard-key" id="kb-key-main8"></div>
                        <div class="keyboard-key" id="kb-key-main9"></div>
                        <div class="keyboard-key" id="kb-key-0"></div>
                        <div class="keyboard-key" id="kb-key-minus"></div>
                        <div class="keyboard-key" id="kb-key-equals"></div>
                        <div class="keyboard-key" id="kb-key-backspace"></div>
                        <div class="keyboard-key" id="kb-key-ins"></div>
                        <div class="keyboard-key" id="kb-key-home"></div>
                        <div class="keyboard-key" id="kb-key-pgup"></div>
                        <div class="keyboard-key" id="kb-key-numlock"></div>
                        <div class="keyboard-key" id="kb-key-divide"></div>
                        <div class="keyboard-key" id="kb-key-multiply"></div>
                        <div class="keyboard-key" id="kb-key-subtract"></div>
                    </div>
                    <!-- QWERTYË°å -->
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-tab"></div>
                        <div class="keyboard-key" id="kb-key-q"></div>
                        <div class="keyboard-key" id="kb-key-w"></div>
                        <div class="keyboard-key" id="kb-key-e"></div>
                        <div class="keyboard-key" id="kb-key-r"></div>
                        <div class="keyboard-key" id="kb-key-t"></div>
                        <div class="keyboard-key" id="kb-key-y"></div>
                        <div class="keyboard-key" id="kb-key-u"></div>
                        <div class="keyboard-key" id="kb-key-i"></div>
                        <div class="keyboard-key" id="kb-key-o"></div>
                        <div class="keyboard-key" id="kb-key-p"></div>
                        <div class="keyboard-key" id="kb-key-bracket1"></div>
                        <div class="keyboard-key" id="kb-key-bracket2"></div>
                        <div class="keyboard-key" id="kb-key-backslash"></div>
                        <div class="keyboard-key" id="kb-key-del"></div>
                        <div class="keyboard-key" id="kb-key-end"></div>
                        <div class="keyboard-key" id="kb-key-pgdn"></div>
                        <div class="keyboard-key" id="kb-key-7"></div>
                        <div class="keyboard-key" id="kb-key-8"></div>
                        <div class="keyboard-key" id="kb-key-9"></div>
                        <div class="keyboard-key" id="kb-key-plus"></div>
                    </div>
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-caps"></div>
                        <div class="keyboard-key" id="kb-key-a"></div>
                        <div class="keyboard-key" id="kb-key-s"></div>
                        <div class="keyboard-key" id="kb-key-d"></div>
                        <div class="keyboard-key" id="kb-key-f"></div>
                        <div class="keyboard-key" id="kb-key-g"></div>
                        <div class="keyboard-key" id="kb-key-h"></div>
                        <div class="keyboard-key" id="kb-key-j"></div>
                        <div class="keyboard-key" id="kb-key-k"></div>
                        <div class="keyboard-key" id="kb-key-l"></div>
                        <div class="keyboard-key" id="kb-key-semicolon"></div>
                        <div class="keyboard-key" id="kb-key-quote"></div>
                        <div class="keyboard-key" id="kb-key-enter"></div>
                        <div class="keyboard-key" id="kb-key-4"></div>
                        <div class="keyboard-key" id="kb-key-5"></div>
                        <div class="keyboard-key" id="kb-key-6"></div>
                    </div>
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-shift1"></div>
                        <div class="keyboard-key" id="kb-key-z"></div>
                        <div class="keyboard-key" id="kb-key-x"></div>
                        <div class="keyboard-key" id="kb-key-c"></div>
                        <div class="keyboard-key" id="kb-key-v"></div>
                        <div class="keyboard-key" id="kb-key-b"></div>
                        <div class="keyboard-key" id="kb-key-n"></div>
                        <div class="keyboard-key" id="kb-key-m"></div>
                        <div class="keyboard-key" id="kb-key-comma"></div>
                        <div class="keyboard-key" id="kb-key-period"></div>
                        <div class="keyboard-key" id="kb-key-slash"></div>
                        <div class="keyboard-key" id="kb-key-shift2"></div>
                        <div class="keyboard-key" id="kb-key-up"></div>
                        <div class="keyboard-key" id="kb-key-1"></div>
                        <div class="keyboard-key" id="kb-key-2"></div>
                        <div class="keyboard-key" id="kb-key-3"></div>
                        <div class="keyboard-key" id="kb-key-numenter"></div>
                    </div>
                    <!-- Â∫ïÈÉ®ÂäüËÉΩÈîÆË°å -->
                    <div class="keyboard-row">
                        <div class="keyboard-key" id="kb-key-ctrl1"></div>
                        <div class="keyboard-key" id="kb-key-win"></div>
                        <div class="keyboard-key" id="kb-key-alt1"></div>
                        <div class="keyboard-key keyboard-spacebar" id="kb-key-space"></div>
                        <div class="keyboard-key" id="kb-key-alt2"></div>
                        <div class="keyboard-key" id="kb-key-win2"></div>
                        <div class="keyboard-key" id="kb-key-menu"></div>
                        <div class="keyboard-key" id="kb-key-ctrl2"></div>
                        <div class="keyboard-key" id="kb-key-left"></div>
                        <div class="keyboard-key" id="kb-key-down"></div>
                        <div class="keyboard-key" id="kb-key-right"></div>
                        <div class="keyboard-key" id="kb-key-0"></div>
                        <div class="keyboard-key" id="kb-key-numdot"></div>
                    </div>
                </div>
            </div>

            <!-- Êú∫Âô®‰∫∫ËßíËâ≤ -->
            <div class="character" id="robotCharacter">
                <img id="robotImg" src="image/robot.png" alt="Êú∫Âô®‰∫∫">
            </div>

            <!-- Ëá™Âä®ÊéßÂà∂Âå∫Âüü -->
            <div class="auto-controls">
                <div style="width: 30px;"></div> <!-- Â∑¶‰æßÁ©∫ÁôΩÈó¥Ë∑ù -->
                <div class="control-group">
                    <div class="candy-icon" style="background-image: url('image/blue.png');"></div>
                    <div class="key-display" data-key="7">7</div>
                </div>
                <div class="control-group">
                    <div class="candy-icon" style="background-image: url('image/yellow.png');"></div>
                    <div class="key-display" data-key="8">8</div>
                </div>
                <div class="control-group">
                    <div class="candy-icon" style="background-image: url('image/deep_green.png');"></div>
                    <div class="key-display" data-key="9">9</div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="countdown" class="countdown" style="display: none;"></div>

    <!-- ËÉåÊôØÈü≥‰πê -->
    <audio id="bgMusic" loop autoplay muted>
        <source src="image/bgm.mp3" type="audio/mpeg">
    </audio>

    <!-- Èü≥ÈáèÊéßÂà∂ÊåâÈíÆ -->
    <div id="volumeControl" class="volume-control">
        <button id="volumeBtn" class="volume-btn">üîä</button>
    </div>

    <!-- Êï∞ÊçÆÊµãËØïÊåâÈíÆÔºà‰ªÖÁî®‰∫éÂºÄÂèëÊµãËØïÔºâ -->
    <div id="dataTestControl" style="position: fixed; top: 10px; left: 10px; z-index: 10000; display: none;">
        <button id="testDataBtn" style="
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        ">üìä Êü•ÁúãÊï∞ÊçÆ</button>
    </div>

    <!-- ÂÜÖÊµãË∑≥ËøáÊåâÈíÆ -->
    <div id="skipButton" style="display: none;">
        <button id="skipBtn" class="skip-btn">Ë∑≥Ëøá (ÂÜÖÊµã)</button>
    </div>

    <!-- ÂÖ®Â±èÊèêÁ§∫ÂºπÁ™ó -->
    <div id="fullscreenPrompt" class="fullscreen-prompt" style="display: none;">
        <div class="fullscreen-dialog">
            <h2>üéÆ Á≥ñÊûú‰∏ñÁïåÂ§ßÂÜíÈô©</h2>
            <p>‰∏∫‰∫ÜËé∑ÂæóÊúÄ‰Ω≥Ê∏∏Êàè‰ΩìÈ™åÂíåÈü≥ÊïàÊïàÊûúÔºåÂª∫ËÆÆÊÇ®Ôºö</p>
            <p><strong>üì± ËøõÂÖ•ÂÖ®Â±èÊ®°Âºè</strong></p>
            <p>ËøôÊ†∑ÂèØ‰ª•ËÆ©ÊÇ®ÂÆåÂÖ®Ê≤âÊµ∏Âú®Ê∏∏Êàè‰∏ñÁïå‰∏≠ÔºÅ</p>
            <div class="fullscreen-buttons">
                <button id="enterFullscreenBtn" class="fullscreen-btn primary">ËøõÂÖ•ÂÖ®Â±è</button>
                <button id="skipFullscreenBtn" class="fullscreen-btn secondary">Ë∑≥Ëøá</button>
            </div>
        </div>
    </div>

    <!-- ÁªìÂ∞æËØÑ‰ª∑ÂØπËØùÁïåÈù¢ -->
    <div id="endGameDialog" class="robot-introduction" style="display: none;">
        <div class="conversation-container">
            <div class="main-conversation">
                <div class="robot-section">
                    <div class="robot-name-label" id="endRobotNameLabel">Ê≥¢Ê≥¢</div>
                    <video id="endRobotVideo" class="robot-video" autoplay muted loop>
                        <source src="image/robot_1.webm" type="video/webm">
                    </video>
                </div>
                <div class="dialogue-section">
                    <div class="dialogue-bubble" id="endSpeechBubble">
                        <div class="typing-indicator" id="endTypingIndicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <div class="dialogue-text" id="endDialogueText"></div>
                    </div>
                    <!-- ÈóÆÈ¢òÊèêÁ§∫‰ø°ÊÅØ -->
                    <div id="endQuestionTips" style="margin-top: 15px; padding: 10px 20px; background: rgba(255, 255, 255, 0.8); border-radius: 15px; font-size: 14px; color: #666; text-align: center; display: none;">
                        üí° ËØ∑ËæìÂÖ•1-10Ôºå<span id="tipLowScore">1</span> - <span id="tipHighScore">10</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁªìÂ∞æËØÑÂàÜËæìÂÖ•Ê°Ü -->
        <div class="input-section" id="endInputSection">
            <div class="input-bubble" id="endInputBubble">
                <input type="number" id="endRatingInput" placeholder="ËØ∑ËæìÂÖ•Êï∞Â≠ó" min="1" max="10" disabled>
                <button id="endSubmitBtn" disabled>ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>

    <script>
        class CandyGame {
            constructor() {
                this.grid = [];
                this.score = 0;
                this.colors = ['red', 'green', 'pink', 'blue', 'yellow', 'darkgreen'];
                this.keyMap = {
                    'q': 'red',
                    'w': 'green',
                    'e': 'pink',
                    '7': 'blue',
                    '8': 'yellow',
                    '9': 'darkgreen'
                };
                this.manualColors = ['red', 'green', 'pink']; // ÈúÄË¶ÅÊâãÂä®ÊåâÈîÆÁöÑÈ¢úËâ≤
                this.autoColors = ['blue', 'yellow', 'darkgreen']; // Ëá™Âä®ÁÇπÂáªÁöÑÈ¢úËâ≤
                this.currentCandy = null; // ÂΩìÂâçÁ≥ñÊûú‰ø°ÊÅØ {index, color, spawnTime}
                this.gameStarted = false;
                this.audioContext = null;
                this.autoClickTimeout = null; // Ëá™Âä®ÁÇπÂáªÂÆöÊó∂Âô®
                this.gameTimer = null; // Ê∏∏ÊàèËÆ°Êó∂Âô®
                this.timeLeft = 300; // 5ÂàÜÈíü = 300Áßí
                this.selectedRobot = 'robot1'; // ÈªòËÆ§ÈÄâÊã©Êú∫Âô®‰∫∫1
                this.playerName = ''; // Áé©ÂÆ∂ÂêçÂ≠ó
                this.menuState = 'start'; // 'start', 'login', 'robotSelection', 'robotIntro', 'game'
                this.userInfo = null; // Áî®Êà∑‰ø°ÊÅØ

                // APIÈõÜÊàê
                this.apiClient = window.apiClient;
                this.gameSession = null; // ÂΩìÂâçÊ∏∏Êàè‰ºöËØù
                this.gameStartTime = null; // Ê∏∏ÊàèÂºÄÂßãÊó∂Èó¥

                // Êú¨Âú∞ÊµãËØïÊ®°Âºè
                this.localTestMode = window.LOCAL_TEST_MODE || false;
                if (this.localTestMode) {
                    console.log('üîß Ê∏∏ÊàèËøêË°åÂú®Êú¨Âú∞ÊµãËØïÊ®°Âºè');
                }
                this.registeredUsers = [
                    // Ê®°ÊãüÂ∑≤Ê≥®ÂÜåÁî®Êà∑Êï∞ÊçÆÂ∫ì
                    {
                        name: 'Â∞èÊòé',
                        gender: 'male',
                        idNumber: '110101199001011234',
                        alipay: 'xiaoming@example.com',
                        selectedRobot: 'robot1', // ÈÄâÊã©ÁöÑÊú∫Âô®‰∫∫‰ºô‰º¥
                        dayCount: 3, // Á¨¨Âá†Â§©ÂÅö‰ªªÂä°
                        registrationDate: '2024-01-15'
                    }
                ];
                this.demoStep = 0; // ÊºîÁ§∫Ê≠•È™§
                this.demoInProgress = false; // ÊºîÁ§∫ÊòØÂê¶ËøõË°å‰∏≠
                this.introStep = 0; // ‰ªãÁªçÊ≠•È™§
                this.bgMusic = null; // ËÉåÊôØÈü≥‰πê
                this.isMuted = false; // ÊòØÂê¶ÈùôÈü≥

                // Êï∞ÊçÆËÆ∞ÂΩïÁ≥ªÁªü
                this.gameData = {
                    sessionId: this.generateSessionId(),
                    startTime: new Date().toISOString(),
                    userInfo: null,
                    selectedRobot: null,
                    gameEvents: [],
                    finalScore: 0,
                    userRating: null,
                    endTime: null
                };

                this.init();
            }

            // ÁîüÊàêÂîØ‰∏ÄÁöÑ‰ºöËØùID
            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂
            recordGameEvent(eventType, eventData) {
                const event = {
                    timestamp: new Date().toISOString(),
                    eventType: eventType,
                    ...eventData
                };
                this.gameData.gameEvents.push(event);
                console.log('ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂:', event);
            }

            // Âà§Êñ≠Á≥ñÊûú‰ΩçÁΩÆÊòØÂ∑¶ËæπËøòÊòØÂè≥Ëæπ
            getCandyPosition(index) {
                // 8x5ÁΩëÊ†ºÔºåindex 0-39
                // Â∑¶Ëæπ4ÂàóÔºöindex % 8 < 4
                // Âè≥Ëæπ4ÂàóÔºöindex % 8 >= 4
                const col = index % 8;
                return col < 4 ? 'Â∑¶' : 'Âè≥';
            }

            // ‰∏ãËΩΩCSVÊï∞ÊçÆ
            downloadCSV() {
                const csvData = this.generateCSVData();
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `candy_game_data_${this.gameData.sessionId}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // ÁîüÊàêCSVÊï∞ÊçÆ
            generateCSVData() {
                let csv = '';

                // Ê∑ªÂä†Âü∫Êú¨‰ø°ÊÅØ
                csv += 'Âü∫Êú¨‰ø°ÊÅØ\n';
                csv += '‰ºöËØùID,' + this.gameData.sessionId + '\n';
                csv += 'ÂºÄÂßãÊó∂Èó¥,' + this.gameData.startTime + '\n';
                csv += 'ÁªìÊùüÊó∂Èó¥,' + (this.gameData.endTime || '') + '\n';
                csv += 'Áî®Êà∑ÂßìÂêç,' + (this.gameData.userInfo?.name || '') + '\n';
                csv += 'Áî®Êà∑ÊÄßÂà´,' + (this.gameData.userInfo?.gender || '') + '\n';
                csv += 'Ë∫´‰ªΩËØÅÂè∑,' + (this.gameData.userInfo?.idNumber || '') + '\n';
                csv += 'ÊîØ‰ªòÂÆùË¥¶Âè∑,' + (this.gameData.userInfo?.alipay || '') + '\n';
                csv += 'ÈÄâÊã©ÁöÑÊú∫Âô®‰∫∫,' + (this.gameData.selectedRobot || '') + '\n';
                csv += 'ÊúÄÁªàÂæóÂàÜ,' + this.gameData.finalScore + '\n';
                csv += 'Áî®Êà∑Âπ≥ÂùáËØÑÂàÜ,' + (this.gameData.userRating || '') + '\n';
                csv += '\n';

                // Ê∑ªÂä†ËØ¶ÁªÜËØÑ‰ª∑Êï∞ÊçÆ
                if (this.gameData.evaluationRatings) {
                    csv += 'ËØ¶ÁªÜËØÑ‰ª∑Êï∞ÊçÆ\n';
                    csv += 'ËØÑ‰ª∑È°πÁõÆ,ËØÑÂàÜ(1-10ÂàÜ)\n';
                    csv += '‰∫´Âèó‰∏éÊú∫Âô®‰∫∫Ê∏∏ÊàèÁ®ãÂ∫¶,' + (this.gameData.evaluationRatings.enjoyment || '') + '\n';
                    csv += 'Êú∫Âô®‰∫∫Êèê‰æõÂ∏ÆÂä©Á®ãÂ∫¶,' + (this.gameData.evaluationRatings.helpfulness || '') + '\n';
                    csv += 'ÂæóÂàÜÂØπÊú∫Âô®‰∫∫‰æùËµñÁ®ãÂ∫¶,' + (this.gameData.evaluationRatings.dependency || '') + '\n';
                    csv += 'Áî®Êà∑Âá∫ÈîôÈ¢ëÁéá,' + (this.gameData.evaluationRatings.user_error_frequency || '') + '\n';
                    csv += 'Êú∫Âô®‰∫∫Âá∫ÈîôÈ¢ëÁéá,' + (this.gameData.evaluationRatings.robot_error_frequency || '') + '\n';
                    csv += '\n';
                }

                // Ê∑ªÂä†Ê∏∏Êàè‰∫ã‰ª∂Ë°®Â§¥
                csv += 'Ê∏∏Êàè‰∫ã‰ª∂ËØ¶ÊÉÖ\n';
                csv += 'Êó∂Èó¥Êà≥,‰∫ã‰ª∂Á±ªÂûã,Á≥ñÊûúÈ¢úËâ≤,Á≥ñÊûú‰ΩçÁΩÆ(Â∑¶/Âè≥),Á≥ñÊûúÁΩëÊ†ºÁ¥¢Âºï,ÊåâÈîÆ,ÂèçÂ∫îÊó∂Èó¥(ms),ÂæóÂàÜÂèòÂåñ,ÊòØÂê¶Ê≠£Á°Æ,ÂΩìÂâçÊÄªÂàÜ\n';

                // Ê∑ªÂä†Ê∏∏Êàè‰∫ã‰ª∂Êï∞ÊçÆ
                this.gameData.gameEvents.forEach(event => {
                    csv += event.timestamp + ',';
                    csv += event.eventType + ',';
                    csv += (event.candyColor || '') + ',';
                    csv += (event.candyPosition || '') + ',';
                    csv += (event.candyIndex !== undefined ? event.candyIndex : '') + ',';
                    csv += (event.keyPressed || '') + ',';
                    csv += (event.reactionTime !== undefined ? event.reactionTime : '') + ',';
                    csv += (event.scoreChange !== undefined ? event.scoreChange : '') + ',';
                    csv += (event.isCorrect !== undefined ? (event.isCorrect ? 'Ê≠£Á°Æ' : 'ÈîôËØØ') : '') + ',';
                    csv += (event.currentScore !== undefined ? event.currentScore : '') + '\n';
                });

                return csv;
            }

            init() {
                this.createGrid();
                this.initAudio();
                this.initBackgroundMusic();
                this.bindMenuEvents();
                this.bindControlEvents();
                // Ê∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÂàùÂßãÂåñ‰ºöÂú®ÈÄâÊã©Êú∫Âô®‰∫∫ÂêéËøõË°å
            }

            bindMenuEvents() {
                const startMenu = document.getElementById('startMenu');
                const startInstruction = document.querySelector('.start-instruction');
                const loginContainer = document.getElementById('loginContainer');
                const robotSelection = document.getElementById('robotSelection');
                const robotOptions = document.querySelectorAll('.robot-option');

                // ÁÇπÂáª‰ªªÊÑèÂú∞ÊñπÂºÄÂßã - ËøõÂÖ•ÁôªÂΩïÁïåÈù¢
                startMenu.addEventListener('click', (e) => {
                    // Âè™ÊúâÂú®ÂºÄÂßãÁïåÈù¢Áä∂ÊÄÅ‰∏ãÊâçÂìçÂ∫îÁÇπÂáª
                    if (this.menuState === 'start') {
                        // ÈöêËóèË∑≥ËøáÊåâÈíÆ
                        document.getElementById('skipButton').style.display = 'none';

                        const bgCenter = document.querySelector('.bg-center');
                        startInstruction.style.display = 'none';
                        bgCenter.style.display = 'none'; // ÈöêËóèbg2
                        loginContainer.style.display = 'block';
                        loginContainer.style.transform = 'translate(-50%, -50%)'; // Áõ¥Êé•Â±Ö‰∏≠ÊòæÁ§∫
                        this.menuState = 'login';
                    }
                });

                // ÁªëÂÆöÁôªÂΩïÁïåÈù¢‰∫ã‰ª∂
                this.bindLoginEvents();

                // ‰∏∫robot1Ê∑ªÂä†Âõ¥ÁªïÁöÑlogoË£ÖÈ•∞
                this.createLogoDecoration();

                // Á´ãÂç≥Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑlogo‰ΩçÁΩÆ
                this.updateExistingLogos();

                // ÈÄâÊã©Êú∫Âô®‰∫∫
                robotOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectedRobot = option.dataset.robot;

                        // ‰øùÂ≠òÁî®Êà∑ÁöÑÊú∫Âô®‰∫∫ÈÄâÊã©Âà∞Áî®Êà∑Êï∞ÊçÆ‰∏≠
                        if (this.userInfo) {
                            this.userInfo.selectedRobot = this.selectedRobot;

                            // Êõ¥Êñ∞Ê≥®ÂÜåÁî®Êà∑Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑ‰ø°ÊÅØ
                            const userIndex = this.registeredUsers.findIndex(u => u.name === this.userInfo.name);
                            if (userIndex !== -1) {
                                this.registeredUsers[userIndex].selectedRobot = this.selectedRobot;
                            }
                        }

                        // ËÆ∞ÂΩïÊú∫Âô®‰∫∫ÈÄâÊã©Âà∞Êï∞ÊçÆÁ≥ªÁªü
                        this.gameData.selectedRobot = this.selectedRobot;
                        this.recordGameEvent('robot_selection', {
                            selectedRobot: this.selectedRobot,
                            robotName: this.selectedRobot === 'robot1' ? 'Ê≥¢Ê≥¢' : 'ÂèØ‰πêÊñπ',
                            userName: this.userInfo?.name || 'Êú™Áü•Áî®Êà∑'
                        });

                        this.showRobotIntroduction();
                    });

                    // Èº†Ê†áÊÇ¨ÂÅúÊí≠ÊîæËßÜÈ¢ëÔºàÂØπÊâÄÊúâÊú∫Âô®‰∫∫Ôºâ
                    const video = option.querySelector('video');
                    if (video) {
                        console.log('ÁªëÂÆöËßÜÈ¢ëÊÇ¨ÂÅú‰∫ã‰ª∂', option.dataset.robot, video);

                        // Á°Æ‰øùËßÜÈ¢ëÂàùÂßãÁä∂ÊÄÅÊòØÊöÇÂÅúÁöÑ
                        video.pause();
                        video.currentTime = 0;
                        video.muted = true;

                        option.addEventListener('mouseenter', () => {
                            console.log('Èº†Ê†áËøõÂÖ•', option.dataset.robot);
                            if (video) {
                                console.log('ÊâæÂà∞ËßÜÈ¢ëÂÖÉÁ¥†ÔºåÂáÜÂ§áÊí≠Êîæ');
                                video.currentTime = 0; // ÈáçÁΩÆÂà∞ÂºÄÂßã
                                video.muted = false; // ÂèñÊ∂àÈùôÈü≥

                                // Â∞ùËØïÊí≠ÊîæËßÜÈ¢ë
                                const playPromise = video.play();
                                if (playPromise !== undefined) {
                                    playPromise.then(() => {
                                        console.log('ËßÜÈ¢ëÊí≠ÊîæÊàêÂäü');
                                    }).catch(e => {
                                        console.error('ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
                                        // Â¶ÇÊûúËá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÂ∞ùËØïÈùôÈü≥Êí≠Êîæ
                                        video.muted = true;
                                        video.play().then(() => {
                                            console.log('ÈùôÈü≥Êí≠ÊîæÊàêÂäü');
                                        }).catch(err => {
                                            console.error('ÈùôÈü≥Êí≠Êîæ‰πüÂ§±Ë¥•:', err);
                                        });
                                    });
                                }
                            } else {
                                console.error('Êú™ÊâæÂà∞ËßÜÈ¢ëÂÖÉÁ¥†');
                            }
                        });

                        option.addEventListener('mouseleave', () => {
                            console.log('Èº†Ê†áÁ¶ªÂºÄ', option.dataset.robot);
                            if (video) {
                                video.pause();
                                video.currentTime = 0; // ÈáçÁΩÆÂà∞ÂºÄÂ§¥ÔºåÂáÜÂ§á‰∏ãÊ¨°Êí≠Êîæ
                                console.log('ËßÜÈ¢ëÂ∑≤ÊöÇÂÅúÂπ∂ÈáçÁΩÆÂà∞ÂºÄÂ§¥');
                            }
                        });
                    }
                });
            }

            updateExistingLogos() {
                // Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑlogo‰ΩçÁΩÆ
                const existingLogos = document.querySelectorAll('.robot1-logo-decoration, .robot2-logo-decoration');
                existingLogos.forEach(logo => {
                    logo.style.cssText = `
                        margin-left: 8px;
                        width: 24px;
                        height: auto;
                        animation: float 2s ease-in-out infinite;
                        animation-delay: 1s;
                        display: inline-block;
                        vertical-align: middle;
                        position: relative;
                        top: 6px;
                        z-index: 10;
                    `;
                });
            }

            // ÊòæÁ§∫Êü•ËØ¢Ê∂àÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
            showQueryMessage(message, type = 'info', userInfo = null, onConfirm = null) {
                const messageDiv = document.getElementById('queryMessage');
                messageDiv.className = `query-message ${type}`;

                if (userInfo && type === 'success') {
                    // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÁî®Êà∑‰ø°ÊÅØ
                    const robotName = userInfo.selectedRobot === 'robot1' ? 'Ê≥¢Ê≥¢' : 'ÂèØ‰πêÊñπ';
                    messageDiv.innerHTML = `
                        <div class="user-info">
                            <div style="font-weight: 600; color: #2E7D32; margin-bottom: 8px;">üéâ Ê¨¢ËøéÂõûÊù•ÔºÅÊü•ËØ¢Âà∞ÊÇ®ÁöÑÊä•Âêç‰ø°ÊÅØÔºö</div>
                            <div class="user-info-item">üë§ ÂßìÂêçÔºö${userInfo.name}</div>
                            <div class="user-info-item">üìÖ ÂèÇ‰∏éÂ§©Êï∞ÔºöÁ¨¨${userInfo.dayCount}Â§©</div>
                            <div class="user-info-item">ü§ñ Êú∫Âô®‰∫∫Âêå‰º¥Ôºö${robotName}</div>
                        </div>
                        <div style="margin-top: 12px; color: #1B5E20; font-weight: 500;">
                            ÂáÜÂ§áÂ•ΩËØ∑ÁÇπÂáªÁ°ÆÂÆöÂºÄÂßã üëá
                        </div>
                        <button class="confirm-btn" onclick="this.parentElement.confirmCallback()">Á°ÆÂÆöÂºÄÂßã</button>
                    `;

                    // ËÆæÁΩÆÁ°ÆËÆ§ÂõûË∞É
                    messageDiv.confirmCallback = onConfirm;
                } else {
                    // ÊôÆÈÄöÊ∂àÊÅØÊòæÁ§∫
                    messageDiv.textContent = message;

                    // 3ÁßíÂêéËá™Âä®ÈöêËóèÊ∂àÊÅØÔºàÈô§ÈùûÊòØÈîôËØØÊ∂àÊÅØÔºâ
                    if (type !== 'error') {
                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                        }, 3000);
                    }
                }

                messageDiv.style.display = 'block';
            }

            // ÈöêËóèÊü•ËØ¢Ê∂àÊÅØ
            hideQueryMessage() {
                const messageDiv = document.getElementById('queryMessage');
                messageDiv.style.display = 'none';
            }

            // ÊòæÁ§∫Ê≥®ÂÜåÊ∂àÊÅØÁöÑËæÖÂä©ÂáΩÊï∞
            showRegisterMessage(message, type = 'info') {
                const messageDiv = document.getElementById('registerMessage');
                messageDiv.textContent = message;
                messageDiv.className = `query-message ${type}`;
                messageDiv.style.display = 'block';

                // 3ÁßíÂêéËá™Âä®ÈöêËóèÊ∂àÊÅØÔºàÈô§ÈùûÊòØÈîôËØØÊ∂àÊÅØÔºâ
                if (type !== 'error') {
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 3000);
                }
            }

            // ÈöêËóèÊ≥®ÂÜåÊ∂àÊÅØ
            hideRegisterMessage() {
                const messageDiv = document.getElementById('registerMessage');
                messageDiv.style.display = 'none';
            }

            bindLoginEvents() {
                const queryForm = document.getElementById('queryForm');
                const registerForm = document.getElementById('registerForm');
                const queryBtn = document.getElementById('queryBtn');
                const showRegisterBtn = document.getElementById('showRegisterBtn');
                const registerBtn = document.getElementById('registerBtn');
                const backToQueryBtn = document.getElementById('backToQueryBtn');
                const queryName = document.getElementById('queryName');
                const skipLoginBtn = document.getElementById('skipLoginBtn');

                // Êü•ËØ¢ÊåâÈíÆ‰∫ã‰ª∂
                queryBtn.addEventListener('click', () => {
                    const name = queryName.value.trim();
                    if (!name) {
                        this.showQueryMessage('ËØ∑ËæìÂÖ•ÂßìÂêç', 'error');
                        return;
                    }
                    if (name.length < 2) {
                        this.showQueryMessage('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÂßìÂêç', 'error');
                        return;
                    }
                    this.hideQueryMessage(); // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∂àÊÅØ
                    this.queryUser(name);
                });

                // ÊòæÁ§∫Ê≥®ÂÜåË°®Âçï
                showRegisterBtn.addEventListener('click', () => {
                    queryForm.style.display = 'none';
                    registerForm.style.display = 'block';
                });

                // ËøîÂõûÊü•ËØ¢Ë°®Âçï
                backToQueryBtn.addEventListener('click', () => {
                    registerForm.style.display = 'none';
                    queryForm.style.display = 'block';
                    this.clearRegisterForm();
                    this.hideQueryMessage(); // Ê∏ÖÈô§Êü•ËØ¢Ê∂àÊÅØ
                    this.hideRegisterMessage(); // Ê∏ÖÈô§Ê≥®ÂÜåÊ∂àÊÅØ
                });

                // Ê≥®ÂÜåÊåâÈíÆ‰∫ã‰ª∂
                registerBtn.addEventListener('click', async () => {
                    this.hideRegisterMessage(); // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∂àÊÅØ
                    await this.registerUser();
                });

                // Êü•ÁúãÁî®Êà∑ÂàóË°®ÊåâÈíÆ‰∫ã‰ª∂
                const viewUsersBtn = document.getElementById('viewUsersBtn');
                viewUsersBtn.addEventListener('click', async () => {
                    await this.showUserList();
                });

                // ÂÖ≥Èó≠Áî®Êà∑ÂàóË°®Ê®°ÊÄÅÊ°Ü
                const closeUserListModal = document.getElementById('closeUserListModal');
                const userListModal = document.getElementById('userListModal');
                closeUserListModal.addEventListener('click', () => {
                    userListModal.style.display = 'none';
                });

                // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
                userListModal.addEventListener('click', (e) => {
                    if (e.target === userListModal) {
                        userListModal.style.display = 'none';
                    }
                });

                // ËæìÂÖ•Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
                queryName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        queryBtn.click();
                    }
                });

                // Ë∑≥ËøáÊ≥®ÂÜåÊåâÈíÆ‰∫ã‰ª∂
                skipLoginBtn.addEventListener('click', () => {
                    // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑÂÜÖÊµãÁî®Êà∑‰ø°ÊÅØ
                    this.userInfo = {
                        name: 'ÂÜÖÊµãÁî®Êà∑',
                        gender: 'unknown',
                        idNumber: 'TEST000000000000000',
                        alipay: 'ÂÜÖÊµãÈò∂ÊÆµ',
                        registerTime: new Date().toISOString(),
                        isTestUser: true
                    };

                    // ËÆ∞ÂΩïÁî®Êà∑‰ø°ÊÅØÂà∞Êï∞ÊçÆÁ≥ªÁªü
                    this.gameData.userInfo = this.userInfo;
                    this.recordGameEvent('user_skip_registration', {
                        userType: 'ÂÜÖÊµãÁî®Êà∑'
                    });

                    this.showQueryMessage('üöÄ ÂÜÖÊµãÊ®°ÂºèÔºöÂ∑≤Ë∑≥ËøáÊ≥®ÂÜåÔºåÂç≥Â∞ÜËøõÂÖ•‰ºô‰º¥ÈÄâÊã©ÁïåÈù¢ÔºÅ', 'info');
                    // Âª∂ËøüË∑≥ËΩ¨ÔºåËÆ©Áî®Êà∑ÁúãÂà∞Ê∂àÊÅØ
                    setTimeout(() => {
                        this.proceedToRobotSelection();
                    }, 2000);
                });
            }

            validateIdNumber(idNumber) {
                // ÁÆÄÂçïÁöÑË∫´‰ªΩËØÅÂè∑È™åËØÅÔºà18‰ΩçÊï∞Â≠óÔºåÊúÄÂêé‰∏Ä‰ΩçÂèØËÉΩÊòØXÔºâ
                const idRegex = /^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/;
                return idRegex.test(idNumber);
            }

            queryUser(name) {
                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÁõ¥Êé•ÂàõÂª∫ÊµãËØïÁî®Êà∑
                if (this.localTestMode) {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂàõÂª∫ÊµãËØïÁî®Êà∑', name);
                    const testUser = {
                        name: name,
                        gender: 'male',
                        idNumber: '110101199001011234',
                        alipay: 'test@example.com',
                        selectedRobot: 'robot1',
                        dayCount: 1,
                        registrationDate: new Date().toISOString().split('T')[0]
                    };
                    this.userInfo = testUser;
                    this.showQueryMessage('', 'success', testUser, () => {
                        this.hideQueryMessage();
                        this.showRobotSelection();
                    });
                    return;
                }

                // Ê®°ÊãüÊü•ËØ¢Áî®Êà∑
                const user = this.registeredUsers.find(u => u.name === name);

                if (user) {
                    // Ê®°ÊãüÊØèÂ§©ÁôªÂΩïÂ¢ûÂä†Â§©Êï∞ÔºàÂÆûÈôÖÂ∫îÁî®‰∏≠Â∫îËØ•Âü∫‰∫éÁúüÂÆûÊó•ÊúüÔºâ
                    // ËøôÈáå‰∏∫‰∫ÜÊºîÁ§∫ÔºåÊàë‰ª¨ÂèØ‰ª•ÁÆÄÂçïÂú∞ÊØèÊ¨°ÁôªÂΩïÈÉΩÂ¢ûÂä†Â§©Êï∞
                    // Âú®ÁúüÂÆûÂ∫îÁî®‰∏≠ÔºåÂ∫îËØ•Ê£ÄÊü•‰∏äÊ¨°ÁôªÂΩïÊó•Êúü‰∏éÂΩìÂâçÊó•ÊúüÁöÑÂ∑ÆÂºÇ

                    // ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
                    this.userInfo = user;

                    // Ëé∑ÂèñÊú∫Âô®‰∫∫ÂêçÁß∞
                    const robotName = user.selectedRobot === 'robot1' ? 'Ê≥¢Ê≥¢' : 'ÂèØ‰πêÊñπ';

                    if (user.selectedRobot) {
                        // Â∑≤ÈÄâÊã©Êú∫Âô®‰∫∫ÁöÑËÄÅÁî®Êà∑ÔºåÁõ¥Êé•ËøõÂÖ•ÂØπËØùÁ≥ªÁªü
                        // ËÆæÁΩÆÈÄâÊã©ÁöÑÊú∫Âô®‰∫∫
                        this.selectedRobot = user.selectedRobot;

                        // ËÆ∞ÂΩïÁî®Êà∑ÁôªÂΩï‰∫ã‰ª∂
                        this.recordGameEvent('user_login', {
                            userName: user.name,
                            dayCount: user.dayCount,
                            selectedRobot: user.selectedRobot,
                            robotName: robotName
                        });

                        // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÁî®Êà∑‰ø°ÊÅØÂíåÁ°ÆËÆ§ÊåâÈíÆ
                        this.showQueryMessage('', 'success', user, () => {
                            this.proceedToRobotIntro();
                        });
                    } else {
                        // Êñ∞Áî®Êà∑ÔºåÈúÄË¶ÅÈÄâÊã©Êú∫Âô®‰∫∫
                        // ËÆ∞ÂΩïÊñ∞Áî®Êà∑È¶ñÊ¨°ÈÄâÊã©Êú∫Âô®‰∫∫‰∫ã‰ª∂
                        this.recordGameEvent('new_user_robot_selection', {
                            userName: user.name,
                            dayCount: user.dayCount
                        });

                        // ‰∏∫Êñ∞Áî®Êà∑ÊòæÁ§∫‰ø°ÊÅØÔºå‰ΩÜÊú∫Âô®‰∫∫ÊòæÁ§∫‰∏∫"ÂæÖÈÄâÊã©"
                        const tempUserInfo = {...user, selectedRobot: 'robot1'}; // ‰∏¥Êó∂ËÆæÁΩÆÔºåÂè™‰∏∫ÊòæÁ§∫Ê†ºÂºè
                        this.showQueryMessage('', 'success', tempUserInfo, () => {
                            this.proceedToRobotSelection();
                        });

                        // ‰øÆÊîπÊòæÁ§∫ÁöÑÊú∫Âô®‰∫∫‰ø°ÊÅØ
                        setTimeout(() => {
                            const robotInfo = document.querySelector('.user-info-item:last-child');
                            if (robotInfo) {
                                robotInfo.innerHTML = 'ü§ñ Êú∫Âô®‰∫∫Âêå‰º¥Ôºö<span style="color: #FF9800;">ÂæÖÈÄâÊã©</span>';
                            }
                        }, 100);
                    }
                } else {
                    this.showQueryMessage('Êú™ÊâæÂà∞ÊÇ®ÁöÑÊ≥®ÂÜå‰ø°ÊÅØÔºåËØ∑ÂÖàÊ≥®ÂÜåË¥¶Âè∑„ÄÇ', 'info');
                    // Âª∂ËøüË∑≥ËΩ¨Âà∞Ê≥®ÂÜåÈ°µÈù¢ÔºåËÆ©Áî®Êà∑ÁúãÂà∞Ê∂àÊÅØ
                    setTimeout(() => {
                        document.getElementById('queryForm').style.display = 'none';
                        document.getElementById('registerForm').style.display = 'block';
                        // Ëá™Âä®Â°´ÂÖ•ÂßìÂêç
                        document.getElementById('registerName').value = name;
                    }, 1500);
                }
            }

            async registerUser() {
                const name = document.getElementById('registerName').value.trim();
                const gender = document.getElementById('registerGender').value;
                const idNumber = document.getElementById('registerId').value.trim();
                const alipay = document.getElementById('registerAlipay').value.trim();

                // È™åËØÅË°®Âçï
                if (!name) {
                    this.showRegisterMessage('ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç', 'error');
                    return;
                }
                if (!gender) {
                    this.showRegisterMessage('ËØ∑ÈÄâÊã©ÊÄßÂà´', 'error');
                    return;
                }
                if (!idNumber) {
                    this.showRegisterMessage('ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑', 'error');
                    return;
                }
                if (!this.validateIdNumber(idNumber)) {
                    this.showRegisterMessage('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑË∫´‰ªΩËØÅÂè∑Ê†ºÂºè', 'error');
                    return;
                }
                if (!alipay) {
                    this.showRegisterMessage('ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùË¥¶Âè∑', 'error');
                    return;
                }

                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ê≥®ÂÜå
                const existingUser = this.registeredUsers.find(u => u.idNumber === idNumber);
                if (existingUser) {
                    this.showRegisterMessage('ËØ•Ë∫´‰ªΩËØÅÂè∑Â∑≤ÁªèÊ≥®ÂÜåËøá‰∫ÜÔºÅ', 'error');
                    return;
                }

                // Ê≥®ÂÜåÊñ∞Áî®Êà∑
                const newUser = {
                    name: name,
                    gender: gender,
                    idNumber: idNumber,
                    alipay: alipay,
                    selectedRobot: null, // Êñ∞Áî®Êà∑ËøòÊú™ÈÄâÊã©Êú∫Âô®‰∫∫
                    dayCount: 1, // Êñ∞Áî®Êà∑Á¨¨‰∏ÄÂ§©
                    registrationDate: new Date().toISOString().split('T')[0],
                    registerTime: new Date().toISOString()
                };

                this.registeredUsers.push(newUser);
                this.userInfo = newUser;

                // üî• Êñ∞Â¢ûÔºöÂêåÊó∂Ê≥®ÂÜåÂà∞ÂêéÁ´ØAPIÔºà‰ªÖÂú®ÈùûÊú¨Âú∞ÊµãËØïÊ®°Âºè‰∏ãÔºâ
                if (!this.localTestMode) {
                    try {
                        console.log('üîç Ê≠£Âú®Â∞ÜÁî®Êà∑Ê≥®ÂÜåÂà∞ÂêéÁ´ØAPI...', name);
                        const apiResponse = await this.apiClient.registerUser(name, null);
                        if (apiResponse.success) {
                            console.log('‚úÖ ÂêéÁ´ØÊ≥®ÂÜåÊàêÂäü:', apiResponse.data);
                            // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÔºåÂåÖÂê´ÂêéÁ´ØËøîÂõûÁöÑuser_id
                            this.userInfo.user_id = apiResponse.data.user_id;
                            this.userInfo.backend_registered = true;
                        } else {
                            console.warn('‚ö†Ô∏è ÂêéÁ´ØÊ≥®ÂÜåÂ§±Ë¥•Ôºå‰ΩÜÁªßÁª≠Ê∏∏Êàè:', apiResponse.message);
                            this.userInfo.backend_registered = false;
                        }
                    } catch (error) {
                        console.error('‚ùå ÂêéÁ´ØÊ≥®ÂÜåÂá∫ÈîôÔºå‰ΩÜÁªßÁª≠Ê∏∏Êàè:', error);
                        this.userInfo.backend_registered = false;
                    }
                } else {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöË∑≥ËøáÂêéÁ´ØÊ≥®ÂÜå');
                    this.userInfo.backend_registered = false;
                }

                // ËÆ∞ÂΩïÁî®Êà∑‰ø°ÊÅØÂà∞Êï∞ÊçÆÁ≥ªÁªü
                this.gameData.userInfo = this.userInfo;

                // ËÆ∞ÂΩïÂà∞Êú¨Âú∞‰∫ã‰ª∂Êó•Âøó
                this.recordGameEvent('user_registration', {
                    userName: name,
                    userGender: gender,
                    backendRegistered: this.userInfo.backend_registered
                });

                // Â¶ÇÊûúÂêéÁ´ØÊ≥®ÂÜåÊàêÂäüÔºå‰πüËÆ∞ÂΩïÂà∞ÂêéÁ´ØÔºàÈúÄË¶ÅÊ∏∏Êàè‰ºöËØùÔºâ
                if (this.userInfo.backend_registered && this.userInfo.user_id) {
                    try {
                        // ÂÖàÂàõÂª∫Ê∏∏Êàè‰ºöËØùÔºåÁÑ∂ÂêéËÆ∞ÂΩï‰∫ã‰ª∂
                        console.log('üîç ‰∏∫Ê≥®ÂÜåÁî®Êà∑ÂàõÂª∫Ê∏∏Êàè‰ºöËØù...');
                        // Ê≥®ÊÑèÔºöËøôÈáåÊàë‰ª¨ËøòÊ≤°ÊúâÈÄâÊã©Êú∫Âô®‰∫∫ÔºåÊâÄ‰ª•ÊöÇÊó∂‰∏çÂàõÂª∫‰ºöËØù
                        // ‰∫ã‰ª∂ËÆ∞ÂΩïÂ∞ÜÂú®Ê∏∏ÊàèÂºÄÂßãÊó∂ËøõË°å
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Êó†Ê≥ïÁ´ãÂç≥ËÆ∞ÂΩïÂà∞ÂêéÁ´ØÔºåÂ∞ÜÂú®Ê∏∏ÊàèÂºÄÂßãÊó∂ËÆ∞ÂΩï:', error);
                    }
                }

                this.showRegisterMessage(`Ê≥®ÂÜåÊàêÂäüÔºÅÊ¨¢ËøéÊÇ®Ôºå${name}ÔºÅÂç≥Â∞ÜËøõÂÖ•‰ºô‰º¥ÈÄâÊã©ÁïåÈù¢„ÄÇ`, 'success');
                // Âª∂ËøüË∑≥ËΩ¨ÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊ∂àÊÅØ
                setTimeout(() => {
                    this.proceedToRobotSelection();
                }, 2000);
            }

            clearRegisterForm() {
                document.getElementById('registerName').value = '';
                document.getElementById('registerGender').value = '';
                document.getElementById('registerId').value = '';
                document.getElementById('registerAlipay').value = '';
            }

            proceedToRobotSelection() {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('robotSelection').style.display = 'block';
                this.menuState = 'robotSelection';
            }

            proceedToRobotIntro() {
                // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞Êú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢ÔºåË∑≥ËøáÊú∫Âô®‰∫∫ÈÄâÊã©
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('robotSelection').style.display = 'none';
                this.showRobotIntroduction();
            }

            // ÊòæÁ§∫Áî®Êà∑ÂàóË°®
            async showUserList() {
                const userListModal = document.getElementById('userListModal');
                const userListContent = document.getElementById('userListContent');

                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                userListModal.style.display = 'flex';

                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                userListContent.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÁî®Êà∑ÂàóË°®...</div>';

                try {
                    // Ë∞ÉÁî®APIËé∑ÂèñÁî®Êà∑ÂàóË°® - ‰ΩøÁî®‰ª£ÁêÜÊúçÂä°ÈÅøÂÖçÊ∑∑ÂêàÂÜÖÂÆπÈóÆÈ¢ò
                    const apiUrl = window.location.protocol === 'https:'
                        ? 'https://api.allorigins.win/get?url=' + encodeURIComponent('http://106.15.184.68/api/users')
                        : 'http://106.15.184.68/api/users';

                    const response = await fetch(apiUrl);
                    let result;

                    if (window.location.protocol === 'https:') {
                        // ‰ΩøÁî®‰ª£ÁêÜÊúçÂä°Êó∂ÔºåÈúÄË¶ÅËß£ÊûêÂµåÂ•óÁöÑÂìçÂ∫î
                        const proxyResult = await response.json();
                        result = JSON.parse(proxyResult.contents);
                    } else {
                        // Áõ¥Êé•ËÆøÈóÆAPI
                        result = await response.json();
                    }

                    if (result.success && result.data && result.data.length > 0) {
                        // ÊûÑÂª∫Áî®Êà∑ÂàóË°®Ë°®Ê†º
                        let tableHTML = `
                            <table class="user-list-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ÂßìÂêç</th>
                                        <th>ÊÄßÂà´</th>
                                        <th>Ë∫´‰ªΩËØÅÂè∑</th>
                                        <th>ÊîØ‰ªòÂÆùË¥¶Âè∑</th>
                                        <th>Ê≥®ÂÜåÊó•Êúü</th>
                                        <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        result.data.forEach(user => {
                            const genderText = user.gender === 'male' ? 'Áî∑' : user.gender === 'female' ? 'Â•≥' : user.gender || '-';
                            const registerTime = user.registerTime ? new Date(user.registerTime).toLocaleString('zh-CN') : '-';

                            tableHTML += `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.name || '-'}</td>
                                    <td>${genderText}</td>
                                    <td>${user.idNumber || '-'}</td>
                                    <td>${user.alipay || '-'}</td>
                                    <td>${user.registrationDate || '-'}</td>
                                    <td>${registerTime}</td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                                </tbody>
                            </table>
                            <div style="margin-top: 15px; text-align: center; color: #666;">
                                ÂÖ± ${result.data.length} ‰∏™Áî®Êà∑
                            </div>
                        `;

                        userListContent.innerHTML = tableHTML;
                    } else {
                        userListContent.innerHTML = '<div class="loading">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</div>';
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÁî®Êà∑ÂàóË°®Â§±Ë¥•:', error);
                    userListContent.innerHTML = '<div class="loading" style="color: #ff6b6b;">Ëé∑ÂèñÁî®Êà∑ÂàóË°®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•</div>';
                }
            }

            // Ê®°ÊãüÂ¢ûÂä†Áî®Êà∑Â§©Êï∞ÁöÑÊñπÊ≥ïÔºàÁî®‰∫éÊµãËØïÔºâ
            incrementUserDay(userName) {
                const user = this.registeredUsers.find(u => u.name === userName);
                if (user) {
                    user.dayCount++;
                    console.log(`Áî®Êà∑ ${userName} ÁöÑÂ§©Êï∞Â∑≤Â¢ûÂä†Âà∞Á¨¨ ${user.dayCount} Â§©`);
                    return user.dayCount;
                }
                return null;
            }

            createLogoDecoration() {
                // ‰∏∫Ê≥¢Ê≥¢Ê∑ªÂä†logoË£ÖÈ•∞
                const robot1Option = document.querySelector('.robot-option[data-robot="robot1"]');
                const robot1Name = robot1Option?.querySelector('.robot-name');
                if (robot1Option && robot1Name) {
                    // Ê∏ÖÈô§‰πãÂâçÁöÑlogoË£ÖÈ•∞
                    const existingLogos = robot1Option.querySelectorAll('.robot1-logo-decoration');
                    existingLogos.forEach(logo => logo.remove());



                // Âú®ÂêçÂ≠óÂè≥ËæπÊ∑ªÂä†‰∏Ä‰∏™logo
                const rightLogo = document.createElement('img');
                rightLogo.className = 'robot1-logo-decoration';
                rightLogo.src = 'image/robot1_logo.png';
                rightLogo.alt = 'Ê≥¢Ê≥¢logo';
                rightLogo.style.cssText = `
                    margin-left: 8px;
                    width: 24px;
                    height: auto;
                    animation: float 2s ease-in-out infinite;
                    animation-delay: 1s;
                    display: inline-block;
                    vertical-align: middle;
                    position: relative;
                    top: 6px;
                    z-index: 10;
                `;

                    // Â∞ÜlogoÊèíÂÖ•Âà∞ÂêçÂ≠óÂè≥Ëæπ
                    robot1Name.appendChild(rightLogo);

                    // ‰∏∫Ê≥¢Ê≥¢Ê∑ªÂä†Á≥ñÊûúË£ÖÈ•∞
                    this.addCandyDecorations(robot1Option, ['üç≠', 'üç¨', 'üßÅ', 'üç∞']);
                }

                // ‰∏∫‰∏âËßíÂêõÊ∑ªÂä†logoË£ÖÈ•∞
                const robot2Option = document.querySelector('.robot-option[data-robot="robot2"]');
                const robot2Name = robot2Option?.querySelector('.robot-name');
                if (robot2Option && robot2Name) {
                    // Ê∏ÖÈô§‰πãÂâçÁöÑlogoË£ÖÈ•∞
                    const existingLogos = robot2Option.querySelectorAll('.robot2-logo-decoration');
                    existingLogos.forEach(logo => logo.remove());

                    // Âú®ÂêçÂ≠óÂè≥ËæπÊ∑ªÂä†‰∏Ä‰∏™logo
                    const rightLogo = document.createElement('img');
                    rightLogo.className = 'robot2-logo-decoration';
                    rightLogo.src = 'image/robot2_logo.png';
                    rightLogo.alt = '‰∏âËßíÂêõlogo';
                    rightLogo.style.cssText = `
                        margin-left: 8px;
                        width: 24px;
                        height: auto;
                        animation: float 2s ease-in-out infinite;
                        animation-delay: 1s;
                        display: inline-block;
                        vertical-align: middle;
                        position: relative;
                        top: 6px;
                        z-index: 10;
                    `;

                    // Â∞ÜlogoÊèíÂÖ•Âà∞ÂêçÂ≠óÂè≥Ëæπ
                    robot2Name.appendChild(rightLogo);

                    // ‰∏∫‰∏âËßíÂêõÊ∑ªÂä†Á≥ñÊûúË£ÖÈ•∞
                    this.addCandyDecorations(robot2Option, ['üç´', 'üç©', 'üßä', '‚≠ê']);
                }
            }

            addCandyDecorations(robotOption, candyTypes) {
                // Ê∏ÖÈô§‰πãÂâçÁöÑÁ≥ñÊûúË£ÖÈ•∞
                const existingCandies = robotOption.querySelectorAll('.candy-decoration');
                existingCandies.forEach(candy => candy.remove());

                // Ê∑ªÂä†Êõ¥Â§öÁ≥ñÊûúË£ÖÈ•∞ÔºöÂõõ‰∏™ËßíËêΩ + Êú∫Âô®‰∫∫‰∏§‰æß
                const positions = [
                    { left: '10px', top: '10px' },        // Â∑¶‰∏äËßí
                    { right: '10px', top: '10px' },       // Âè≥‰∏äËßí
                    { left: '10px', bottom: '10px' },     // Â∑¶‰∏ãËßí
                    { right: '10px', bottom: '10px' },    // Âè≥‰∏ãËßí
                    { left: '10px', top: '50%', transform: 'translateY(-50%)' },  // Â∑¶‰æß‰∏≠Èó¥
                    { right: '10px', top: '50%', transform: 'translateY(-50%)' }  // Âè≥‰æß‰∏≠Èó¥
                ];

                for (let i = 0; i < positions.length; i++) {
                    const candy = document.createElement('div');
                    candy.className = 'candy-decoration';
                    candy.innerHTML = candyTypes[Math.floor(Math.random() * candyTypes.length)];

                    const pos = positions[i];
                    // ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÁõ∏ÂØπ‰∫éÂç°Áâá
                    if (pos.left) candy.style.left = pos.left;
                    if (pos.right) candy.style.right = pos.right;
                    if (pos.top) candy.style.top = pos.top;
                    if (pos.bottom) candy.style.bottom = pos.bottom;
                    if (pos.transform) candy.style.transform = pos.transform;

                    candy.style.animationDelay = `${i * 0.3}s`;
                    candy.style.zIndex = '1'; // Á°Æ‰øùÂú®ÊñáÂ≠ó‰∏ãÊñπ

                    robotOption.appendChild(candy);
                }
            }

            showRobotIntroduction() {
                // ÈöêËóèÊú∫Âô®‰∫∫ÈÄâÊã©ÁïåÈù¢
                document.getElementById('startMenu').style.display = 'none';

                // ÊòæÁ§∫Êú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢
                const introScreen = document.getElementById('robotIntroduction');
                introScreen.style.display = 'flex';

                // ËÆæÁΩÆÈÄâ‰∏≠Êú∫Âô®‰∫∫ÁöÑËßÜÈ¢ëÂíå‰ªãÁªç
                this.setupRobotIntro();

                // ÁªëÂÆöÁ°ÆËÆ§ÊåâÈíÆ‰∫ã‰ª∂
                this.bindIntroEvents();

                // ÁªëÂÆöË∑≥ËøáÂØπËØùÊåâÈíÆ‰∫ã‰ª∂
                this.bindSkipConversationEvent();
            }

            bindSkipConversationEvent() {
                console.log('ÂºÄÂßãÁªëÂÆöË∑≥ËøáÂØπËØùÊåâÈíÆ‰∫ã‰ª∂');

                // Âª∂Ëøü‰∏Ä‰∏ãÁ°Æ‰øùDOMÂÖÉÁ¥†Â∑≤ÁªèÊ∏≤Êüì
                setTimeout(() => {
                    const skipBtn = document.getElementById('skipConversationBtn');
                    console.log('Ë∑≥ËøáÂØπËØùÊåâÈíÆÂÖÉÁ¥†:', skipBtn);

                    if (skipBtn) {
                        // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
                        skipBtn.addEventListener('click', (e) => {
                            console.log('Ë∑≥ËøáÂØπËØùÊåâÈíÆË¢´ÁÇπÂáªÔºÅ');
                            e.preventDefault();
                            e.stopPropagation();
                            this.skipToGameRules();
                        });

                        console.log('Ë∑≥ËøáÂØπËØùÊåâÈíÆ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
                    } else {
                        console.error('Êâæ‰∏çÂà∞Ë∑≥ËøáÂØπËØùÊåâÈíÆÂÖÉÁ¥†ÔºÅ');
                    }
                }, 100);
            }

            skipToGameRules() {
                console.log('skipToGameRules ÊñπÊ≥ïË¢´Ë∞ÉÁî® - Ë∑≥ËøáÂØπËØùÂà∞Ê∏∏ÊàèËßÑÂàô');

                // ËÆæÁΩÆÈªòËÆ§Áé©ÂÆ∂ÂêçÁß∞Ôºå‰ΩÜ‰øùÊåÅÂΩìÂâçÈÄâ‰∏≠ÁöÑÊú∫Âô®‰∫∫
                this.playerName = 'ÂÜÖÊµãÁé©ÂÆ∂';
                // ‰∏çË¶ÅÈáçÊñ∞ËÆæÁΩÆ selectedRobotÔºå‰øùÊåÅÁî®Êà∑ÈÄâÊã©ÁöÑÊú∫Âô®‰∫∫

                // ÈöêËóèÊú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢
                const robotIntroduction = document.getElementById('robotIntroduction');
                if (robotIntroduction) {
                    robotIntroduction.style.display = 'none';
                }

                // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢‰ΩÜ‰∏çÂºÄÂßãÊ∏∏Êàè
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.style.display = 'block';
                }

                // ÁªëÂÆöÊ∏∏Êàè‰∫ã‰ª∂
                this.bindEvents();

                // ÊòæÁ§∫Ê∏∏ÊàèËßÑÂàô‰ªãÁªç
                this.showGameRules();

                console.log('Ë∑≥ËøáÂØπËØùÔºåËøõÂÖ•Ê∏∏ÊàèËßÑÂàô‰ªãÁªçÔºÅÂΩìÂâçÊú∫Âô®‰∫∫:', this.selectedRobot);
            }

            skipToEnd() {
                console.log('skipToEnd ÊñπÊ≥ïË¢´Ë∞ÉÁî® - Ë∑≥ËøáÊ∏∏ÊàèÂà∞ËØÑ‰ª∑');

                // ÂÅúÊ≠¢Ê∏∏Êàè
                this.gameState = 'ended';

                // ÈöêËóèÊ∏∏ÊàèÁïåÈù¢
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.style.display = 'none';
                }

                // ÈöêËóèË∑≥ËøáÊåâÈíÆ
                const skipButton = document.getElementById('skipButton');
                if (skipButton) {
                    skipButton.style.display = 'none';
                }

                // ÊòæÁ§∫ËØÑ‰ª∑ÁïåÈù¢
                this.showEvaluationScreen();

                console.log('Ë∑≥ËøáÊ∏∏ÊàèÔºåËøõÂÖ•ËØÑ‰ª∑ÁïåÈù¢ÔºÅ');
            }

            showEvaluationScreen() {
                console.log('ÊòæÁ§∫Áã¨Á´ãÁöÑÁªìÂ∞æËØÑ‰ª∑ÂØπËØùÁïåÈù¢');

                // ÈöêËóèÊ∏∏ÊàèÁïåÈù¢
                const gameContainer = document.getElementById('gameContainer');
                if (gameContainer) {
                    gameContainer.style.display = 'none';
                }

                // ÊòæÁ§∫Áã¨Á´ãÁöÑÁªìÂ∞æÂØπËØùÁïåÈù¢
                const endGameDialog = document.getElementById('endGameDialog');
                if (endGameDialog) {
                    endGameDialog.style.display = 'flex';
                }

                // ËÆæÁΩÆ‰∏Ä‰∏™ÈªòËÆ§ÂàÜÊï∞ÔºàË∑≥ËøáÊ∏∏ÊàèÁöÑÊÉÖÂÜµÔºâ
                if (!this.score) {
                    this.score = 0;
                }

                // ÂêØÂä®Áã¨Á´ãÁöÑÁªìÂ∞æÂØπËØùÁ≥ªÁªü
                this.startEndGameDialog();
            }

            startEndGameDialog() {
                console.log('ÂêØÂä®Áã¨Á´ãÁöÑÁªìÂ∞æÂØπËØùÁ≥ªÁªü');

                // Áã¨Á´ãÁöÑÁªìÂ∞æÂØπËØùÂèòÈáè
                this.endDialogStep = 0;
                this.endDialogMessages = [];
                this.endTypingSpeed = 50;

                // ËÆæÁΩÆÁªìÂ∞æÊú∫Âô®‰∫∫‰ø°ÊÅØ
                this.setupEndRobot();

                // ÂºÄÂßãÁªìÂ∞æÂØπËØù
                this.showEndDialogMessage();
            }

            setupEndRobot() {
                const endVideo = document.getElementById('endRobotVideo');
                const endRobotNameLabel = document.getElementById('endRobotNameLabel');
                const endSpeechBubble = document.getElementById('endSpeechBubble');
                const endInputBubble = document.getElementById('endInputBubble');

                if (this.selectedRobot === 'robot1') {
                    endVideo.src = 'image/robot_1.webm';
                    endVideo.className = 'robot-video robot1-video';
                    endRobotNameLabel.textContent = 'Ê≥¢Ê≥¢';
                    endRobotNameLabel.className = 'robot-name-label robot1';
                    endSpeechBubble.className = 'dialogue-bubble robot1 end-dialog';
                    endInputBubble.className = 'input-bubble robot1';

                    this.endDialogMessages = [
                        `üéâ Â§™Â•ΩÂï¶ÔºÅÊàë‰ª¨‰∏ÄËµ∑ÂÆåÊàê‰∫Ü‰ªªÂä°ÔºÅÂàöÂàöÂèñÂæó‰∫Ü ${this.score} ÂàÜÔºÅ`,
                        "ËøòÊúâ‰∏Ä‰∫õÈóÆÈ¢òÈúÄË¶Å‰Ω†Êù•Â°´ÂÜôÔºåÁ®çÁ≠âÊàë‰∏Ä‰∏ãÂì¶ÔΩû"
                    ];
                } else {
                    endVideo.src = 'image/robot_end1.webm';
                    endVideo.className = 'robot-video robot2-video';
                    endRobotNameLabel.textContent = 'ÂèØ‰πêÊñπ';
                    endRobotNameLabel.className = 'robot-name-label robot2';
                    endSpeechBubble.className = 'dialogue-bubble robot2 end-dialog';
                    endInputBubble.className = 'input-bubble robot2';

                    this.endDialogMessages = [
                        `ü§ñ Â§™Â•ΩÂï¶ÔºÅ‰ªªÂä°ÂÆåÊàêÔºÅÊàë‰ª¨‰∏ÄËµ∑ÂèñÂæó‰∫Ü ${this.score} ÂàÜÁöÑÊàêÁª©ÔºÅ`,
                        "ËøòÊúâ‰∏Ä‰∫õÈóÆÈ¢òÈúÄË¶Å‰Ω†Êù•Â°´ÂÜôÔºåÁ®çÁ≠âÊàë‰∏Ä‰∏ã..."
                    ];
                }

                // Êí≠ÊîæËßÜÈ¢ë
                endVideo.play().catch(e => console.log('ÁªìÂ∞æÂØπËØùËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•'));
            }

            showEndDialogMessage() {
                if (this.endDialogStep >= this.endDialogMessages.length) {
                    // ÊâÄÊúâÊ∂àÊÅØÊòæÁ§∫ÂÆåÊØïÔºåÊòæÁ§∫ËØÑÂàÜËæìÂÖ•
                    setTimeout(() => {
                        this.showEndRatingInput();
                    }, 2000);
                    return;
                }

                const endDialogueText = document.getElementById('endDialogueText');
                const endTypingIndicator = document.getElementById('endTypingIndicator');
                const message = this.endDialogMessages[this.endDialogStep];

                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                endTypingIndicator.style.display = 'block';
                endDialogueText.textContent = '';

                // Ê®°ÊãüÊâìÂ≠óÊïàÊûú
                setTimeout(() => {
                    endTypingIndicator.style.display = 'none';
                    this.typeEndMessage(message, endDialogueText);
                }, 1500);
            }

            typeEndMessage(message, element) {
                let index = 0;
                element.textContent = '';

                const typeInterval = setInterval(() => {
                    if (index < message.length) {
                        element.textContent += message[index];
                        index++;
                    } else {
                        clearInterval(typeInterval);
                        // Á≠âÂæÖÂêéÊòæÁ§∫‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
                        setTimeout(() => {
                            this.endDialogStep++;
                            this.showEndDialogMessage();
                        }, 3000);
                    }
                }, this.endTypingSpeed);
            }

            // ‰∏ìÈó®Áî®‰∫éÈóÆÈ¢òÂíåÂèçÈ¶àÁöÑÊâìÂ≠óÊïàÊûúÔºå‰∏ç‰ºöËá™Âä®ÁªßÁª≠
            typeQuestionMessage(message, element) {
                let index = 0;
                element.textContent = '';

                const typeInterval = setInterval(() => {
                    if (index < message.length) {
                        element.textContent += message[index];
                        index++;
                    } else {
                        clearInterval(typeInterval);
                        // ‰∏çËá™Âä®ÁªßÁª≠ÔºåÂè™ÊòØÂÆåÊàêÊâìÂ≠ó
                    }
                }, this.endTypingSpeed);
            }

            showEndRatingInput() {
                // ÂàùÂßãÂåñËØÑ‰ª∑ÈóÆÈ¢ò
                this.initEvaluationQuestions();

                // ÂºÄÂßãÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢ò
                this.currentQuestionIndex = 0;
                this.evaluationRatings = {};
                this.isWaitingForInput = false; // Ê∑ªÂä†Ê†áÂøóÈò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®

                // ÊòæÁ§∫Á¨¨‰∏Ä‰∏™ÈóÆÈ¢ò
                this.showNextEvaluationQuestion();
            }

            initEvaluationQuestions() {
                const robotName = this.selectedRobot === 'robot1' ? 'Êàë' : 'Êàë';

                this.evaluationQuestions = [
                    {
                        key: 'enjoyment',
                        robotQuestion: `ÊÇ®‰ªäÂ§©‰∫´Âèó‰∏é${robotName}‰∏ÄËµ∑Ê∏∏ÊàèÂêóÔºü`,
                        tipLow: 'ÂÆåÂÖ®‰∏ç‰∫´Âèó',
                        tipHigh: 'ÈùûÂ∏∏‰∫´Âèó'
                    },
                    {
                        key: 'helpfulness',
                        robotQuestion: `ÊÇ®ËßâÂæóÂú®Ê∏∏Êàè‰∏≠Ôºå${robotName}Êèê‰æõÁöÑÂ∏ÆÂä©ÊúâÂ§öÂ§ßÔºü`,
                        tipLow: 'ÂÆåÂÖ®Ê≤°ÊúâÂ∏ÆÂä©',
                        tipHigh: 'Â∏ÆÂä©ÈùûÂ∏∏Â§ß'
                    },
                    {
                        key: 'dependency',
                        robotQuestion: `ÊÇ®ËßâÂæóÊ∏∏ÊàèÁöÑÂæóÂàÜÂú®Â§öÂ§ßÁ®ãÂ∫¶‰∏ä‰æùËµñ‰∫é${robotName}Ôºü`,
                        tipLow: 'ÂÆåÂÖ®‰∏ç‰æùËµñ',
                        tipHigh: 'ÂÆåÂÖ®‰æùËµñ'
                    },
                    {
                        key: 'user_error_frequency',
                        robotQuestion: `ÊÇ®ËÆ§‰∏∫Ëá™Â∑±Âú®‰∏é${robotName}Âêà‰ΩúÊ∏∏ÊàèÊó∂Âá∫ÈîôÁöÑÈ¢ëÁéáÊúâÂ§öÈ´òÔºü`,
                        tipLow: 'Âá†‰πé‰∏çÂá∫Èîô',
                        tipHigh: 'ÁªèÂ∏∏Âá∫Èîô'
                    },
                    {
                        key: 'robot_error_frequency',
                        robotQuestion: `ÊÇ®ËÆ§‰∏∫${robotName}Âú®Ê∏∏Êàè‰∏≠Âá∫ÈîôÁöÑÈ¢ëÁéáÊúâÂ§öÈ´òÔºü`,
                        tipLow: 'Âá†‰πé‰∏çÂá∫Èîô',
                        tipHigh: 'ÁªèÂ∏∏Âá∫Èîô'
                    }
                ];
            }

            showNextEvaluationQuestion() {
                if (this.currentQuestionIndex >= this.evaluationQuestions.length) {
                    // ÊâÄÊúâÈóÆÈ¢òÂõûÁ≠îÂÆåÊØïÔºåÊ∏ÖÈô§Á≠âÂæÖÊ†áÂøó
                    this.isWaitingForInput = false;
                    this.completeEvaluation();
                    return;
                }

                // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
                if (this.isWaitingForInput) {
                    return;
                }

                const question = this.evaluationQuestions[this.currentQuestionIndex];

                // Êú∫Âô®‰∫∫ÈóÆÈóÆÈ¢ò
                this.askEvaluationQuestion(question);
            }

            askEvaluationQuestion(question) {
                const endDialogueText = document.getElementById('endDialogueText');
                const endTypingIndicator = document.getElementById('endTypingIndicator');

                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                endTypingIndicator.style.display = 'block';
                endDialogueText.textContent = '';

                // Ê®°ÊãüÊâìÂ≠óÊïàÊûúÊòæÁ§∫ÈóÆÈ¢ò
                setTimeout(() => {
                    endTypingIndicator.style.display = 'none';
                    this.typeQuestionMessage(question.robotQuestion, endDialogueText);

                    // ÈóÆÈ¢òÊòæÁ§∫ÂÆåÊØïÂêéÔºåÂêØÁî®ËæìÂÖ•Ê°Ü
                    setTimeout(() => {
                        this.enableQuestionInput(question);
                    }, 1000);
                }, 1500);
            }

            enableQuestionInput(question) {
                const endRatingInput = document.getElementById('endRatingInput');
                const endSubmitBtn = document.getElementById('endSubmitBtn');
                const endQuestionTips = document.getElementById('endQuestionTips');
                const tipLowScore = document.getElementById('tipLowScore');
                const tipHighScore = document.getElementById('tipHighScore');

                // ËÆæÁΩÆÁ≠âÂæÖËæìÂÖ•Ê†áÂøó
                this.isWaitingForInput = true;

                // ÊòæÁ§∫tipsÂú®ÂØπËØùÊ°Ü‰∏ãÈù¢
                endQuestionTips.style.display = 'block';
                tipLowScore.textContent = `1=${question.tipLow}`;
                tipHighScore.textContent = `10=${question.tipHigh}`;

                // ÂêØÁî®ËæìÂÖ•
                endRatingInput.disabled = false;
                endSubmitBtn.disabled = false;
                endRatingInput.placeholder = "ËØ∑ËæìÂÖ•Êï∞Â≠ó";
                endRatingInput.value = '';

                // ËÆæÁΩÆËØÑÂàÜËæìÂÖ•Ê°Ü‰∏ªÈ¢ò
                const endInputBubble = document.getElementById('endInputBubble');
                endInputBubble.className = `input-bubble ${this.selectedRobot}`;

                // ÁªëÂÆöÊèê‰∫§‰∫ã‰ª∂
                endSubmitBtn.onclick = () => this.submitCurrentQuestion();
                endRatingInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        this.submitCurrentQuestion();
                    }
                };

                // Ëá™Âä®ËÅöÁÑ¶
                setTimeout(() => {
                    endRatingInput.focus();
                }, 200);
            }

            submitCurrentQuestion() {
                const endRatingInput = document.getElementById('endRatingInput');
                const rating = parseInt(endRatingInput.value);

                if (!rating || rating < 1 || rating > 10) {
                    alert('ËØ∑ËæìÂÖ•1-10‰πãÈó¥ÁöÑÂàÜÊï∞ÔºÅ');
                    return;
                }

                // ‰øùÂ≠òÂΩìÂâçÈóÆÈ¢òÁöÑËØÑÂàÜ
                const question = this.evaluationQuestions[this.currentQuestionIndex];
                this.evaluationRatings[question.key] = rating;

                // Á¶ÅÁî®ËæìÂÖ•
                endRatingInput.disabled = true;
                document.getElementById('endSubmitBtn').disabled = true;
                document.getElementById('endQuestionTips').style.display = 'none';

                // Êú∫Âô®‰∫∫ÁÆÄÁü≠ÂèçÈ¶à
                this.showQuestionFeedback(rating);
            }

            showQuestionFeedback(rating) {
                // Áõ¥Êé•ËøõÂÖ•‰∏ã‰∏Ä‰∏™ÈóÆÈ¢òÔºå‰∏çÊòæÁ§∫ÂèçÈ¶à
                this.currentQuestionIndex++;

                // Áü≠ÊöÇÂª∂ËøüÂêéÊòæÁ§∫‰∏ã‰∏Ä‰∏™ÈóÆÈ¢ò
                setTimeout(() => {
                    // Âú®ÊòæÁ§∫‰∏ã‰∏Ä‰∏™ÈóÆÈ¢òÂâçÊ∏ÖÈô§Á≠âÂæÖÊ†áÂøó
                    this.isWaitingForInput = false;
                    this.showNextEvaluationQuestion();
                }, 500);
            }

            async completeEvaluation() {
                // ËÆ∞ÂΩïÊâÄÊúâËØÑÂàÜÊï∞ÊçÆ
                this.gameData.evaluationRatings = this.evaluationRatings;
                this.recordGameEvent('user_evaluation', {
                    ratings: this.evaluationRatings,
                    robotEvaluated: this.selectedRobot
                });

                // ËÆ°ÁÆóÂπ≥ÂùáÂàÜ‰Ωú‰∏∫ÊÄª‰ΩìËØÑÂàÜ
                const ratings = Object.values(this.evaluationRatings);
                const averageRating = Math.round(ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length);
                this.gameData.userRating = averageRating;

                // ‰øùÂ≠òÂÆåÊï¥Ê∏∏ÊàèÊï∞ÊçÆÂà∞ÊúçÂä°Âô®
                try {
                    await this.saveGameDataToServer();
                } catch (error) {
                    console.error('‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÂ§±Ë¥•:', error);
                    // ÁªßÁª≠ÊòæÁ§∫ÊÑüË∞¢Ê∂àÊÅØÔºå‰∏çÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
                }

                // ÈöêËóèËæìÂÖ•Âå∫Âüü
                document.getElementById('endInputSection').style.display = 'none';

                // ÊòæÁ§∫ÊÑüË∞¢Ê∂àÊÅØ
                this.showEndThankMessage(averageRating);
            }

            // ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÂà∞ÊúçÂä°Âô®
            async saveGameDataToServer() {
                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöË∑≥ËøáÊï∞ÊçÆ‰øùÂ≠ò
                if (this.localTestMode) {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöË∑≥ËøáÊ∏∏ÊàèÊï∞ÊçÆ‰øùÂ≠ò');
                    return;
                }

                if (!this.userInfo || !this.gameSession) {
                    console.warn('Áº∫Â∞ëÁî®Êà∑‰ø°ÊÅØÊàñÊ∏∏Êàè‰ºöËØùÔºåË∑≥ËøáÊï∞ÊçÆ‰øùÂ≠ò');
                    return;
                }

                // ËÆ°ÁÆóÊ∏∏ÊàèÊó∂Èïø
                const gameDuration = this.gameStartTime ? Date.now() - this.gameStartTime : 0;

                // ÂáÜÂ§áÂÆåÊï¥ÁöÑÊ∏∏ÊàèÊï∞ÊçÆ
                const completeGameData = {
                    score: this.score,
                    game_duration: Math.round(gameDuration / 1000), // ËΩ¨Êç¢‰∏∫Áßí
                    game_data: {
                        ...this.gameData,
                        playerName: this.playerName,
                        gameEvents: this.gameData.gameEvents || [],
                        finalScore: this.score,
                        sessionId: this.gameSession.session_id
                    },
                    evaluation_ratings: this.evaluationRatings
                };

                console.log('‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆ:', completeGameData);

                try {
                    // ‰øùÂ≠òÂà∞ÊúçÂä°Âô®
                    const response = await this.apiClient.completeGame(completeGameData);
                    console.log('‚úÖ Ê∏∏ÊàèÊï∞ÊçÆ‰øùÂ≠òÊàêÂäü:', response);

                    // ÂêåÊó∂ÁîüÊàêÂπ∂‰∏ä‰º†JSONÊñá‰ª∂ÔºàÂ§á‰ªΩÔºâ
                    await this.uploadGameDataFile(completeGameData);

                } catch (error) {
                    console.error('‚ùå ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÂ§±Ë¥•:', error);
                    throw error;
                }
            }

            // ‰∏ä‰º†Ê∏∏ÊàèÊï∞ÊçÆÊñá‰ª∂
            async uploadGameDataFile(gameData) {
                try {
                    // ÂàõÂª∫JSONÊñá‰ª∂
                    const jsonData = JSON.stringify(gameData, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const filename = `game_${this.gameSession.session_id}_${Date.now()}.json`;

                    // ‰∏ä‰º†Êñá‰ª∂
                    await this.apiClient.uploadGameData(blob, filename);
                    console.log('‚úÖ Ê∏∏ÊàèÊï∞ÊçÆÊñá‰ª∂‰∏ä‰º†ÊàêÂäü');

                } catch (error) {
                    console.error('‚ùå ‰∏ä‰º†Ê∏∏ÊàèÊï∞ÊçÆÊñá‰ª∂Â§±Ë¥•:', error);
                    // ‰∏çÊäõÂá∫ÈîôËØØÔºåÊñá‰ª∂‰∏ä‰º†Â§±Ë¥•‰∏çÂΩ±Âìç‰∏ªË¶ÅÊµÅÁ®ã
                }
            }

            submitEndRating() {
                // ‰øùÊåÅÂÖºÂÆπÊÄßÔºå‰ΩÜÁé∞Âú®Áî±completeEvaluationÂ§ÑÁêÜ
                this.completeEvaluation();
            }

            showEndThankMessage(averageRating) {
                const endDialogueText = document.getElementById('endDialogueText');
                const endTypingIndicator = document.getElementById('endTypingIndicator');

                // Ê†πÊçÆÊú∫Âô®‰∫∫ÊòæÁ§∫ÁÆÄÊ¥ÅÁöÑÊÑüË∞¢Ê∂àÊÅØ
                let thankMessage;
                if (this.selectedRobot === 'robot1') {
                    thankMessage = `Ë∞¢Ë∞¢‰Ω†ÁöÑËØÑ‰ª∑ÔºÅ‰ªäÂ§©Âíå‰Ω†‰∏ÄËµ∑Ê∏∏ÊàèÂæàÂºÄÂøÉÔΩû ü•∞`;
                } else {
                    thankMessage = `ËØÑ‰ª∑Êï∞ÊçÆÊî∂ÈõÜÂÆåÊàêÔºÅÊÑüË∞¢ÈÖçÂêàÔºÅü§ñ`;
                }

                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                endTypingIndicator.style.display = 'block';
                endDialogueText.textContent = '';

                setTimeout(() => {
                    endTypingIndicator.style.display = 'none';
                    this.typeQuestionMessage(thankMessage, endDialogueText);

                    // 3ÁßíÂêéÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
                    setTimeout(() => {
                        this.showDownloadButton();
                    }, 4000);
                }, 1500);

                console.log(`ÁªìÂ∞æËØÑ‰ª∑ÂÆåÊàêÔºåËØ¶ÁªÜËØÑÂàÜ:`, this.evaluationRatings, `Âπ≥ÂùáÂàÜ: ${averageRating}ÂàÜ`);
            }

            // ÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
            showDownloadButton() {
                // ÂàõÂª∫‰∏ãËΩΩÊåâÈíÆÂÆπÂô®
                const downloadContainer = document.createElement('div');
                downloadContainer.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 10000;
                    background: rgba(255, 255, 255, 0.95);
                    padding: 30px;
                    border-radius: 20px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    backdrop-filter: blur(10px);
                `;

                downloadContainer.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">üéâ Ê∏∏ÊàèÂÆåÊàêÔºÅ</h3>
                    <p style="margin: 0 0 20px 0; color: #666; font-size: 16px;">ÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºÅÊÇ®ÂèØ‰ª•‰∏ãËΩΩÊ∏∏ÊàèÊï∞ÊçÆ„ÄÇ</p>
                    <button id="downloadBtn" style="
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        font-size: 16px;
                        border-radius: 25px;
                        cursor: pointer;
                        margin-right: 10px;
                        transition: all 0.3s ease;
                    ">üì• ‰∏ãËΩΩÊï∞ÊçÆ</button>
                    <button id="restartBtn" style="
                        background: linear-gradient(135deg, #2196F3, #1976D2);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        font-size: 16px;
                        border-radius: 25px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">üîÑ ÈáçÊñ∞ÂºÄÂßã</button>
                `;

                document.body.appendChild(downloadContainer);

                // ÁªëÂÆö‰∏ãËΩΩÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadCSV();
                    alert('Êï∞ÊçÆÂ∑≤‰∏ãËΩΩÔºÅ');
                });

                // ÁªëÂÆöÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('restartBtn').addEventListener('click', () => {
                    if (confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÊ∏∏ÊàèÂêóÔºü')) {
                        location.reload();
                    }
                });

                // Ê∑ªÂä†ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
                const buttons = downloadContainer.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.addEventListener('mouseenter', () => {
                        btn.style.transform = 'translateY(-2px)';
                        btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.transform = 'translateY(0)';
                        btn.style.boxShadow = 'none';
                    });
                });
            }



            setupRobotIntro() {
                const video = document.getElementById('selectedRobotVideo');
                const robotNameLabel = document.getElementById('robotNameLabel');
                const dialogueText = document.getElementById('dialogueText');
                const speechBubble = document.getElementById('speechBubble');

                // ËÆæÁΩÆÊú∫Âô®‰∫∫‰ø°ÊÅØÂíåÊ∂àÊÅØ
                if (this.selectedRobot === 'robot1') {
                    video.src = 'image/robot_1.webm';
                    video.className = 'robot1-video'; // Ê∑ªÂä†Ê≥¢Ê≥¢ËßÜÈ¢ëÁöÑÁâπÊÆäÊ†∑Âºè
                    robotNameLabel.textContent = 'Ê≥¢Ê≥¢';
                    robotNameLabel.className = 'robot-name-label robot1'; // Ê∑ªÂä†Ê≥¢Ê≥¢ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò
                    speechBubble.className = 'dialogue-bubble robot1'; // Ê∑ªÂä†Ê≥¢Ê≥¢ÁöÑÁ≤âËâ≤‰∏ªÈ¢ò

                    // ‰∏∫Ê≥¢Ê≥¢ËÆæÁΩÆËßÜÈ¢ëÊí≠ÊîæÂÆåÊàêÂêéÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    let isFirstVideo = true;
                    video.addEventListener('ended', () => {
                        if (isFirstVideo) {
                            // Á¨¨‰∏Ä‰∏™ËßÜÈ¢ëÊí≠ÊîæÂÆåÂêéÔºåÊí≠ÊîæÁ¨¨‰∫å‰∏™ËßÜÈ¢ë‰ΩÜ‰∏çÂæ™ÁéØ
                            video.src = 'image/robot_1_1.webm';
                            video.loop = false; // ‰∏çÂæ™ÁéØÊí≠Êîæ
                            video.play().catch(e => console.log('Á¨¨‰∫å‰∏™ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•'));
                            isFirstVideo = false;
                        }
                    });

                    this.robotMessages = [
                        "üëã ‰Ω†Â•ΩÔºÅÊàëÊòØÊ≥¢Ê≥¢ÔºÅ",
                        "ÊàëÊòØÈì∂Ê≤≥Á≥ñÊûúÂçè‰ºöÁöÑ'Á§æ‰∫§ÊãÖÂΩì'ÔºåÊÄªÊòØÁî®Ê∏©ÊöñÁöÑÁ¨ëÂÆπÂíåÂè§ÁÅµÁ≤æÊÄ™ÁöÑËØùËØ≠‰∏∫Èòü‰ºçÂ∏¶Êù•ËΩªÊùæÊ∞õÂõ¥ÔºÅ",
                        "ÊàëÂúÜÊªöÊªöÁöÑË∫´‰ΩìËÆ©ÊàëÊó†ËÆ∫Ëµ∞Âà∞Âì™ÈÉΩÂÉè‰∏ÄÈ¢óÂπ∏Á¶èÁ≥ñÔºåÂºπË∑≥Èó¥ÂÖÖÊª°ËÉΩÈáè‰∏éÂ•ΩÂ•áÂøÉÔΩû",
                        "Âø´ÁÇπÂø´ÁÇπÔºåËÆ©Êàë‰ª¨‰∏ÄËµ∑Êé¢Á¥¢Á≥ñÊûú‰∏ñÁïåÂêßÔºÅ‚ú®",
                        "ËØ∑ÂëäËØâÊàë‰Ω†ÁöÑÂêçÂ≠óÔºåËøôÊ†∑ÊàëÂ∞±ËÉΩÊõ¥Â•ΩÂú∞ËÆ§ËØÜ‰Ω†Âï¶ÔºÅüòä"
                    ];
                } else if (this.selectedRobot === 'robot2') {
                    video.src = 'image/robot_2.webm';
                    video.className = 'robot2-video'; // ÂèØ‰πêÊñπËßÜÈ¢ëÈúÄË¶ÅË£ÅÂâ™Âè≥‰∏ãËßíÊ∞¥Âç∞
                    robotNameLabel.textContent = 'ÂèØ‰πêÊñπ';
                    robotNameLabel.className = 'robot-name-label robot2'; // Ê∑ªÂä†ÂèØ‰πêÊñπÁöÑËìùËâ≤‰∏ªÈ¢ò
                    speechBubble.className = 'dialogue-bubble robot2'; // Ê∑ªÂä†ÂèØ‰πêÊñπÁöÑËìùËâ≤‰∏ªÈ¢ò
                    this.robotMessages = [
                        "ü§ñ ‰Ω†Â•ΩÔºÅÊàëÊòØÂèØ‰πêÊñπÔºÅ",
                        "ÊàëÊòØÁ≥ñÊûúÁéãÂõΩÈáåÁöÑË∂ÖÁ∫ßÂèëÊòéÂÆ∂ÔºåÁÉ≠Ë°∑Áî®Á®ÄÂ•áÂè§ÊÄ™ÁöÑÈõ∂‰ª∂ÈÄ†Âá∫Êõ¥Á®ÄÂ•áÁöÑÂ∞èÂ∑•ÂÖ∑ÔºÅ",
                        "Êúâ‰∫∫ËØ¥ÊàëÂ§¥‰∏äÁöÑ‰∏âËßíÂ∏ΩÂÖ∂ÂÆûÊòØÁÅµÊÑüÊé•Êî∂Âô®ÔºåËÉΩÊçïÊçâÊù•Ëá™Âπ≥Ë°åÂÆáÂÆôÁöÑÂàõÊÑèÊ≥¢ÊÆµÔΩû",
                        "Êô∫ÊÖßÈó™ÂÖâÔºåÁ≥ñÊûúË°åÂä®ÔºÅËÆ©Êàë‰ª¨ÂºÄÂßãËøôÂú∫ÂÜíÈô©ÂêßÔºÅüöÄ",
                        "ËØ∑ÂëäËØâÊàë‰Ω†ÁöÑÂêçÂ≠óÔºåËøôÊ†∑ÊàëÂ∞±ËÉΩÊõ¥Â•ΩÂú∞ËÆ§ËØÜ‰Ω†Âï¶ÔºÅüîç"
                    ];

                    // ‰∏∫ÂèØ‰πêÊñπËÆæÁΩÆËßÜÈ¢ëÊí≠ÊîæÂÆåÊàêÂêéÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    let isFirstVideo = true;
                    video.addEventListener('ended', () => {
                        if (isFirstVideo) {
                            // Á¨¨‰∏Ä‰∏™ËßÜÈ¢ëÊí≠ÊîæÂÆåÂêéÔºåÊí≠ÊîæÁ¨¨‰∫å‰∏™ËßÜÈ¢ë
                            video.src = 'image/robot_2_1.webm';
                            // Á°Æ‰øùÁ¨¨‰∫å‰∏™ËßÜÈ¢ëÂíåÁ¨¨‰∏Ä‰∏™ËßÜÈ¢ëÂ§ßÂ∞è‰∏ÄËá¥
                            video.style.width = '300px';
                            video.style.height = '300px';
                            video.style.objectFit = 'cover'; // Á°Æ‰øùËßÜÈ¢ëÂ°´ÂÖÖÊï¥‰∏™Âå∫Âüü
                            isFirstVideo = false;
                            video.play().catch(e => {
                                console.log('Á¨¨‰∫å‰∏™ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•');
                            });
                        }
                        // Á¨¨‰∫å‰∏™ËßÜÈ¢ëÊí≠ÊîæÂÆåÂêé‰∏çÂÅö‰ªª‰ΩïÊìç‰ΩúÔºåËÆ©ÂÆÉÂÅúÊ≠¢
                    });
                }

                // Êí≠ÊîæËßÜÈ¢ë
                video.play().catch(e => {
                    console.log('ËßÜÈ¢ëËá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÁî®Êà∑ÈúÄË¶Å‰∫§‰∫íÂêéÊí≠Êîæ');
                });

                // ÂàùÂßãÂåñÂØπËØùÊñáÊú¨
                dialogueText.textContent = '';

                // ËÆæÁΩÆËæìÂÖ•Ê°Ü‰∏ªÈ¢òÔºà‰ΩÜ‰øùÊåÅÁ¶ÅÁî®Áä∂ÊÄÅÔºâ
                const inputBubble = document.querySelector('.input-bubble');
                inputBubble.className = `input-bubble ${this.selectedRobot}`;

                // ÂºÄÂßãÊâìÂ≠óÊú∫ÊïàÊûúÂØπËØù
                this.startTypingConversation();
            }

            // ÈáçÊñ∞Ëß¶ÂèëÊ∞îÊ≥°ÂºπÂá∫Âä®Áîª
            triggerBubbleAnimation() {
                const speechBubble = document.getElementById('speechBubble');
                // ÁßªÈô§Âä®ÁîªÁ±ª
                speechBubble.style.animation = 'none';
                // Âº∫Âà∂ÈáçÊéí
                speechBubble.offsetHeight;
                // ÈáçÊñ∞Ê∑ªÂä†Âä®Áîª
                speechBubble.style.animation = 'bubblePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
            }

            async startTypingConversation() {
                const dialogueText = document.getElementById('dialogueText');
                const typingIndicator = document.getElementById('typingIndicator');

                for (let i = 0; i < this.robotMessages.length; i++) {
                    // Ëß¶ÂèëÊ∞îÊ≥°ÂºπÂá∫Âä®Áîª
                    this.triggerBubbleAnimation();

                    // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                    dialogueText.style.display = 'none';
                    typingIndicator.classList.add('show');

                    // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥Ê®°ÊãüÊÄùËÄÉ
                    await this.delay(800 + Math.random() * 400);

                    // ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®ÔºåÊòæÁ§∫ÂØπËØùÊñáÊú¨
                    typingIndicator.classList.remove('show');
                    dialogueText.style.display = 'block';

                    // Ê∏ÖÁ©∫ÊñáÊú¨ÔºåÂáÜÂ§áÊâìÂ≠óÊú∫ÊïàÊûú
                    dialogueText.textContent = '';

                    // ÊâìÂ≠óÊú∫ÊïàÊûúÊòæÁ§∫Ê∂àÊÅØ
                    await this.typeMessage(dialogueText, this.robotMessages[i]);

                    // Ê∂àÊÅØÈó¥ÁöÑÂÅúÈ°ø
                    await this.delay(1200);
                }

                // ÊâÄÊúâÊ∂àÊÅØÊòæÁ§∫ÂÆåÂêéÔºåÊòæÁ§∫ËæìÂÖ•Ê°Ü
                await this.delay(500);
                this.showInputSection();
            }

            async typeMessage(element, message) {
                const chars = message.split('');
                element.textContent = '';

                for (let char of chars) {
                    element.textContent += char;
                    // ÈöèÊú∫ÊâìÂ≠óÈÄüÂ∫¶ÔºåËÆ©ÊïàÊûúÊõ¥Ëá™ÁÑ∂
                    const delay = char === ' ' ? 30 : (50 + Math.random() * 100);
                    await this.delay(delay);
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            showInputSection() {
                const inputSection = document.getElementById('inputSection');
                const inputBubble = inputSection.querySelector('.input-bubble');
                const nameInput = document.getElementById('playerNameInput');
                const sendBtn = document.getElementById('sendBtn');

                // ËÆæÁΩÆËæìÂÖ•Ê°Ü‰∏ªÈ¢ò
                inputBubble.className = `input-bubble ${this.selectedRobot}`;

                // ÂêØÁî®ËæìÂÖ•Ê°Ü
                nameInput.disabled = false;
                nameInput.placeholder = "ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó...";
                sendBtn.disabled = true; // ÂàùÂßãÁä∂ÊÄÅÁ¶ÅÁî®ÂèëÈÄÅÊåâÈíÆ

                // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
                setTimeout(() => {
                    nameInput.focus();
                }, 200);
            }

            bindIntroEvents() {
                const nameInput = document.getElementById('playerNameInput');
                const sendBtn = document.getElementById('sendBtn');

                // ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
                nameInput.addEventListener('input', () => {
                    const name = nameInput.value.trim();
                    sendBtn.disabled = name.length === 0;
                });

                // ÂèëÈÄÅÊåâÈíÆ‰∫ã‰ª∂
                sendBtn.addEventListener('click', () => {
                    this.handleNameSubmit();
                });

                // ÂõûËΩ¶ÈîÆÂèëÈÄÅ
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleNameSubmit();
                    }
                });

                // ÂàùÂßãÁä∂ÊÄÅ
                sendBtn.disabled = true;
            }

            handleNameSubmit() {
                const nameInput = document.getElementById('playerNameInput');
                const playerName = nameInput.value.trim();

                if (playerName) {
                    // ÈöêËóèËæìÂÖ•Ê°Ü
                    document.getElementById('inputSection').style.display = 'none';

                    // ‰øùÂ≠òÁé©ÂÆ∂ÂêçÂ≠ó
                    this.playerName = playerName;

                    // Êú∫Âô®‰∫∫ÂõûÂ∫î
                    this.showRobotResponse(playerName);
                }
            }

            async showRobotResponse(playerName) {
                const dialogueText = document.getElementById('dialogueText');
                const typingIndicator = document.getElementById('typingIndicator');

                // Ëß¶ÂèëÊ∞îÊ≥°ÂºπÂá∫Âä®Áîª
                this.triggerBubbleAnimation();

                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                dialogueText.style.display = 'none';
                typingIndicator.classList.add('show');

                // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥
                await this.delay(1500);

                // ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
                typingIndicator.classList.remove('show');
                dialogueText.style.display = 'block';

                // Êú∫Âô®‰∫∫ÂõûÂ∫î
                const responseMessage = this.selectedRobot === 'robot1'
                    ? `ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†Ôºå${playerName}ÔºÅËÆ©Êàë‰ª¨‰∏ÄËµ∑ÂºÄÂßãÁ≥ñÊûúÂÜíÈô©ÂêßÔºÅüç≠‚ú®`
                    : `ÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†Ôºå${playerName}ÔºÅÂáÜÂ§áÂêØÂä®Á≥ñÊûúÂàÜÊûêÁ®ãÂ∫èÔºÅü§ñüç¨`;

                // Ê∏ÖÁ©∫ÊñáÊú¨Âπ∂ÊâìÂ≠óÊú∫ÊïàÊûúÊòæÁ§∫ÂõûÂ∫î
                dialogueText.textContent = '';
                await this.typeMessage(dialogueText, responseMessage);

                // Á≠âÂæÖ‰∏Ä‰∏ãÂêéÂºÄÂßãÊ∏∏Êàè
                setTimeout(() => {
                    this.startGame();
                }, 2000);
            }

            startGame() {
                // ÈöêËóèÊú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢
                document.getElementById('robotIntroduction').style.display = 'none';

                // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢‰ΩÜÊöÇÂÅú
                document.getElementById('gameContainer').style.display = 'block';

                // ÁªëÂÆöÊ∏∏Êàè‰∫ã‰ª∂Ôºà‰ΩÜ‰∏çÂºÄÂßãÊ∏∏ÊàèÔºâ
                this.bindEvents();

                // ÊòæÁ§∫Ê∏∏ÊàèËßÑÂàô‰ªãÁªçÁïåÈù¢
                this.showGameRules();
            }

            showGameRules() {
                const gameRulesMask = document.getElementById('gameRulesMask');
                const rulesRobotGuide = document.getElementById('rulesRobotGuide');
                const rulesRobotVideo = document.getElementById('rulesRobotVideo');
                const rulesRobotName = document.getElementById('rulesRobotName');
                const rulesSpeechBubble = document.getElementById('rulesSpeechBubble');

                // ËÆæÁΩÆÊú∫Âô®‰∫∫‰ø°ÊÅØ
                if (this.selectedRobot === 'robot1') {
                    rulesRobotVideo.src = 'image/robot_1.webm';
                    rulesRobotName.textContent = 'Ê≥¢Ê≥¢';
                    rulesSpeechBubble.className = 'rules-speech-bubble robot1';

                    // ‰∏∫ËßÑÂàôÁïåÈù¢ÁöÑÊ≥¢Ê≥¢ËßÜÈ¢ëÊ∑ªÂä†Êí≠ÊîæÂÆåÊàêÂêéÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    let isFirstRulesVideo = true;
                    rulesRobotVideo.addEventListener('ended', () => {
                        if (isFirstRulesVideo) {
                            // Á¨¨‰∏Ä‰∏™ËßÜÈ¢ëÊí≠ÊîæÂÆåÂêéÔºåÊí≠ÊîæÁ¨¨‰∫å‰∏™ËßÜÈ¢ë‰ΩÜ‰∏çÂæ™ÁéØ
                            rulesRobotVideo.src = 'image/robot_1_1.webm';
                            rulesRobotVideo.loop = false; // ‰∏çÂæ™ÁéØÊí≠Êîæ
                            rulesRobotVideo.play().catch(e => console.log('ËßÑÂàôÁïåÈù¢Á¨¨‰∫å‰∏™ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•'));
                            isFirstRulesVideo = false;
                        }
                    });
                } else {
                    rulesRobotVideo.src = 'image/robot_2.webm';
                    rulesRobotVideo.className = 'rules-robot-video robot2-video';
                    rulesRobotName.textContent = 'ÂèØ‰πêÊñπ';
                    rulesSpeechBubble.className = 'rules-speech-bubble robot2';
                }

                // Êí≠ÊîæÊú∫Âô®‰∫∫ËßÜÈ¢ë
                rulesRobotVideo.play().catch(e => {
                    console.log('ËßÑÂàôÁïåÈù¢ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•');
                });

                // ÊòæÁ§∫ËíôÁâàÂíåÊú∫Âô®‰∫∫ËØ¥Êòé
                gameRulesMask.style.display = 'block';
                rulesRobotGuide.style.display = 'flex';

                // ÁªëÂÆöËßÑÂàôÁïåÈù¢‰∫ã‰ª∂
                this.bindRulesEvents();

                // ËÆ©QWEÁ≥ñÊûú‰∫ÆËµ∑
                this.highlightManualCandies();

                // Á°Æ‰øùÊ∏∏ÊàèÁΩëÊ†ºÂ∑≤ÂàõÂª∫
                if (!document.querySelector('.grid-cell')) {
                    this.createGrid();
                }

                // ÂàùÂßãÂåñÊºîÁ§∫Áä∂ÊÄÅ
                this.demoStep = 0;
                this.demoInProgress = true;
                this.demoCandy = null;

                // ÂºÄÂßãÂàÜÊ≠•È™§‰ªãÁªç
                setTimeout(() => {
                    this.startStepByStepIntro();
                }, 1000);
            }

            bindRulesEvents() {
                const skipRulesBtn = document.getElementById('skipRulesBtn');
                const startGameBtn = document.getElementById('startGameBtn');

                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                skipRulesBtn.replaceWith(skipRulesBtn.cloneNode(true));
                startGameBtn.replaceWith(startGameBtn.cloneNode(true));

                // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†ÂºïÁî®
                const newSkipBtn = document.getElementById('skipRulesBtn');
                const newStartBtn = document.getElementById('startGameBtn');

                // Ë∑≥ËøáËØ¥ÊòéÊåâÈíÆ
                newSkipBtn.addEventListener('click', () => {
                    this.hideGameRules();
                    this.actuallyStartGame();
                });

                // ÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆ
                newStartBtn.addEventListener('click', () => {
                    this.hideGameRules();
                    this.actuallyStartGame();
                });
            }

            highlightManualCandies() {
                // QWEÊåâÈîÆ‰∏çÈúÄË¶Å‰ªª‰ΩïÈ´ò‰∫ÆÊïàÊûú
                // ÁßªÈô§ÊâÄÊúâ‰ºöÂΩ±ÂìçQWEÊåâÈîÆÂ§ñËßÇÁöÑ‰ª£Á†Å
            }

            startStepByStepIntro() {
                this.introStep = 1;
                this.showIntroStep();
                this.bindNextStepEvent();
            }

            bindNextStepEvent() {
                const nextStepBtn = document.getElementById('nextStepBtn');
                const prevStepBtn = document.getElementById('prevStepBtn');
                const skipRulesBtn = document.getElementById('skipRulesBtn');

                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                nextStepBtn.replaceWith(nextStepBtn.cloneNode(true));
                prevStepBtn.replaceWith(prevStepBtn.cloneNode(true));
                skipRulesBtn.replaceWith(skipRulesBtn.cloneNode(true));

                // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†Âπ∂ÁªëÂÆö‰∫ã‰ª∂
                const newNextBtn = document.getElementById('nextStepBtn');
                const newPrevBtn = document.getElementById('prevStepBtn');
                const newSkipBtn = document.getElementById('skipRulesBtn');

                newNextBtn.addEventListener('click', () => {
                    this.nextIntroStep();
                });

                newPrevBtn.addEventListener('click', () => {
                    this.prevIntroStep();
                });

                newSkipBtn.addEventListener('click', () => {
                    this.hideGameRules();
                    this.actuallyStartGame();
                });
            }

            showIntroStep() {
                const demoStep = document.getElementById('demoStep');
                const nextStepBtn = document.getElementById('nextStepBtn');
                const prevStepBtn = document.getElementById('prevStepBtn');
                const startGameBtn = document.getElementById('startGameBtn');

                // ÊéßÂà∂ÊåâÈíÆÊòæÁ§∫
                if (this.introStep <= 1) {
                    prevStepBtn.style.display = 'none';
                } else {
                    prevStepBtn.style.display = 'inline-block';
                }

                // ÈªòËÆ§ÊòæÁ§∫‰∏ã‰∏ÄÊ≠•ÊåâÈíÆÔºåÁâπÊÆäÊÉÖÂÜµ‰∏ãÂÜçÈöêËóè
                nextStepBtn.style.display = 'inline-block';
                startGameBtn.style.display = 'none';

                switch(this.introStep) {
                    case 1:
                        // Á¨¨‰∏ÄÊ≠•ÔºöÊ¨¢ËøéÂíå‰ªãÁªçÁî®Êà∑
                        demoStep.innerHTML = 'üç≠ Ê¨¢ËøéÊù•Âà∞Á≥ñÊûúÂêà‰ΩúÊ∏∏ÊàèÔºÅ<br><br>È¶ñÂÖàÔºåËøôÊòØ‰Ω†ÔºÅ‰Ω†ÊòØÊ∏∏Êàè‰∏≠ÁöÑÁé©ÂÆ∂„ÄÇ';
                        this.highlightElement('.character img[alt="‰Ω†"]', 'user-highlight');
                        break;

                    case 2:
                        // Á¨¨‰∫åÊ≠•Ôºö‰ªãÁªçÊú∫Âô®‰∫∫
                        const robotName = this.selectedRobot === 'robot1' ? 'Ê≥¢Ê≥¢' : 'ÂèØ‰πêÊñπ';
                        demoStep.textContent = `ËøôÊòØÊàë-${robotName}ÔºÅÊàëÊòØ‰Ω†ÁöÑÂêà‰Ωú‰ºô‰º¥ÔºåÊàë‰ª¨Ë¶Å‰∏ÄËµ∑Âêà‰ΩúÊ∂àÁÅ≠Á≥ñÊûúÔºÅ`;
                        this.clearHighlights();
                        this.highlightElement('#robotCharacter', 'robot-highlight');
                        break;

                    case 3:
                        // Á¨¨‰∏âÊ≠•Ôºö‰ªãÁªçÁî®Êà∑ÊåâÈîÆ
                        demoStep.innerHTML = `Ëøô‰∫õÊòØ‰Ω†Ë¥üË¥£ÁöÑÁ≥ñÊûúÈ¢úËâ≤Ôºö<br>
                            <span style="color: #ff6b6b; font-weight: bold;">‚óè Á∫¢Ëâ≤Á≥ñÊûú</span>Êåâ <strong>Q</strong> ÈîÆ<br>
                            <span style="color: #98FB98; font-weight: bold;">‚óè ÊµÖÁªøËâ≤Á≥ñÊûú</span>Êåâ <strong>W</strong> ÈîÆ<br>
                            <span style="color: #ff8cc8; font-weight: bold;">‚óè Á≤âËâ≤Á≥ñÊûú</span>Êåâ <strong>E</strong> ÈîÆ`;
                        this.clearHighlights();
                        this.highlightElement('.manual-controls', 'manual-highlight');
                        break;

                    case 4:
                        // Á¨¨ÂõõÊ≠•Ôºö‰ªãÁªçÊú∫Âô®‰∫∫ÊåâÈîÆ
                        const robotName2 = this.selectedRobot === 'robot1' ? 'Ê≥¢Ê≥¢' : 'ÂèØ‰πêÊñπ';
                        demoStep.innerHTML = `Ëøô‰∫õÊòØÊàë-${robotName2}Ë¥üË¥£ÁöÑÁ≥ñÊûúÈ¢úËâ≤Ôºö<br>
                            <span style="color: #4169E1; font-weight: bold;">‚óè ËìùËâ≤Á≥ñÊûú</span>Êåâ <strong>7</strong> ÈîÆ<br>
                            <span style="color: #FFD700; font-weight: bold;">‚óè ÈªÑËâ≤Á≥ñÊûú</span>Êåâ <strong>8</strong> ÈîÆ<br>
                            <span style="color: #006400; font-weight: bold;">‚óè Ê∑±ÁªøËâ≤Á≥ñÊûú</span>Êåâ <strong>9</strong> ÈîÆ`;
                        this.clearHighlights();
                        this.highlightElement('.auto-controls', 'auto-highlight');
                        break;

                    case 5:
                        // Á¨¨‰∫îÊ≠•ÔºöËØÑÂàÜËßÑÂàô
                        demoStep.innerHTML = `‚ö° <strong>ËØÑÂàÜËßÑÂàôÔºö</strong><br>
                            ‚úÖ ÂèçÂ∫îË∂äÂø´ÔºåÂàÜÊï∞Ë∂äÈ´òÔºÅ<br>
                            ‚ùå ÊåâÈîôÊåâÈîÆ‰ºöÊâ£ÂæàÂ§öÂàÜÔºÅ<br>
                            ‚è∞ Ê∏∏ÊàèÊó∂Èó¥Ôºö5ÂàÜÈíü<br>
                            üéØ ÁõÆÊ†áÔºöÂ∞ΩÂèØËÉΩÂ§öÊãøÂàÜÔºÅ`;
                        this.clearHighlights();
                        this.highlightElement('.score', 'score-highlight');
                        this.highlightElement('.timer-container', 'timer-highlight');
                        break;

                    case 6:
                        // Á¨¨ÂÖ≠Ê≠•ÔºöÊ≠£Á°ÆÊºîÁ§∫
                        demoStep.textContent = 'Áé∞Âú®ËØïËØïÁúãÔºÅÊàëÂú®Ê∏∏ÊàèÂå∫ÂüüÊîæ‰∫Ü‰∏Ä‰∏™Á∫¢Ëâ≤Á≥ñÊûúÔºåËØ∑Êåâ Q ÈîÆÊ∂àÈô§ÂÆÉÔºÅ';
                        this.clearHighlights();
                        nextStepBtn.style.display = 'none';
                        this.startCorrectDemo();
                        break;

                    case 7:
                        // Á¨¨‰∏ÉÊ≠•ÔºöÈîôËØØÊºîÁ§∫
                        demoStep.textContent = 'Áé∞Âú®ÊàëÊîæ‰∏Ä‰∏™ËìùËâ≤Á≥ñÊûúÔºåËøôÊòØÊàëË¥üË¥£ÁöÑÔºå‰Ω†ËØïËØïÊåâQÈîÆÁúãÁúã‰ºöÊÄéÊ†∑...';
                        this.startWrongDemo();
                        break;

                    case 8:
                        // ÂÆåÊàêÊïôÁ®ã
                        demoStep.innerHTML = 'üéâ ÊïôÁ®ãÂÆåÊàêÔºÅÁé∞Âú®‰Ω†Áü•ÈÅì‰∫ÜÔºö<br>‚úÖ Âø´ÈÄüÂèçÂ∫îÂæóÈ´òÂàÜ<br>‚ùå ÊåâÈîô‰ºöÊâ£ÂàÜ<br>üéØ 5ÂàÜÈíüÂÜÖÂ∞ΩÂèØËÉΩÂ§öÊãøÂàÜÔºÅ';
                        this.clearHighlights();
                        nextStepBtn.style.display = 'none';
                        startGameBtn.style.display = 'inline-block';
                        this.bindStartGameEvent();
                        break;
                }
            }

            nextIntroStep() {
                this.introStep++;
                this.showIntroStep();
            }

            prevIntroStep() {
                if (this.introStep > 1) {
                    this.introStep--;
                    this.clearHighlights();
                    this.clearDemoElements();
                    this.showIntroStep();
                }
            }

            clearDemoElements() {
                // Ê∏ÖÈô§ÊºîÁ§∫Á≥ñÊûú
                if (this.demoCandy && this.demoCandy.element) {
                    this.demoCandy.element.remove();
                    this.demoCandy = null;
                }

                // Ê∏ÖÈô§ÊâÄÊúâÊºîÁ§∫Áõ∏ÂÖ≥ÁöÑÂÖÉÁ¥†
                const demoCandies = document.querySelectorAll('.demo-candy');
                demoCandies.forEach(candy => candy.remove());

                // ÈáçÁΩÆÊ∏∏ÊàèÁΩëÊ†º
                const cells = document.querySelectorAll('.grid-cell');
                cells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.className = 'grid-cell';
                });
            }

            highlightElement(selector, className) {
                const element = document.querySelector(selector);
                if (element) {
                    element.classList.add(className);
                }
            }

            clearHighlights() {
                const highlights = document.querySelectorAll('.user-highlight, .robot-highlight, .manual-highlight, .auto-highlight, .score-highlight, .timer-highlight');
                highlights.forEach(el => {
                    el.classList.remove('user-highlight', 'robot-highlight', 'manual-highlight', 'auto-highlight', 'score-highlight', 'timer-highlight');
                });
            }

            startCorrectDemo() {
                // Âú®Ê∏∏ÊàèÁΩëÊ†º‰∏≠ÁîüÊàê‰∏Ä‰∏™Á∫¢Ëâ≤ÊºîÁ§∫Á≥ñÊûú
                this.spawnDemoCandy('red', 7);

                // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥Áî®‰∫éËÆ°ÁÆóÂèçÂ∫îÊó∂Èó¥
                this.demoStartTime = Date.now();

                // ÁõëÂê¨QÈîÆÊåâ‰∏ã
                this.waitForKeyPress('q', 'correct');
            }

            startWrongDemo() {
                // Âú®Ê∏∏ÊàèÁΩëÊ†º‰∏≠ÁîüÊàê‰∏Ä‰∏™ËìùËâ≤ÊºîÁ§∫Á≥ñÊûú
                this.spawnDemoCandy('blue', 15);

                // ÁõëÂê¨QÈîÆÊåâ‰∏ãÔºàËøôÊ¨°ÊòØÈîôËØØÁöÑÔºâ
                this.waitForKeyPress('q', 'wrong');
            }

            bindStartGameEvent() {
                const startGameBtn = document.getElementById('startGameBtn');
                startGameBtn.addEventListener('click', () => {
                    this.hideGameRules();
                    this.actuallyStartGame();
                });
            }

            spawnDemoCandy(color = 'red', position = 7) {
                // Ê∏ÖÁêÜ‰πãÂâçÁöÑÊºîÁ§∫Á≥ñÊûú
                if (this.demoCandy && this.demoCandy.cell) {
                    this.demoCandy.cell.innerHTML = '';
                    this.demoCandy.cell.className = 'grid-cell';
                }

                const cell = document.querySelector(`[data-index="${position}"]`);

                if (cell) {
                    // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÁ≥ñÊûú
                    cell.innerHTML = '';
                    cell.className = 'grid-cell';

                    // ÂàõÂª∫Á≥ñÊûú
                    const candy = document.createElement('div');
                    candy.className = `candy ${color} demo-candy-active`;

                    // ËÆæÁΩÆÁ≥ñÊûúÂõæÁâá
                    const imageMap = {
                        'red': 'image/red.png',
                        'blue': 'image/blue.png',
                        'green': 'image/light_green.png',
                        'pink': 'image/pink.png',
                        'yellow': 'image/yellow.png',
                        'darkgreen': 'image/deep_green.png'
                    };

                    candy.style.backgroundImage = `url("${imageMap[color]}")`;

                    // Ê∑ªÂä†Âà∞Ê†ºÂ≠ê‰∏≠
                    cell.appendChild(candy);

                    // ËÆ∞ÂΩïÊºîÁ§∫Á≥ñÊûú‰ø°ÊÅØ
                    this.demoCandy = {
                        element: candy,
                        cell: cell,
                        position: position,
                        color: color
                    };

                    // Ê∑ªÂä†Èó™ÁÉÅÊïàÊûú
                    candy.classList.add('demo-highlight');
                }
            }

            waitForKeyPress(expectedKey, demoType) {
                const handleKeyPress = (e) => {
                    if (e.key.toLowerCase() === expectedKey && this.demoInProgress) {
                        document.removeEventListener('keydown', handleKeyPress);
                        this.handleDemoKeyPress(expectedKey, demoType);
                    }
                };

                document.addEventListener('keydown', handleKeyPress);
            }

            handleDemoKeyPress(key, demoType) {
                const demoStep = document.getElementById('demoStep');
                const nextStepBtn = document.getElementById('nextStepBtn');

                if (demoType === 'correct' && key === 'q' && this.demoCandy && this.demoCandy.color === 'red') {
                    // ËÆ°ÁÆóÂèçÂ∫îÊó∂Èó¥
                    const reactionTime = Date.now() - this.demoStartTime;

                    // Ê†πÊçÆÂèçÂ∫îÊó∂Èó¥ËÆ°ÁÆóÂæóÂàÜÔºà‰ΩøÁî®Ê∏∏Êàè‰∏≠ÁöÑËÆ°ÁÆóÊñπÊ≥ïÔºâ
                    const earnedScore = this.calculateScore(reactionTime);

                    // Ê≠£Á°ÆÊºîÁ§∫ÔºöÁ∫¢Ëâ≤Á≥ñÊûúÊåâQÈîÆ - ÊòæÁ§∫ÁªøËâ≤È´ò‰∫ÆÔºàÊ≠£Á°ÆÔºâ
                    this.highlightKey(key, true);
                    this.playPopSound();
                    this.showDemoScore(earnedScore, '#4CAF50', reactionTime);

                    // ‰ΩøÁî®ÂíåÊ≠£ÂºèÊ∏∏ÊàèÁõ∏ÂêåÁöÑÁ≥ñÊûúÊ∂àÂ§±Âä®Áîª
                    this.playCandyDestroyAnimation(this.demoCandy.position, () => {
                        if (this.demoCandy && this.demoCandy.cell) {
                            this.demoCandy.cell.innerHTML = '';
                            this.demoCandy.cell.className = 'grid-cell';
                        }

                        demoStep.innerHTML = `üéâ Â§™Â•Ω‰∫ÜÔºÅ‰Ω†ÊåâÂØπ‰∫ÜÔºÅ<br>Á≥ñÊûúÊ∂àÂ§±‰∫ÜÔºåËé∑Âæó‰∫Ü+${earnedScore}ÂàÜÔºÅ<br>ÂèçÂ∫îÊó∂Èó¥Ôºö${reactionTime}ms<br><small style="color: #666;">üí° ÂèçÂ∫îË∂äÂø´ÂàÜÊï∞Ë∂äÈ´òÔºåÂèçÂ∫îË∂äÊÖ¢ÂàÜÊï∞Ë∂ä‰ΩéÂì¶</small>`;
                        nextStepBtn.style.display = 'inline-block';
                        this.demoCandy = null;
                    });

                } else if (demoType === 'wrong' && key === 'q' && this.demoCandy && this.demoCandy.color === 'blue') {
                    // ÈîôËØØÊºîÁ§∫ÔºöËìùËâ≤Á≥ñÊûúÊåâQÈîÆ - ÊòæÁ§∫Á∫¢Ëâ≤È´ò‰∫ÆÔºàÈîôËØØÔºâ
                    this.highlightKey(key, false);
                    this.playErrorSound();
                    this.demoCandy.element.style.animation = 'errorShake 0.5s ease-out forwards';
                    this.showDemoScore(-50, '#F44336');

                    setTimeout(() => {
                        demoStep.innerHTML = '‚ùå ÂìéÂëÄÔºÅÊåâÈîô‰∫ÜÔºÅ<br>ËìùËâ≤Á≥ñÊûúÊòØÊàëË¥üË¥£ÁöÑÔºåÊâ£‰∫Ü50ÂàÜÔºÅ<br>ËÆ∞‰ΩèÔºöÂè™Êåâ‰Ω†Ë¥üË¥£ÁöÑÈ¢úËâ≤ÔºÅ';
                        nextStepBtn.style.display = 'inline-block';
                    }, 500);
                }
            }

            showDemoScore(points = 10, color = '#4CAF50', reactionTime = null) {
                // Âú®Á≥ñÊûú‰ΩçÁΩÆÊòæÁ§∫ÂàÜÊï∞ÊïàÊûú
                if (this.demoCandy && this.demoCandy.cell) {
                    const scoreEffect = document.createElement('div');
                    scoreEffect.className = 'score-effect';

                    // Â¶ÇÊûúÊúâÂèçÂ∫îÊó∂Èó¥ÔºåÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ
                    if (reactionTime !== null) {
                        scoreEffect.innerHTML = `
                            <div style="font-size: 24px; font-weight: bold; color: ${color};">
                                ${points > 0 ? `+${points}` : `${points}`}
                            </div>
                            <div style="font-size: 14px; color: #666; margin-top: 2px;">
                                ${reactionTime}ms
                            </div>
                        `;
                    } else {
                        scoreEffect.textContent = points > 0 ? `+${points}` : `${points}`;
                        scoreEffect.style.color = color;
                        scoreEffect.style.fontSize = '24px';
                        scoreEffect.style.fontWeight = 'bold';
                    }

                    scoreEffect.style.position = 'absolute';
                    scoreEffect.style.zIndex = '2000';
                    scoreEffect.style.animation = 'scoreFloat 1s ease-out forwards';
                    scoreEffect.style.pointerEvents = 'none';
                    scoreEffect.style.textAlign = 'center';

                    // Ëé∑ÂèñÁ≥ñÊûú‰ΩçÁΩÆ
                    const rect = this.demoCandy.cell.getBoundingClientRect();
                    scoreEffect.style.left = rect.left + rect.width / 2 - 15 + 'px';
                    scoreEffect.style.top = rect.top - 10 + 'px';

                    document.body.appendChild(scoreEffect);

                    // 1ÁßíÂêéÁßªÈô§
                    setTimeout(() => {
                        if (scoreEffect.parentNode) {
                            scoreEffect.parentNode.removeChild(scoreEffect);
                        }
                    }, 1000);
                }

                // Êõ¥Êñ∞ÂàÜÊï∞ÊòæÁ§∫ÔºàÊºîÁ§∫Áî®Ôºâ
                const scoreElement = document.getElementById('score');
                const currentScore = parseInt(scoreElement.textContent) || 0;
                scoreElement.textContent = currentScore + points;
            }

            playErrorSound() {
                // Êí≠ÊîæÈîôËØØÈü≥ÊïàÔºàÂèØ‰ª•ÊòØ‰∏çÂêåÁöÑÈü≥ÊïàÔºâ
                if (!this.audioContext) return;

                // ÂàõÂª∫ÈîôËØØÈü≥ÊïàÔºà‰ΩéÈ¢ëÂó°Âó°Â£∞Ôºâ
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, this.audioContext.currentTime + 0.3);

                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.3);
            }

            hideGameRules() {
                const gameRulesMask = document.getElementById('gameRulesMask');
                const rulesRobotGuide = document.getElementById('rulesRobotGuide');

                gameRulesMask.style.display = 'none';
                rulesRobotGuide.style.display = 'none';

                // ÁªìÊùüÊºîÁ§∫
                this.demoInProgress = false;

                // Ê∏ÖÁêÜÊºîÁ§∫Á≥ñÊûú
                if (this.demoCandy && this.demoCandy.cell) {
                    this.demoCandy.cell.innerHTML = '';
                    this.demoCandy.cell.className = 'grid-cell';
                    this.demoCandy = null;
                }

                // Ê∏ÖÁêÜÊâÄÊúâÈ´ò‰∫ÆÊïàÊûú
                this.clearHighlights();

                // ÁßªÈô§ÊåâÈîÆÈ´ò‰∫ÆÊïàÊûú
                const manualKeys = document.querySelectorAll('[data-key="q"], [data-key="w"], [data-key="e"]');
                manualKeys.forEach(key => {
                    key.classList.remove('highlighted', 'demo-flashing');
                });

                const candyIcons = document.querySelectorAll('.manual-controls .candy-icon');
                candyIcons.forEach(icon => {
                    icon.style.filter = '';
                });

                // ÈáçÁΩÆÂàÜÊï∞ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                document.getElementById('score').textContent = '0';
            }

            async actuallyStartGame() {
                try {
                    // Á°Æ‰øùÁî®Êà∑Â∑≤Ê≥®ÂÜå
                    await this.ensureUserRegistered();

                    // ÂàõÂª∫Ê∏∏Êàè‰ºöËØù
                    await this.createGameSession();

                    // ÈöêËóèÂºÄÂßãËèúÂçï
                    document.getElementById('startMenu').style.display = 'none';

                    // ËÆæÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
                    this.menuState = 'game';

                    // ÊòæÁ§∫Ë∑≥ËøáÊåâÈíÆÔºàÂú®Ê≠£ÂºèÊ∏∏ÊàèÁïåÈù¢Ôºâ
                    document.getElementById('skipButton').style.display = 'block';

                    // ËÆ∞ÂΩïÊ∏∏ÊàèÂºÄÂßãÊó∂Èó¥
                    this.gameStartTime = Date.now();

                    // ËÆ∞ÂΩïÊ∏∏ÊàèÂºÄÂßã‰∫ã‰ª∂
                    this.recordGameEvent('game_start', {
                        robot_type: this.selectedRobot,
                        player_name: this.playerName
                    });

                    // ÂºÄÂßãÂÄíËÆ°Êó∂ÂíåÊ∏∏Êàè
                    this.startCountdown();

                    console.log('Ê∏∏ÊàèÊ≠£ÂºèÂºÄÂßãÔºÅ');
                } catch (error) {
                    console.error('ÂêØÂä®Ê∏∏ÊàèÂ§±Ë¥•:', error);
                    alert('ÂêØÂä®Ê∏∏ÊàèÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }

            // Á°Æ‰øùÁî®Êà∑Â∑≤Ê≥®ÂÜå
            async ensureUserRegistered() {
                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂàõÂª∫Ê®°ÊãüÁî®Êà∑‰ø°ÊÅØ
                if (this.localTestMode) {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂàõÂª∫Ê®°ÊãüÁî®Êà∑‰ø°ÊÅØ');
                    this.userInfo = {
                        user_id: 'test-user-' + Date.now(),
                        username: this.playerName || 'ÊµãËØïÁé©ÂÆ∂',
                        created_at: new Date().toISOString()
                    };
                    console.log('Ê®°ÊãüÁî®Êà∑‰ø°ÊÅØ:', this.userInfo);
                    return;
                }

                // ÂÖàÂ∞ùËØï‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁî®Êà∑
                let user = this.apiClient.loadUserFromStorage();

                if (!user && this.playerName) {
                    // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑‰∏îÊúâÁé©ÂÆ∂ÂêçÂ≠óÔºåÂàôÊ≥®ÂÜåÊñ∞Áî®Êà∑
                    console.log('Ê≥®ÂÜåÊñ∞Áî®Êà∑:', this.playerName);
                    const response = await this.apiClient.registerUser(this.playerName);
                    user = response.data;
                }

                if (!user) {
                    throw new Error('Áî®Êà∑Ê≥®ÂÜåÂ§±Ë¥•');
                }

                this.userInfo = user;
                console.log('Áî®Êà∑‰ø°ÊÅØ:', this.userInfo);
            }

            // ÂàõÂª∫Ê∏∏Êàè‰ºöËØù
            async createGameSession() {
                if (!this.userInfo) {
                    throw new Error('Áî®Êà∑‰ø°ÊÅØ‰∏çÂ≠òÂú®');
                }

                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂàõÂª∫Ê®°ÊãüÊ∏∏Êàè‰ºöËØù
                if (this.localTestMode) {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂàõÂª∫Ê®°ÊãüÊ∏∏Êàè‰ºöËØù');
                    this.gameSession = {
                        session_id: 'test-session-' + Date.now(),
                        user_id: this.userInfo.user_id || 'test-user',
                        robot_type: this.selectedRobot,
                        created_at: new Date().toISOString()
                    };
                    console.log('Ê®°ÊãüÊ∏∏Êàè‰ºöËØùÂàõÂª∫ÊàêÂäü:', this.gameSession);
                    return;
                }

                console.log('ÂàõÂª∫Ê∏∏Êàè‰ºöËØù:', this.userInfo.user_id, this.selectedRobot);
                const response = await this.apiClient.startGameSession(
                    this.userInfo.user_id,
                    this.selectedRobot
                );

                this.gameSession = response.data;
                console.log('Ê∏∏Êàè‰ºöËØùÂàõÂª∫ÊàêÂäü:', this.gameSession);
            }

            // ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂
            async recordGameEvent(eventType, eventData = {}) {
                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                if (this.localTestMode) {
                    console.log('üîß Êú¨Âú∞ÊµãËØïÊ®°Âºè - Ê∏∏Êàè‰∫ã‰ª∂:', eventType, eventData);
                    return;
                }

                try {
                    await this.apiClient.recordGameEvent(eventType, eventData);
                } catch (error) {
                    console.error('ËÆ∞ÂΩïÊ∏∏Êàè‰∫ã‰ª∂Â§±Ë¥•:', error);
                    // ‰∏çÊäõÂá∫ÈîôËØØÔºåÈÅøÂÖçÂΩ±ÂìçÊ∏∏ÊàèÊµÅÁ®ã
                }
            }

            initAudio() {
                // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Èü≥È¢ë‰∏çÊîØÊåÅ');
                }
            }

            initBackgroundMusic() {
                this.bgMusic = document.getElementById('bgMusic');
                this.bgMusic.volume = 0.3; // ËÆæÁΩÆÈü≥Èáè‰∏∫30%

                // Á´ãÂç≥Êí≠ÊîæÈü≥‰πê
                this.bgMusic.play().catch(e => {
                    console.log('ÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÊâçËÉΩÊí≠ÊîæÈü≥‰πê');
                    // Ê∑ªÂä†‰∏ÄÊ¨°ÊÄßÁÇπÂáª‰∫ã‰ª∂Êù•ÂêØÂä®Èü≥‰πê
                    const startMusic = () => {
                        this.bgMusic.play();
                        document.removeEventListener('click', startMusic);
                    };
                    document.addEventListener('click', startMusic);
                });
            }

            playBackgroundMusic() {
                if (this.bgMusic && !this.isMuted) {
                    this.bgMusic.play().catch(e => console.log('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•'));
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                const volumeBtn = document.getElementById('volumeBtn');

                if (this.isMuted) {
                    this.bgMusic.pause();
                    volumeBtn.textContent = 'üîá';
                } else {
                    this.bgMusic.play().catch(e => console.log('ËÉåÊôØÈü≥‰πêÊí≠ÊîæÂ§±Ë¥•'));
                    volumeBtn.textContent = 'üîä';
                }
            }

            bindControlEvents() {
                // Èü≥ÈáèÊéßÂà∂ÊåâÈíÆ
                document.getElementById('volumeBtn').addEventListener('click', () => {
                    this.toggleMute();
                });

                // Ë∑≥ËøáÊåâÈíÆ
                document.getElementById('skipBtn').addEventListener('click', () => {
                    this.skipToEnd();
                });

                // Êï∞ÊçÆÊµãËØïÊåâÈíÆÔºàÂºÄÂèëÁî®Ôºâ
                document.getElementById('testDataBtn').addEventListener('click', () => {
                    console.log('ÂΩìÂâçÊ∏∏ÊàèÊï∞ÊçÆ:', this.gameData);
                    alert('Êï∞ÊçÆÂ∑≤ËæìÂá∫Âà∞ÊéßÂà∂Âè∞ÔºåÊåâF12Êü•Áúã');
                });

                // Âú®ÂºÄÂèëÊ®°Âºè‰∏ãÊòæÁ§∫ÊµãËØïÊåâÈíÆÔºàÂèØ‰ª•ÈÄöËøáURLÂèÇÊï∞ÊéßÂà∂Ôºâ
                if (window.location.search.includes('debug=true')) {
                    document.getElementById('dataTestControl').style.display = 'block';
                }
            }

            playPopSound() {
                if (!this.audioContext) return;

                // ÂàõÂª∫"pa"Èü≥Êïà
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // ËÆæÁΩÆÈü≥È¢ëÂèÇÊï∞
                oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, this.audioContext.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.1);
            }

            playErrorSound() {
                if (!this.audioContext) return;

                // ÂàõÂª∫ÈîôËØØÈü≥Êïà - ‰ΩéÊ≤âÁöÑ"buzz"Â£∞
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // ËÆæÁΩÆÈü≥È¢ëÂèÇÊï∞ - ‰ΩéÈ¢ëÈúáÂä®Èü≥
                oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(120, this.audioContext.currentTime + 0.05);
                oscillator.frequency.setValueAtTime(100, this.audioContext.currentTime + 0.1);

                gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.15);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.15);
            }

            playCountdownSound() {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);

                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.2);
            }

            playStartSound() {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(1000, this.audioContext.currentTime + 0.2);

                gainNode.gain.setValueAtTime(0.4, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.4);
            }

            startCountdown() {
                const countdownEl = document.getElementById('countdown');
                countdownEl.style.display = 'block';
                countdownEl.className = 'countdown';

                let count = 3;
                const countdown = () => {
                    if (count > 0) {
                        // Ê∑ªÂä†Êï∞Â≠óÂä®Áîª
                        countdownEl.className = 'countdown number-animation';
                        countdownEl.textContent = count;

                        // Êí≠ÊîæÂÄíËÆ°Êó∂Èü≥Êïà
                        this.playCountdownSound();

                        count--;
                        setTimeout(countdown, 1000);
                    } else {
                        // ÊòæÁ§∫"ÂºÄÂßã!"Âπ∂Ê∑ªÂä†ÁâπÊÆäÂä®Áîª
                        countdownEl.className = 'countdown start-animation';
                        countdownEl.textContent = 'ÂºÄÂßã!';

                        // Êí≠ÊîæÂºÄÂßãÈü≥Êïà
                        this.playStartSound();

                        setTimeout(() => {
                            countdownEl.style.display = 'none';
                            this.gameStarted = true;

                            // ËÆ∞ÂΩïÊ∏∏ÊàèÂºÄÂßã‰∫ã‰ª∂
                            this.recordGameEvent('game_start', {
                                selectedRobot: this.selectedRobot,
                                playerName: this.playerName || this.userInfo?.name || 'Êú™Áü•'
                            });

                            this.startGameTimer();
                            this.spawnCandy();
                        }, 1000);
                    }
                };
                countdown();
            }

            createGrid() {
                const gameGrid = document.getElementById('gameGrid');
                gameGrid.innerHTML = '';

                for (let i = 0; i < 40; i++) { // 8x5 = 40 cells
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.index = i;
                    gameGrid.appendChild(cell);
                    this.grid.push(null);
                }
            }

            spawnCandy() {
                // Â¶ÇÊûúÊ∏∏ÊàèËøòÊ≤°ÂºÄÂßãÊàñÂ∑≤ÁªèÊúâÁ≥ñÊûúÂ≠òÂú®Ôºå‰∏çÁîüÊàêÊñ∞ÁöÑ
                if (!this.gameStarted || this.currentCandy) return;

                // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Á©∫‰ΩçÁΩÆ
                const emptyCells = this.grid.map((cell, index) => cell === null ? index : null)
                                           .filter(index => index !== null);

                if (emptyCells.length === 0) return;

                const randomIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const randomColor = this.colors[Math.floor(Math.random() * this.colors.length)];

                this.grid[randomIndex] = randomColor;
                this.currentCandy = {
                    index: randomIndex,
                    color: randomColor,
                    spawnTime: Date.now()
                };

                // ËÆ∞ÂΩïÁ≥ñÊûúÁîüÊàê‰∫ã‰ª∂
                this.recordGameEvent('candy_spawn', {
                    candyColor: randomColor,
                    candyIndex: randomIndex,
                    candyPosition: this.getCandyPosition(randomIndex),
                    spawnTime: this.currentCandy.spawnTime
                });

                this.renderCandy(randomIndex, randomColor);

                // Â¶ÇÊûúÊòØËá™Âä®ÁÇπÂáªÁöÑÈ¢úËâ≤ÔºåÁ´ãÂç≥Êí≠ÊîæÊú∫Âô®‰∫∫Âä®ÁîªÂπ∂ËÆæÁΩÆËá™Âä®ÁÇπÂáª
                if (this.autoColors.includes(randomColor)) {
                    this.playRobotGif();
                    this.scheduleAutoClick(randomColor);
                }
            }

            renderCandy(index, color) {
                const cell = document.querySelector(`[data-index="${index}"]`);
                const candy = document.createElement('div');
                candy.className = `candy ${color}`;
                cell.innerHTML = '';
                cell.appendChild(candy);
            }

            playCandyDestroyAnimation(index, callback) {
                const cell = document.querySelector(`[data-index="${index}"]`);
                const candy = cell.querySelector('.candy');

                if (!candy) {
                    callback();
                    return;
                }

                // Ê∑ªÂä†ÁàÜÁÇ∏Âä®ÁîªÁ±ª
                candy.classList.add('popping');

                // Âä®ÁîªÂÆåÊàêÂêéÊâßË°åÂõûË∞É
                setTimeout(callback, 400);
            }

            calculateScore(reactionTime) {
                // Âü∫Á°ÄÂàÜÊï∞100ÂàÜ
                const baseScore = 100;
                // ÁêÜÊÉ≥ÂèçÂ∫îÊó∂Èó¥500msÔºåË∂ÖËøáÊ≠§Êó∂Èó¥ÂàÜÊï∞ÂºÄÂßãÂø´ÈÄüÈÄíÂáè
                const idealTime = 500;
                // ÈÄíÂáèÁ≥ªÊï∞ÔºåÊéßÂà∂ÂàÜÊï∞‰∏ãÈôçÈÄüÂ∫¶
                const decayRate = 0.003;

                if (reactionTime <= idealTime) {
                    // ÂèçÂ∫îÊó∂Èó¥Âú®ÁêÜÊÉ≥ËåÉÂõ¥ÂÜÖÔºåÁªô‰∫àÊª°ÂàÜÊàñÂ•ñÂä±ÂàÜ
                    const bonus = Math.max(0, (idealTime - reactionTime) / 10);
                    return Math.round(baseScore + bonus);
                } else {
                    // ÂèçÂ∫îÊó∂Èó¥Ë∂ÖËøáÁêÜÊÉ≥Êó∂Èó¥ÔºåÊåâË¥üÊåáÊï∞ÂáΩÊï∞ÈÄíÂáè
                    const excessTime = reactionTime - idealTime;
                    const score = baseScore * Math.exp(-decayRate * excessTime);
                    return Math.max(1, Math.round(score)); // ÊúÄ‰Ωé1ÂàÜ
                }
            }

            handleWrongKey(pressedColor) {
                if (!this.gameStarted || !this.currentCandy) return;

                // Êí≠ÊîæÈîôËØØÈü≥Êïà
                this.playErrorSound();

                // ÈîôËØØÊåâÈîÆÊâ£ÂàÜÔºöÂõ∫ÂÆöÊâ£50ÂàÜÔºåÁÆÄÂçïÊòé‰∫Ü
                const penalty = 50;
                const oldScore = this.score;

                this.score = Math.max(0, this.score - penalty); // ÂàÜÊï∞‰∏çËÉΩ‰∏∫Ë¥ü

                // ËÆ∞ÂΩïÈîôËØØÊåâÈîÆ‰∫ã‰ª∂
                this.recordGameEvent('key_press_wrong', {
                    candyColor: this.currentCandy.color,
                    candyIndex: this.currentCandy.index,
                    candyPosition: this.getCandyPosition(this.currentCandy.index),
                    keyPressed: Object.keys(this.keyMap).find(key => this.keyMap[key] === pressedColor),
                    reactionTime: Date.now() - this.currentCandy.spawnTime,
                    scoreChange: -penalty,
                    isCorrect: false,
                    currentScore: this.score
                });

                // ÊòæÁ§∫Êâ£ÂàÜÊèêÁ§∫
                this.showPenaltyPopup(penalty, this.currentCandy.index);
                this.updateScore();
            }

            scheduleAutoClick(color) {
                // Âú®1000-1300ms‰πãÈó¥ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Êó∂Èó¥Ëá™Âä®ÁÇπÂáª
                const autoClickTime = 1000 + Math.random() * 300;

                this.autoClickTimeout = setTimeout(() => {
                    // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶‰ªçÂú®ËøõË°åÔºåÁ≥ñÊûúÊòØÂê¶ËøòÂ≠òÂú®‰∏îÈ¢úËâ≤ÂåπÈÖç
                    if (this.gameStarted && this.currentCandy && this.currentCandy.color === color) {
                        // ÊâæÂà∞ÂØπÂ∫îÁöÑÊåâÈîÆÂπ∂È´ò‰∫Æ
                        const keyForColor = Object.keys(this.keyMap).find(key => this.keyMap[key] === color);
                        if (keyForColor) {
                            this.highlightKey(keyForColor, true); // ÊòæÁ§∫‰∏∫Ê≠£Á°ÆÊåâÈîÆ
                        }
                        this.destroyCandy(color, true); // trueË°®Á§∫ÊòØËá™Âä®ÁÇπÂáª
                    }
                }, autoClickTime);
            }

            destroyCandy(color, isAutoClick = false) {
                // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶Â∑≤ÂºÄÂßã
                if (!this.gameStarted) return;

                // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçÁ≥ñÊûú
                if (!this.currentCandy) {
                    // Ê≤°ÊúâÁ≥ñÊûúÊó∂ÊåâÈîÆ‰∏çÊâ£ÂàÜÔºåÁõ¥Êé•ËøîÂõû
                    return;
                }

                // Â¶ÇÊûúÊòØÊâãÂä®ÊåâÈîÆ‰ΩÜÁ≥ñÊûúÊòØËá™Âä®ÁÇπÂáªÁ±ªÂûãÔºåÂàôÊâ£ÂàÜ
                if (!isAutoClick && this.autoColors.includes(this.currentCandy.color)) {
                    this.handleWrongKey(color);
                    return;
                }

                // Â¶ÇÊûúÊòØËá™Âä®ÁÇπÂáªÔºåÊ∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑËá™Âä®ÁÇπÂáªÂÆöÊó∂Âô®
                if (isAutoClick && this.autoClickTimeout) {
                    clearTimeout(this.autoClickTimeout);
                    this.autoClickTimeout = null;
                }

                // Ê£ÄÊü•ÊåâÈîÆÊòØÂê¶Ê≠£Á°Æ
                if (this.currentCandy.color === color) {
                    // Ê≠£Á°ÆÊåâÈîÆ - Êí≠ÊîæÈü≥ÊïàÂíåÂä®Áîª
                    const reactionTime = Date.now() - this.currentCandy.spawnTime;
                    const index = this.currentCandy.index;
                    const earnedScore = this.calculateScore(reactionTime);

                    // ËÆ∞ÂΩïÊ≠£Á°ÆÊåâÈîÆ‰∫ã‰ª∂
                    this.recordGameEvent('key_press_correct', {
                        candyColor: this.currentCandy.color,
                        candyIndex: index,
                        candyPosition: this.getCandyPosition(index),
                        keyPressed: Object.keys(this.keyMap).find(key => this.keyMap[key] === color),
                        reactionTime: reactionTime,
                        scoreChange: earnedScore,
                        isCorrect: true,
                        currentScore: this.score + earnedScore,
                        isAutoClick: isAutoClick
                    });

                    // Êí≠ÊîæÈü≥Êïà
                    this.playPopSound();

                    // Ê∑ªÂä†Ê∂àÂ§±Âä®Áîª
                    this.playCandyDestroyAnimation(index, () => {
                        // Âä®ÁîªÂÆåÊàêÂêéÊ∏ÖÈô§Á≥ñÊûú
                        this.grid[index] = null;
                        const cell = document.querySelector(`[data-index="${index}"]`);
                        cell.innerHTML = '';

                        // Ê†πÊçÆÂèçÂ∫îÊó∂Èó¥ËÆ°ÁÆóÂàÜÊï∞
                        this.score += earnedScore;

                        // ÊòæÁ§∫ÂæóÂàÜÂíåÂèçÂ∫îÊó∂Èó¥
                        this.showScorePopup(earnedScore, reactionTime, index);
                        this.updateScore();

                        // Ê∏ÖÈô§ÂΩìÂâçÁ≥ñÊûúËÆ∞ÂΩï
                        this.currentCandy = null;

                        // ÁîüÊàê‰∏ã‰∏Ä‰∏™Á≥ñÊûúÔºàÂè™ÊúâÂú®Ê∏∏Êàè‰ªçÂú®ËøõË°åÊó∂Ôºâ
                        setTimeout(() => {
                            if (this.gameStarted) {
                                this.spawnCandy();
                            }
                        }, 500);
                    });
                } else {
                    // ÈîôËØØÊåâÈîÆ - Êâ£ÂàÜ‰ΩÜ‰∏çÊ∏ÖÈô§Á≥ñÊûú
                    this.handleWrongKey(color);
                }
            }

            showScorePopup(earnedScore, reactionTime, cellIndex) {
                const cell = document.querySelector(`[data-index="${cellIndex}"]`);
                const popup = document.createElement('div');
                popup.className = 'score-popup';
                popup.innerHTML = `
                    <div class="score-value positive">+${earnedScore}</div>
                    <div class="reaction-time">${reactionTime}ms</div>
                `;

                // Ê∑ªÂä†Âà∞cell‰∏≠
                cell.appendChild(popup);

                // Âä®ÁîªÊïàÊûú
                setTimeout(() => {
                    popup.style.opacity = '0';
                    popup.style.transform = 'translateY(-30px)';
                }, 100);

                // ÁßªÈô§ÂÖÉÁ¥†
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 1000);
            }

            showPenaltyPopup(penalty, cellIndex) {
                const cell = document.querySelector(`[data-index="${cellIndex}"]`);
                const popup = document.createElement('div');
                popup.className = 'score-popup penalty';
                popup.innerHTML = `
                    <div class="score-value negative">-${penalty}</div>
                    <div class="penalty-text">ÈîôËØØÊåâÈîÆ!</div>
                `;

                // Ê∑ªÂä†Âà∞cell‰∏≠
                cell.appendChild(popup);

                // Âä®ÁîªÊïàÊûú
                setTimeout(() => {
                    popup.style.opacity = '0';
                    popup.style.transform = 'translateY(-30px)';
                }, 100);

                // ÁßªÈô§ÂÖÉÁ¥†
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 1500);
            }

            showGeneralPenaltyPopup(penalty) {
                // Âú®Â±èÂπï‰∏≠Â§ÆÊòæÁ§∫Êâ£ÂàÜ
                const popup = document.createElement('div');
                popup.className = 'score-popup penalty general';
                popup.style.position = 'fixed';
                popup.style.top = '40%';
                popup.style.left = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
                popup.innerHTML = `
                    <div class="score-value negative">-${penalty}</div>
                    <div class="penalty-text">Êó†ÊïàÊåâÈîÆ!</div>
                `;

                document.body.appendChild(popup);

                // Âä®ÁîªÊïàÊûú
                setTimeout(() => {
                    popup.style.opacity = '0';
                    popup.style.transform = 'translate(-50%, -50%) translateY(-30px)';
                }, 100);

                // ÁßªÈô§ÂÖÉÁ¥†
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 1500);
            }

            startGameTimer() {
                this.updateTimer();
                this.gameTimer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimer();

                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                }, 1000);
            }

            updateTimer() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('timeLeft').textContent = timeString;

                // ËÆ°ÁÆóËøõÂ∫¶Êù°ÂÆΩÂ∫¶ÁôæÂàÜÊØî
                const percentage = (this.timeLeft / 300) * 100;
                const timerBar = document.getElementById('timerBar');
                timerBar.style.width = percentage + '%';

                // Ê†πÊçÆÂâ©‰ΩôÊó∂Èó¥ÊîπÂèòÊ†∑Âºè
                if (this.timeLeft <= 30) {
                    timerBar.className = 'timer-bar critical';
                } else if (this.timeLeft <= 60) {
                    timerBar.className = 'timer-bar warning';
                } else {
                    timerBar.className = 'timer-bar';
                }
            }

            endGame() {
                this.gameStarted = false;
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                    this.gameTimer = null;
                }
                if (this.autoClickTimeout) {
                    clearTimeout(this.autoClickTimeout);
                    this.autoClickTimeout = null;
                }

                // ËÆ∞ÂΩïÊ∏∏ÊàèÁªìÊùü‰∫ã‰ª∂
                this.gameData.finalScore = this.score;
                this.gameData.endTime = new Date().toISOString();

                // ËÆ°ÁÆóÊ∏∏ÊàèÊó∂Èïø
                const gameDuration = this.gameStartTime ? Date.now() - this.gameStartTime : 0;

                this.recordGameEvent('game_end', {
                    finalScore: this.score,
                    gameDuration: gameDuration
                });

                // Ê∏ÖÈô§ÂΩìÂâçÁ≥ñÊûú
                this.currentCandy = null;

                // Ê∏ÖÈô§Ê∏∏ÊàèÁΩëÊ†º‰∏≠ÁöÑÊâÄÊúâÁ≥ñÊûú
                document.querySelectorAll('.candy').forEach(candy => {
                    candy.remove();
                });

                // ÈáçÁΩÆÁΩëÊ†ºÁä∂ÊÄÅ
                this.grid.fill(null);

                // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùü‰ø°ÊÅØ
                const countdownEl = document.getElementById('countdown');
                countdownEl.style.display = 'block';
                countdownEl.className = 'countdown'; // ÈáçÁΩÆÊ†∑ÂºèÁ±ª
                countdownEl.textContent = `Ê∏∏ÊàèÁªìÊùüÔºÅ\nÊúÄÁªàÂæóÂàÜ: ${this.score}`;
                countdownEl.style.fontSize = '60px';

                // 3ÁßíÂêéÂõûÂà∞ÂØπËØùÁ≥ªÁªüËøõË°åËØÑ‰ª∑
                setTimeout(() => {
                    countdownEl.style.display = 'none';
                    this.showPostGameDialog();
                }, 3000);
            }

            updateScore() {
                document.getElementById('score').textContent = this.score;
            }

            showPostGameDialog() {
                // ÈöêËóèÊ∏∏ÊàèÁïåÈù¢
                document.getElementById('gameContainer').style.display = 'none';

                // ÊòæÁ§∫Êú∫Âô®‰∫∫‰ªãÁªçÁïåÈù¢Áî®‰∫éÊ∏∏ÊàèÂêéÂØπËØù
                document.getElementById('robotIntroduction').style.display = 'flex';

                // ËÆæÁΩÆÊ∏∏ÊàèÂêéÂØπËØù
                this.setupPostGameDialog();
            }

            setupPostGameDialog() {
                const video = document.getElementById('selectedRobotVideo');
                const robotNameLabel = document.getElementById('robotNameLabel');
                const dialogueText = document.getElementById('dialogueText');
                const speechBubble = document.getElementById('speechBubble');
                const nameInput = document.getElementById('playerNameInput');
                const submitNameBtn = document.getElementById('sendBtn');

                // ÈöêËóèËæìÂÖ•Âå∫Âüü
                const inputSection = document.getElementById('inputSection');
                if (inputSection) {
                    inputSection.style.display = 'none';
                }

                // ËÆæÁΩÆÊú∫Âô®‰∫∫‰ø°ÊÅØ
                if (this.selectedRobot === 'robot1') {
                    video.src = 'image/robot_1.webm';
                    video.className = 'robot1-video';
                    robotNameLabel.textContent = 'Ê≥¢Ê≥¢';
                    robotNameLabel.className = 'robot-name-label robot1';
                    speechBubble.className = 'dialogue-bubble robot1';

                    this.postGameMessages = [
                        "üéâ Â§™Â•Ω‰∫ÜÔºÅÂÆåÊàê‰ªäÂ§©ÁöÑÊ∏∏Êàè‰∫ÜÔºÅ",
                        "Êàë‰ª¨‰∏ÄËµ∑Âêà‰ΩúÂæóÁúüÊ£íÂë¢ÔΩû",
                        `‰Ω†ÁöÑÊúÄÁªàÂæóÂàÜÊòØ ${this.score} ÂàÜÔºÅ`,
                        "Áé∞Âú®ÊàëÊÉ≥Âê¨Âê¨‰Ω†‰ªäÂ§©ÂØπÊàëÁöÑËØÑ‰ª∑ÊÄé‰πàÊ†∑Ôºü",
                        "ËØ∑ÁªôÊàëÊâì‰∏™ÂàÜÂêßÔºå‰ªé1Âà∞10ÂàÜÔºå‰Ω†ËßâÂæóÊàëË°®Áé∞Â¶Ç‰ΩïÔºüüòä"
                    ];
                } else {
                    video.src = 'image/robot_2.webm';
                    video.className = 'robot2-video';
                    robotNameLabel.textContent = 'ÂèØ‰πêÊñπ';
                    robotNameLabel.className = 'robot-name-label robot2';
                    speechBubble.className = 'dialogue-bubble robot2';

                    this.postGameMessages = [
                        "ü§ñ ÂàÜÊûêÂÆåÊàêÔºÅ‰ªäÂ§©ÁöÑÊ∏∏ÊàèÊï∞ÊçÆÂ∑≤ËÆ∞ÂΩïÔºÅ",
                        "Êàë‰ª¨ÁöÑÂêà‰ΩúÊïàÁéáÂæàÈ´òÂë¢ÔºÅ",
                        `ÊúÄÁªàÂæóÂàÜÔºö${this.score} ÂàÜÔºåÊï∞ÊçÆÂ∑≤Â≠òÊ°£ÔºÅ`,
                        "Áé∞Âú®ÈúÄË¶ÅÊî∂ÈõÜÁî®Êà∑ÂèçÈ¶àÊï∞ÊçÆ...",
                        "ËØ∑ÂØπÊàëÁöÑË°®Áé∞ËøõË°åËØÑÂàÜÔºå1-10ÂàÜÔºå‰Ω†ÁöÑËØÑ‰ª∑ÊòØÔºüüîç"
                    ];
                }

                // Êí≠ÊîæËßÜÈ¢ë
                video.play().catch(e => console.log('Ê∏∏ÊàèÂêéÂØπËØùËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•'));

                // ÂºÄÂßãÊ∏∏ÊàèÂêéÂØπËØù
                this.currentPostGameStep = 0;
                this.showNextPostGameMessage();
            }

            async showNextPostGameMessage() {
                const dialogueText = document.getElementById('dialogueText');
                const typingIndicator = document.getElementById('typingIndicator');

                if (this.currentPostGameStep < this.postGameMessages.length) {
                    // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                    dialogueText.style.display = 'none';
                    typingIndicator.classList.add('show');

                    // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥
                    await this.delay(1500);

                    // ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
                    typingIndicator.classList.remove('show');
                    dialogueText.style.display = 'block';

                    // Ê∏ÖÁ©∫ÊñáÊú¨Âπ∂ÊâìÂ≠óÊú∫ÊïàÊûúÊòæÁ§∫Ê∂àÊÅØ
                    dialogueText.textContent = '';
                    await this.typeMessage(dialogueText, this.postGameMessages[this.currentPostGameStep]);

                    this.currentPostGameStep++;

                    // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÔºåÊòæÁ§∫ËØÑÂàÜËæìÂÖ•
                    if (this.currentPostGameStep >= this.postGameMessages.length) {
                        setTimeout(() => {
                            this.showRatingInput();
                        }, 2000);
                    } else {
                        // Á≠âÂæÖÂêéÊòæÁ§∫‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
                        setTimeout(() => {
                            this.showNextPostGameMessage();
                        }, 3000);
                    }
                }
            }

            showRatingInput() {
                const nameInput = document.getElementById('playerNameInput');
                const submitNameBtn = document.getElementById('sendBtn');
                const inputSection = document.getElementById('inputSection');

                // ÊòæÁ§∫ËæìÂÖ•Âå∫Âüü
                if (inputSection) {
                    inputSection.style.display = 'block';
                }

                // ‰øÆÊîπËæìÂÖ•Ê°Ü‰∏∫ËØÑÂàÜËæìÂÖ•
                nameInput.style.display = 'block';
                nameInput.placeholder = 'ËØ∑ËæìÂÖ•1-10ÁöÑÂàÜÊï∞';
                nameInput.type = 'number';
                nameInput.min = '1';
                nameInput.max = '10';
                nameInput.value = '';
                nameInput.disabled = false;

                submitNameBtn.style.display = 'block';
                submitNameBtn.textContent = 'Êèê‰∫§ËØÑÂàÜ';
                submitNameBtn.disabled = false;

                // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÊ∑ªÂä†Êñ∞ÁöÑËØÑÂàÜÊèê‰∫§ÁõëÂê¨Âô®
                submitNameBtn.onclick = () => this.submitRating();
                nameInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        this.submitRating();
                    }
                };
            }

            async submitRating() {
                const nameInput = document.getElementById('playerNameInput');
                const rating = parseInt(nameInput.value);

                if (!rating || rating < 1 || rating > 10) {
                    alert('ËØ∑ËæìÂÖ•1-10‰πãÈó¥ÁöÑÂàÜÊï∞ÔºÅ');
                    return;
                }

                // ËÆ∞ÂΩïÁî®Êà∑ËØÑÂàÜ
                this.gameData.userRating = rating;
                this.recordGameEvent('user_rating', {
                    rating: rating,
                    robotRated: this.selectedRobot
                });

                // ÈöêËóèËæìÂÖ•Âå∫Âüü
                const inputSection = document.getElementById('inputSection');
                if (inputSection) {
                    inputSection.style.display = 'none';
                }

                // ÊòæÁ§∫ÊÑüË∞¢Ê∂àÊÅØ
                const dialogueText = document.getElementById('dialogueText');
                const typingIndicator = document.getElementById('typingIndicator');

                // ÊòæÁ§∫ÊâìÂ≠óÊåáÁ§∫Âô®
                dialogueText.style.display = 'none';
                typingIndicator.classList.add('show');

                await this.delay(1500);

                // ÈöêËóèÊâìÂ≠óÊåáÁ§∫Âô®
                typingIndicator.classList.remove('show');
                dialogueText.style.display = 'block';

                // Ê†πÊçÆËØÑÂàÜÊòæÁ§∫‰∏çÂêåÁöÑÊÑüË∞¢Ê∂àÊÅØ
                let thankMessage;
                if (this.selectedRobot === 'robot1') {
                    if (rating >= 8) {
                        thankMessage = `ÂìáÔºÅ${rating}ÂàÜÔºÅË∞¢Ë∞¢‰Ω†ÁöÑÈ´òÂàÜËØÑ‰ª∑ÔºÅÊàëÂ•ΩÂºÄÂøÉÔΩû ü•∞`;
                    } else if (rating >= 6) {
                        thankMessage = `${rating}ÂàÜÂëÄÔºåË∞¢Ë∞¢‰Ω†ÁöÑËØÑ‰ª∑ÔºÅÊàë‰ºöÁªßÁª≠Âä™ÂäõÁöÑÔºÅüòä`;
                    } else {
                        thankMessage = `${rating}ÂàÜ...Êàë‰ºöÂä™ÂäõÊîπËøõÁöÑÔºÅË∞¢Ë∞¢‰Ω†ÁöÑËØöÂÆûÂèçÈ¶àÔºÅüòÖ`;
                    }
                } else {
                    if (rating >= 8) {
                        thankMessage = `ËØÑÂàÜ${rating}ÂàÜÂ∑≤ËÆ∞ÂΩïÔºÅÊÑüË∞¢È´òË¥®ÈáèÂèçÈ¶àÊï∞ÊçÆÔºÅü§ñ‚ú®`;
                    } else if (rating >= 6) {
                        thankMessage = `ËØÑÂàÜ${rating}ÂàÜÂ∑≤Â≠òÊ°£ÔºÅÂ∞ÜÁî®‰∫éÊÄßËÉΩ‰ºòÂåñÂàÜÊûêÔºÅüîß`;
                    } else {
                        thankMessage = `ËØÑÂàÜ${rating}ÂàÜÂ∑≤ËÆ∞ÂΩïÔºÅÂêØÂä®ÊîπËøõÁ®ãÂ∫è...ÊÑüË∞¢ÂÆùË¥µÊÑèËßÅÔºÅ‚öôÔ∏è`;
                    }
                }

                // Ê∏ÖÁ©∫ÊñáÊú¨Âπ∂ÊâìÂ≠óÊú∫ÊïàÊûúÊòæÁ§∫ÊÑüË∞¢Ê∂àÊÅØ
                dialogueText.textContent = '';
                await this.typeMessage(dialogueText, thankMessage);

                // 3ÁßíÂêéÊòæÁ§∫‰∏ãËΩΩÊåâÈíÆ
                setTimeout(() => {
                    this.showDownloadButton();
                }, 3000);
            }

            highlightKey(key, isCorrect = null) {
                // Ê∏ÖÈô§ÊâÄÊúâÊåâÈîÆÁöÑÈ´ò‰∫ÆÁä∂ÊÄÅ
                document.querySelectorAll('.key-display').forEach(item => {
                    item.classList.remove('pressed', 'correct', 'wrong');
                });

                // Ê∏ÖÈô§ÊâÄÊúâÈîÆÁõòÊåâÈîÆÁöÑÈ´ò‰∫ÆÁä∂ÊÄÅ
                document.querySelectorAll('.keyboard-key').forEach(item => {
                    item.classList.remove('highlight');
                });

                // È´ò‰∫ÆÂΩìÂâçÊåâ‰∏ãÁöÑÈîÆ
                const keyElement = document.querySelector(`[data-key="${key}"]`);
                if (keyElement) {
                    if (isCorrect === true) {
                        keyElement.classList.add('correct');
                    } else if (isCorrect === false) {
                        keyElement.classList.add('wrong');
                    } else {
                        keyElement.classList.add('pressed');
                    }

                    // 0.3ÁßíÂêéÁßªÈô§È´ò‰∫Æ
                    setTimeout(() => {
                        keyElement.classList.remove('pressed', 'correct', 'wrong');
                    }, 300);
                }

                // È´ò‰∫ÆÈîÆÁõò‰∏äÂØπÂ∫îÁöÑÊåâÈîÆ
                const keyboardKey = document.getElementById(`kb-key-${key}`);
                if (keyboardKey) {
                    keyboardKey.classList.add('highlight');

                    // 0.3ÁßíÂêéÁßªÈô§ÈîÆÁõòÊåâÈîÆÈ´ò‰∫Æ
                    setTimeout(() => {
                        keyboardKey.classList.remove('highlight');
                    }, 300);
                }
            }

            playRobotGif() {
                const robotImg = document.getElementById('robotImg');
                if (robotImg) {
                    // ÂàáÊç¢Âà∞GIF
                    robotImg.src = 'image/robot.gif';

                    // 1.5ÁßíÂêéÂàáÊç¢ÂõûÈùôÊÄÅÂõæÁâá
                    setTimeout(() => {
                        robotImg.src = 'image/robot.png';
                    }, 1500);
                }
            }

            playHumanAnimation() {
                const img = document.getElementById('humanImg');
                if (img) {
                    console.log('Êí≠Êîæ‰∫∫Áâ©Âä®Áîª - ÂΩìÂâçsrc:', img.src); // Ë∞ÉËØï‰ø°ÊÅØ

                    // ÂàáÊç¢Âà∞human1.png
                    img.src = 'image/human1.png';
                    console.log('Â∑≤ÂàáÊç¢Âà∞human1.png:', img.src); // Ë∞ÉËØï‰ø°ÊÅØ

                    // Ê£ÄÊü•ÂõæÁâáÂä†ËΩΩ
                    img.onload = () => {
                        console.log('human1.pngÂä†ËΩΩÊàêÂäü');
                    };

                    img.onerror = () => {
                        console.log('human1.pngÂä†ËΩΩÂ§±Ë¥•');
                    };

                    // 0.3ÁßíÂêéÂàáÊç¢ÂõûÈùôÊÄÅÂõæÁâá
                    setTimeout(() => {
                        console.log('ÂàáÊç¢Âõûhuman.png');
                        img.src = 'image/human.png';
                    }, 300);
                }
            }

            bindEvents() {
                // È¶ñÊ¨°Áî®Êà∑‰∫§‰∫íÊó∂ÂêØÁî®Èü≥È¢ë
                const enableAudio = () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    document.removeEventListener('keydown', enableAudio);
                    document.removeEventListener('click', enableAudio);
                };

                document.addEventListener('keydown', enableAudio);
                document.addEventListener('click', enableAudio);

                document.addEventListener('keydown', (e) => {
                    const key = e.key.toLowerCase();
                    console.log('ÊåâÈîÆ:', key); // Ë∞ÉËØï‰ø°ÊÅØ

                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÊåâÈîÆ
                    if (this.keyMap[key]) {
                        // Â¶ÇÊûúÊòØ‰∫∫Áâ©ÊåâÈîÆ(q,w,e)ÔºåÊí≠Êîæ‰∫∫Áâ©Âä®Áîª
                        if (['q', 'w', 'e'].includes(key)) {
                            console.log('Ëß¶Âèë‰∫∫Áâ©Âä®Áîª:', key); // Ë∞ÉËØï‰ø°ÊÅØ
                            this.playHumanAnimation();
                        }

                        if (this.gameStarted) {
                            // Ê£ÄÊü•ÊòØÂê¶ÊåâÂØπ‰∫ÜÈîÆ
                            let isCorrect = false;
                            if (this.currentCandy && this.currentCandy.color === this.keyMap[key]) {
                                // È¢úËâ≤ÂåπÈÖçÔºå‰ΩÜËøòË¶ÅÊ£ÄÊü•ÊòØÂê¶ÊòØËá™Âä®ÁÇπÂáªÁ±ªÂûã
                                if (this.autoColors.includes(this.currentCandy.color)) {
                                    // Ëá™Âä®ÁÇπÂáªÁ±ªÂûãÁöÑÁ≥ñÊûúÔºåÁî®Êà∑ÊåâÈîÆÊòØÈîôËØØÁöÑ
                                    isCorrect = false;
                                } else {
                                    // ÊâãÂä®ÁÇπÂáªÁ±ªÂûãÁöÑÁ≥ñÊûúÔºåÁî®Êà∑ÊåâÈîÆÊòØÊ≠£Á°ÆÁöÑ
                                    isCorrect = true;
                                }
                            }

                            console.log('ÊåâÈîÆË∞ÉËØï:', {
                                key: key,
                                keyColor: this.keyMap[key],
                                currentCandy: this.currentCandy ? this.currentCandy.color : 'none',
                                isAutoColor: this.currentCandy ? this.autoColors.includes(this.currentCandy.color) : false,
                                isCorrect: isCorrect
                            });
                            this.highlightKey(key, isCorrect);
                            this.destroyCandy(this.keyMap[key]);
                        } else {
                            // Ê∏∏ÊàèÊú™ÂºÄÂßãÊó∂Âè™ÊòæÁ§∫ÊåâÈîÆÊïàÊûú
                            this.highlightKey(key);
                        }
                    }
                });
            }
        }

        // ËµÑÊ∫êÂä†ËΩΩÁÆ°ÁêÜ
        class ResourceLoader {
            constructor() {
                this.totalResources = 0;
                this.loadedResources = 0;
                this.loadingBar = document.getElementById('loadingBar');
                this.loadingText = document.getElementById('loadingText');
                this.loadingPercentage = document.getElementById('loadingPercentage');
                this.loadingScreen = document.getElementById('loadingScreen');

                this.resourceList = [
                    'image/background.png',
                    'image/bg1.png',
                    'image/bg2.png',
                    'image/bg3.png',
                    'image/bg4.png',
                    'image/bg5.png',
                    'image/red.png',
                    'image/blue.png',
                    'image/yellow.png',
                    'image/pink.png',
                    'image/light_green.png',
                    'image/deep_green.png',
                    'image/human.gif',
                    'image/human1.png',
                    'image/robot_1.webm',
                    'image/robot_1_1.webm',
                    'image/robot_2.webm',
                    'image/robot_2_1.webm',
                    'image/robot_end1.webm',
                    'SentyWatermelon.ttf'
                ];

                this.totalResources = this.resourceList.length;
            }

            updateProgress() {
                const percentage = Math.round((this.loadedResources / this.totalResources) * 100);
                this.loadingBar.style.width = percentage + '%';
                this.loadingPercentage.textContent = percentage + '%';

                // Êõ¥Êñ∞Á≥ñÊûúÊé®Âä®Âô®‰ΩçÁΩÆ - Âú®ËøõÂ∫¶Êù°ÂÜÖÈÉ®ÁßªÂä®
                const candyPusher = document.getElementById('candyPusher');
                const containerWidth = 384; // loading-containerÂÜÖÈÉ®ÂÆΩÂ∫¶ (400 - 16px padding)
                const candyWidth = 40; // Á≥ñÊûúÂÆΩÂ∫¶
                const maxPosition = containerWidth - candyWidth; // ÊúÄÂ§ß‰ΩçÁΩÆ
                const candyPosition = Math.max(0, (percentage / 100) * maxPosition);
                candyPusher.style.left = candyPosition + 'px';

                if (percentage < 30) {
                    this.loadingText.textContent = 'Ê≠£Âú®Âä†ËΩΩÊ∏∏ÊàèËµÑÊ∫ê...';
                } else if (percentage < 60) {
                    this.loadingText.textContent = 'Ê≠£Âú®Âä†ËΩΩÁ≥ñÊûúÂõæÁâá...';
                } else if (percentage < 90) {
                    this.loadingText.textContent = 'Ê≠£Âú®Âä†ËΩΩËßíËâ≤Âä®Áîª...';
                } else {
                    this.loadingText.textContent = 'Âç≥Â∞ÜËøõÂÖ•Ê∏∏Êàè...';
                }

                if (this.loadedResources >= this.totalResources) {
                    setTimeout(() => {
                        this.hideLoadingScreen();
                    }, 500);
                }
            }

            hideLoadingScreen() {
                this.loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    this.loadingScreen.style.display = 'none';
                    // Âä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫ÂÖ®Â±èÊèêÁ§∫
                    this.showFullscreenPrompt();
                }, 500);
            }

            showFullscreenPrompt() {
                const fullscreenPrompt = document.getElementById('fullscreenPrompt');
                if (fullscreenPrompt) {
                    fullscreenPrompt.style.display = 'flex';
                }
            }

            loadResources() {
                this.resourceList.forEach(src => {
                    if (src.endsWith('.webm')) {
                        // Âä†ËΩΩËßÜÈ¢ë
                        const video = document.createElement('video');
                        video.onloadeddata = () => {
                            this.loadedResources++;
                            this.updateProgress();
                        };
                        video.onerror = () => {
                            this.loadedResources++;
                            this.updateProgress();
                        };
                        video.src = src;
                    } else if (src.endsWith('.ttf')) {
                        // Âä†ËΩΩÂ≠ó‰Ωì
                        const font = new FontFace('SentyWatermelon', `url(${src})`);
                        font.load().then(() => {
                            document.fonts.add(font);
                            this.loadedResources++;
                            this.updateProgress();
                        }).catch(() => {
                            this.loadedResources++;
                            this.updateProgress();
                        });
                    } else {
                        // Âä†ËΩΩÂõæÁâá
                        const img = new Image();
                        img.onload = () => {
                            this.loadedResources++;
                            this.updateProgress();
                        };
                        img.onerror = () => {
                            this.loadedResources++;
                            this.updateProgress();
                        };
                        img.src = src;
                    }
                });
            }
        }

        // ÂÖ®Â±èÂíåÈü≥‰πêÁÆ°ÁêÜ
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñËµÑÊ∫êÂä†ËΩΩÂô®
            const loader = new ResourceLoader();
            loader.loadResources();

            // ÂÖ®Â±èÂíåÈü≥‰πêÁÆ°ÁêÜÔºà‰∏çÁ´ãÂç≥ÊòæÁ§∫ÂÖ®Â±èÊèêÁ§∫Ôºâ
            const fullscreenPrompt = document.getElementById('fullscreenPrompt');
            const enterFullscreenBtn = document.getElementById('enterFullscreenBtn');
            const skipFullscreenBtn = document.getElementById('skipFullscreenBtn');
            const bgMusic = document.getElementById('bgMusic');

            // Êí≠ÊîæÈü≥‰πêÁöÑÂáΩÊï∞
            function startMusic() {
                if (bgMusic) {
                    bgMusic.muted = false;
                    bgMusic.volume = 0.3;
                    bgMusic.play().then(() => {
                        console.log('ËÉåÊôØÈü≥‰πêÂºÄÂßãÊí≠Êîæ');
                    }).catch(e => {
                        console.log('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', e);
                    });
                }
            }

            // ËøõÂÖ•ÂÖ®Â±èÊåâÈíÆ
            enterFullscreenBtn.addEventListener('click', () => {
                // ËØ∑Ê±ÇÂÖ®Â±è
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }

                // ÈöêËóèÊèêÁ§∫Âπ∂Êí≠ÊîæÈü≥‰πê
                fullscreenPrompt.style.display = 'none';
                startMusic();
            });

            // Ë∑≥ËøáÂÖ®Â±èÊåâÈíÆ
            skipFullscreenBtn.addEventListener('click', () => {
                // ÈöêËóèÊèêÁ§∫Âπ∂Êí≠ÊîæÈü≥‰πê
                fullscreenPrompt.style.display = 'none';
                startMusic();
            });
        });

        // ÂêØÂä®Ê∏∏Êàè
        window.addEventListener('load', () => {
            const game = new CandyGame();

            // Ê∑ªÂä†ÂÖ®Â±ÄÊµãËØïÂáΩÊï∞ÔºàÂºÄÂèëÁî®Ôºâ
            window.testIncrementDay = function(userName) {
                return game.incrementUserDay(userName);
            };

            window.testShowUserInfo = function(userName) {
                const user = game.registeredUsers.find(u => u.name === userName);
                if (user) {
                    console.log('Áî®Êà∑‰ø°ÊÅØ:', user);
                    return user;
                } else {
                    console.log('Êú™ÊâæÂà∞Áî®Êà∑:', userName);
                    return null;
                }
            };

            window.testShowAllUsers = function() {
                console.log('ÊâÄÊúâÊ≥®ÂÜåÁî®Êà∑:', game.registeredUsers);
                return game.registeredUsers;
            };

            // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩÂêéÂÜçÊõ¥Êñ∞logo
            setTimeout(() => {
                game.updateExistingLogos();

                // Âº∫Âà∂ËÆæÁΩÆWÈîÆÁ≥ñÊûú‰∏∫ÊµÖÁªøËâ≤
                const wCandy = document.querySelector('.manual-controls .control-group:nth-child(2) .candy-icon');
                if (wCandy) {
                    wCandy.style.backgroundImage = 'url("image/light_green.png")';
                    wCandy.style.backgroundSize = 'contain';
                    wCandy.style.backgroundRepeat = 'no-repeat';
                    wCandy.style.backgroundPosition = 'center';
                    console.log('WÈîÆÁ≥ñÊûúËÉåÊôØÂ∑≤Âº∫Âà∂ËÆæÁΩÆ‰∏∫ÊµÖÁªøËâ≤');
                }
            }, 100);
        });
    </script>

    <!-- ‰ΩúËÄÖ‰ø°ÊÅØ -->
    <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); color: black; padding: 8px 12px; border-radius: 5px; font-size: 12px; z-index: 9999; border: 1px solid #ccc;">
        Made by <a href="https://github.com/xuconghu" target="_blank" style="color: #0066cc; text-decoration: none;">xuconghu</a> (ZJU)
    </div>
</body>
</html>
